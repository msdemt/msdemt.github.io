<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Cert Manager v0.11 官方文档阅读笔记 - MyBlog</title><meta name="Description" content="我的博客"><meta property="og:title" content="Cert Manager v0.11 官方文档阅读笔记" />
<meta property="og:description" content="参考：https://cert-manager.readthedocs.io/en/latest/index.html cert-manager is a native Kubernetes certificate management controller. It can help" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://msdemt.github.io/posts/k8s/cert-manager-v0.11-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" />
<meta property="og:image" content="https://msdemt.github.io/logo.png"/>
<meta property="article:published_time" content="2019-10-18T21:05:45+08:00" />
<meta property="article:modified_time" content="2019-10-18T21:05:45+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://msdemt.github.io/logo.png"/>

<meta name="twitter:title" content="Cert Manager v0.11 官方文档阅读笔记"/>
<meta name="twitter:description" content="参考：https://cert-manager.readthedocs.io/en/latest/index.html cert-manager is a native Kubernetes certificate management controller. It can help"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://msdemt.github.io/posts/k8s/cert-manager-v0.11-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" /><link rel="prev" href="https://msdemt.github.io/posts/k8s/metallb-v0.8.1-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" /><link rel="next" href="https://msdemt.github.io/posts/k8s/nfs-storageclsss-20191019-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Cert Manager v0.11 官方文档阅读笔记",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/msdemt.github.io\/posts\/k8s\/cert-manager-v0.11-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0\/"
        },"image": ["https:\/\/msdemt.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","wordcount":  21806 ,
        "url": "https:\/\/msdemt.github.io\/posts\/k8s\/cert-manager-v0.11-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0\/","datePublished": "2019-10-18T21:05:45+08:00","dateModified": "2019-10-18T21:05:45+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/msdemt.github.io\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "hekai"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="MyBlog"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>MyBlog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/categories/documentation/"> 文档 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/dillonzq/LoveIt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="MyBlog"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>MyBlog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/categories/documentation/" title="">文档</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/dillonzq/LoveIt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Cert Manager v0.11 官方文档阅读笔记</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>hekai</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2019-10-18">2019-10-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 21806 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 44 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#get-started">Get started</a>
      <ul>
        <li><a href="#install-cert-manager">Install cert-manager</a>
          <ul>
            <li><a href="#installing-on-kubernetes">Installing on Kubernetes</a>
              <ul>
                <li><a href="#installing-with-regular-manifests">Installing with regular manifests</a></li>
              </ul>
            </li>
            <li><a href="#installing-with-helm">Installing with Helm</a>
              <ul>
                <li><a href="#pre-requisites">Pre-requisites</a></li>
                <li><a href="#foreword">Foreword</a></li>
                <li><a href="#steps">Steps</a></li>
              </ul>
            </li>
            <li><a href="#verifying-the-installation">Verifying the installation</a></li>
            <li><a href="#configuring-your-first-issuer">Configuring your first Issuer</a></li>
            <li><a href="#alternative-installation-methods">Alternative installation methods</a>
              <ul>
                <li><a href="#helmfile">Helmfile</a></li>
                <li><a href="#kubeprod">kubeprod</a></li>
              </ul>
            </li>
            <li><a href="#debugging-installation-issues">Debugging installation issues</a></li>
            <li><a href="#installing-on-openshift">Installing on OpenShift</a>
              <ul>
                <li><a href="#login-to-your-openshift-cluster">Login to your OpenShift cluster</a></li>
                <li><a href="#installing-with-regular-manifests-1">Installing with regular manifests</a></li>
                <li><a href="#configuring-your-first-issuer-1">Configuring your first Issuer</a>
                  <ul>
                    <li><a href="#debugging-installation-issues-1">Debugging installation issues</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#webhook-component">Webhook component</a>
          <ul>
            <li><a href="#how-it-works">How it works</a>
              <ul>
                <li><a href="#cainjector">cainjector</a></li>
                <li><a href="#known-issues">Known issues</a></li>
                <li><a href="#running-on-private-gke-clusters">Running on private GKE clusters</a></li>
              </ul>
            </li>
            <li><a href="#disable-the-webhook-component">Disable the webhook component</a>
              <ul>
                <li><a href="#with-helm">With Helm</a></li>
                <li><a href="#with-static-manifests">With static manifests</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#tutorials">Tutorials</a>
      <ul>
        <li><a href="#acme-issuer-tutorials">ACME Issuer Tutorials</a>
          <ul>
            <li><a href="#quick-start-using-cert-manager-with-nginx-ingress">Quick-Start using Cert-Manager with NGINX Ingress</a>
              <ul>
                <li><a href="#step-0---install-helm-client">Step 0 - Install Helm Client</a></li>
                <li><a href="#step-1---installer-tiller">Step 1 - Installer Tiller</a></li>
                <li><a href="#step-2---deploy-the-nginx-ingress-controller">Step 2 - Deploy the NGINX Ingress Controller</a></li>
                <li><a href="#step-3---assign-a-dns-name">Step 3 - Assign a DNS name</a></li>
                <li><a href="#step-4---deploy-an-example-service">Step 4 - Deploy an Example Service</a></li>
                <li><a href="#step-5---deploy-cert-manager">Step 5 - Deploy Cert Manager</a></li>
                <li><a href="#step-6---configure-lets-encrypt-issuer">Step 6 - Configure Let&rsquo;s Encrypt Issuer</a></li>
                <li><a href="#step-7---deploy-a-tls-ingress-resource">Step 7 - Deploy a TLS Ingress Resource</a></li>
              </ul>
            </li>
            <li><a href="#issuing-an-acme-certificate-using-dns-validation">Issuing an ACME certificate using DNS validation</a></li>
            <li><a href="#issuing-an-acme-certificate-using-http-validation">Issuing an ACME certificate using HTTP validation</a></li>
            <li><a href="#migrating-from-kube-lego">Migrating from kube-lego</a>
              <ul>
                <li><a href="#1-scale-down-kube-lego">1. Scale down kube-lego</a></li>
                <li><a href="#2-deploy-cert-manager">2. Deploy cert-manager</a></li>
                <li><a href="#3-obtaining-your-acme-account-private-key">3. Obtaining your ACME account private key</a></li>
                <li><a href="#4-creating-an-acme-clusterissuer-using-your-old-acme-account">4. Creating an ACME ClusterIssuer using your old ACME account</a></li>
                <li><a href="#5-configuring-ingress-shim-to-use-our-new-clusterissuer-by-default">5. Configuring ingress-shim to use our new ClusterIssuer by default</a></li>
                <li><a href="#6-verify-each-ingress-now-has-a-corresponding-certificate">6. Verify each ingress now has a corresponding Certificate</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#securing-ingresses-with-venafi">Securing Ingresses with Venafi</a>
          <ul>
            <li><a href="#prerequisites">Prerequisites</a></li>
            <li><a href="#create-an-eks-cluster">Create an EKS cluster</a></li>
            <li><a href="#installing-cert-manager">Installing cert-manager</a></li>
            <li><a href="#installing-ingress-nginx">Installing ingress-nginx</a></li>
            <li><a href="#configure-your-dns-records">Configure your DNS records</a></li>
            <li><a href="#deploying-a-demo-application">Deploying a demo application</a></li>
            <li><a href="#creating-a-venafi-issuer-resource">Creating a Venafi Issuer resource</a>
              <ul>
                <li><a href="#venafi-tpp">Venafi TPP</a></li>
                <li><a href="#venafi-cloud">Venafi Cloud</a></li>
              </ul>
            </li>
            <li><a href="#request-a-certificate">Request a Certificate</a></li>
          </ul>
        </li>
        <li><a href="#exposing-and-securing-your-application">Exposing and securing your application</a></li>
      </ul>
    </li>
    <li><a href="#tasks">Tasks</a>
      <ul>
        <li><a href="#setting-up-issuers">Setting up Issuers</a>
          <ul>
            <li><a href="#supported-issuer-types">Supported issuer types</a></li>
            <li><a href="#additional-information">Additional information</a>
              <ul>
                <li><a href="#difference-between-issuers-and-clusterissuers">Difference between Issuers and ClusterIssuers</a></li>
              </ul>
            </li>
            <li><a href="#setting-up-acme-issuers">Setting up ACME Issuers</a>
              <ul>
                <li><a href="#creating-a-basic-acme-issuer">Creating a basic ACME Issuer</a></li>
                <li><a href="#adding-multiple-solver-types">Adding multiple solver types</a>
                  <ul>
                    <li><a href="#using-multiple-solvers-for-a-single-certificate">Using multiple solvers for a single certificate</a></li>
                  </ul>
                </li>
                <li><a href="#configuring-http01-ingress-provider">Configuring HTTP01 Ingress Provider</a>
                  <ul>
                    <li><a href="#how-http01-validations-work">How HTTP01 validations work</a></li>
                    <li><a href="#options">Options</a></li>
                  </ul>
                </li>
                <li><a href="#configuring-dns01-challenge-providers">Configuring DNS01 Challenge Providers</a>
                  <ul>
                    <li><a href="#setting-nameservers-for-dns01-self-check">Setting nameservers for DNS01 self check</a></li>
                    <li><a href="#delegated-domains-for-dns01">Delegated Domains for DNS01</a></li>
                    <li><a href="#supported-dns01-providers">Supported DNS01 providers</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#setting-up-ca-issuers">Setting up CA Issuers</a>
              <ul>
                <li><a href="#1-optional-generate-a-signing-key-pair">1. (Optional) Generate a signing key pair</a></li>
                <li><a href="#2-save-the-signing-key-pair-as-a-secret">2. Save the signing key pair as a Secret</a></li>
                <li><a href="#3-creating-an-issuer-referencing-the-secret">3. Creating an Issuer referencing the Secret</a></li>
                <li><a href="#4-obtain-a-signed-certificate">4. Obtain a signed Certificate</a></li>
              </ul>
            </li>
            <li><a href="#setting-up-self-signing-issuers">Setting up self signing Issuers</a></li>
            <li><a href="#setting-up-vault-issuers">Setting up Vault Issuers</a>
              <ul>
                <li><a href="#installing-vault">Installing Vault</a></li>
                <li><a href="#vault-pki-backend">Vault PKI Backend</a>
                  <ul>
                    <li><a href="#vault-authentication-with-a-approle">Vault Authentication with a AppRole</a></li>
                    <li><a href="#vault-authentication-with-a-token">Vault Authentication with a Token</a></li>
                    <li><a href="#vault-authentication-with-kubernetes-service-accounts">Vault Authentication with Kubernetes Service Accounts</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#setting-up-venafi-issuers">Setting up Venafi Issuers</a>
              <ul>
                <li><a href="#creating-an-issuer-resource">Creating an Issuer resource</a>
                  <ul>
                    <li><a href="#creating-a-venafi-cloud-issuer">Creating a Venafi Cloud Issuer</a></li>
                  </ul>
                </li>
                <li><a href="#creating-a-venafi-trust-protection-platform-issuer">#Creating a Venafi Trust Protection Platform Issuer</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#issuing-certificates">Issuing Certificates</a>
          <ul>
            <li><a href="#creating-certificate-resources">Creating Certificate resources</a></li>
            <li><a href="#temporary-certificates-whilst-issuing">Temporary certificates whilst issuing</a></li>
            <li><a href="#automatically-creating-certificates-for-ingress-resources">Automatically creating Certificates for Ingress resources</a>
              <ul>
                <li><a href="#how-it-works-1">How it works</a></li>
                <li><a href="#configuration">Configuration</a></li>
                <li><a href="#supported-annotations">Supported annotations</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#backing-up-and-restoring">Backing up and restoring</a>
          <ul>
            <li><a href="#backing-up">Backing up</a></li>
          </ul>
        </li>
        <li><a href="#uninstalling-cert-manager">Uninstalling cert-manager</a>
          <ul>
            <li><a href="#uninstalling-on-kubernetes">Uninstalling on Kubernetes</a>
              <ul>
                <li><a href="#uninstalling-with-regular-manifests">Uninstalling with regular manifests</a></li>
                <li><a href="#uninstalling-with-helm">Uninstalling with Helm</a></li>
                <li><a href="#namespace-stuck-in-terminating-state">Namespace Stuck in Terminating State</a></li>
              </ul>
            </li>
            <li><a href="#uninstalling-on-openshift">Uninstalling on OpenShift</a>
              <ul>
                <li><a href="#login-to-your-openshift-cluster-1">Login to your OpenShift cluster</a></li>
                <li><a href="#uninstalling-with-regular-manifests-1">Uninstalling with regular manifests</a></li>
                <li><a href="#namespace-stuck-in-terminating-state-1">Namespace Stuck in Terminating State</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#upgrading-cert-manager">Upgrading cert-manager</a>
          <ul>
            <li><a href="#upgrading-with-helm">Upgrading with Helm</a></li>
            <li><a href="#upgrading-using-static-manifests">Upgrading using static manifests</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#reference-documentation">Reference documentation</a>
      <ul>
        <li><a href="#certificates">Certificates</a>
          <ul>
            <li><a href="#certificate-duration-and-renewal-window">Certificate Duration and Renewal Window</a></li>
            <li><a href="#example-usage">Example Usage</a></li>
            <li><a href="#certificate-key-encoding">Certificate Key Encoding</a>
              <ul>
                <li><a href="#example-usage-1">Example Usage</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#certificaterequests">CertificateRequests</a>
          <ul>
            <li><a href="#conditions">Conditions</a></li>
          </ul>
        </li>
        <li><a href="#orders">Orders</a>
          <ul>
            <li><a href="#debugging-order-resources">Debugging Order resources</a></li>
          </ul>
        </li>
        <li><a href="#challenges">Challenges</a>
          <ul>
            <li><a href="#challenge-lifecycle">Challenge lifecycle</a></li>
            <li><a href="#challenge-scheduling">Challenge scheduling</a></li>
            <li><a href="#debugging-challenge-resources">Debugging Challenge resources</a></li>
          </ul>
        </li>
        <li><a href="#issuers">Issuers</a>
          <ul>
            <li><a href="#namespacing">Namespacing</a></li>
            <li><a href="#ambient-credentials">Ambient Credentials</a>
              <ul>
                <li><a href="#example-usage-2">Example Usage</a></li>
                <li><a href="#when-are-ambient-credentials-used">When are Ambient Credentials used</a></li>
              </ul>
            </li>
            <li><a href="#supported-issuer-types-1">Supported Issuer types</a></li>
          </ul>
        </li>
        <li><a href="#clusterissuers">ClusterIssuers</a></li>
        <li><a href="#cainjector-controller">cainjector controller</a></li>
        <li><a href="#api-documentation">API documentation</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><blockquote>
<p>参考：<a href="https://cert-manager.readthedocs.io/en/latest/index.html">https://cert-manager.readthedocs.io/en/latest/index.html</a></p>
</blockquote>
<p>cert-manager is a native <a href="https://kubernetes.io" target="_blank" rel="noopener noreffer">Kubernetes</a> certificate management controller. It can help with issuing certificates from a variety of sources, such as <a href="https://letsencrypt.org" target="_blank" rel="noopener noreffer">Let&rsquo;s Encrypt</a>, <a href="https://www.vaultproject.io" target="_blank" rel="noopener noreffer">HashiCorp Vault</a>, <a href="https://www.venafi.com/" target="_blank" rel="noopener noreffer">Venafi</a>, a simple signing keypair, or self signed.</p>
<p>It will ensure certificates are valid and up to date, and attempt to renew certificates at a configured time before expiry.</p>
<p>It is loosely based upon the work of <a href="https://github.com/jetstack/kube-lego" target="_blank" rel="noopener noreffer">kube-lego</a> and has borrowed some wisdom from other similar projects e.g. <a href="https://github.com/PalmStoneGames/kube-cert-manager" target="_blank" rel="noopener noreffer">kube-cert-manager</a>.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/cert-manager-high-level-overview-20191018.svg"
        data-srcset="/images/cert-manager-high-level-overview-20191018.svg, /images/cert-manager-high-level-overview-20191018.svg 1.5x, /images/cert-manager-high-level-overview-20191018.svg 2x"
        data-sizes="auto"
        alt="/images/cert-manager-high-level-overview-20191018.svg"
        title="image" /></p>
<p>This is the full technical documentation(技术文档) for the project, and should be used as
a source of references when seeking help with the project.</p>
<h2 id="get-started">Get started</h2>
<p>The guides in this section will explain how to install, set up, and uninstall cert-manager.</p>
<h3 id="install-cert-manager">Install cert-manager</h3>
<p>cert-manager supports running on <a href="https://kubernetes.io/" target="_blank" rel="noopener noreffer">Kubernetes</a> and <a href="https://www.openshift.com/" target="_blank" rel="noopener noreffer">OpenShift</a>. The installation mechanism(机制) between the two platforms is similar, although there are a number of extra notes to be aware of per-platform.</p>
<h4 id="installing-on-kubernetes">Installing on Kubernetes</h4>
<p>cert-manager runs within your Kubernetes cluster as a series of deployment resources. It utilises(利用) <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank" rel="noopener noreffer">CustomResourceDefinitions</a> to configure Certificate Authorities and request certificates.</p>
<p>It is deployed using regular YAML manifests, like any other applications on Kubernetes.</p>
<p>Once cert-manager has been deployed, you must configure Issuer or ClusterIssuer resources which represent certificate authorities.</p>
<p>More information on configuring different Issuer types can be found in the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/index.html" target="_blank" rel="noopener noreffer">respective setup guides</a>.</p>
<blockquote>
<p><strong>Note</strong>:<br>
From cert-manager v0.11.0 onwards, the minimum supported version of Kubernetes is v1.11.0. Users still running Kubernetes v1.10 or below should upgrade to a supported version before installing cert-manager.<br>
<strong>warning</strong>:<br>
You should not install multiple instances of cert-manager on a single cluster. This will lead to undefined behaviour and you may be banned from providers such as Let&rsquo;s Encrypt.</p>
</blockquote>
<h5 id="installing-with-regular-manifests">Installing with regular manifests</h5>
<p>In order to install cert-manager, we must first create a namespace to run it within. This guide will install cert-manager into the <code>cert-manager</code> namespace. It is possible to run cert-manager in a different namespace, although you will need to make modifications to the deployment manifests.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Create a namespace to run cert-manager in</span>
kubectl create namespace cert-manager
</code></pre></td></tr></table>
</div>
</div><p>As part of the installation, cert-manager also deploys a webhook deployment as an <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/setup-extension-api-server" target="_blank" rel="noopener noreffer">APIService</a>. This can cause issues when uninstalling cert-manager if the API service still exists but the webhook is no longer running as the API server is unable to reach the validating webhook. Ensure to follow the documentation when <a href="https://cert-manager.readthedocs.io/en/latest/tasks/uninstall/index.html" target="_blank" rel="noopener noreffer">uninstalling cert-manager</a>.</p>
<p>The webhook enables cert-manager to implement validation(验证) and mutating(更改) webhooks on cert-manager resources. A <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" target="_blank" rel="noopener noreffer">ValidatingWebhookConfiguration</a> resource is deployed to validate cert-manager resources we will create after installation. No mutating webhooks are currently implemented.</p>
<p>You can read more about the webhook on the <a href="https://cert-manager.readthedocs.io/en/latest/getting-started/webhook.html" target="_blank" rel="noopener noreffer">webhook document</a>.</p>
<p>We can now go ahead and install cert-manager. All resources (the CustomResourceDefinitions, cert-manager, and the webhook component) are included in a single YAML manifest file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">   <span class="c1"># Install the CustomResourceDefinitions and cert-manager itself</span>
   kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v0.11.0/cert-manager.yaml
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Note</strong>:
If you are running Kubernetes v1.15 or below, you will need to add the <code>--validate=false</code> flag to your <code>kubectl apply</code> command above else you will receive a validation error relating to the <code>x-kubernetes-preserve-unknown-fields</code> field in our <code>CustomResourceDefinition</code> resources. This is a benign error and occurs due to the way <code>kubectl</code> performs resource validation.<br>
<strong>Note</strong>:
When running on GKE (Google Kubernetes Engine), you may encounter a permission denied' error when creating some of these resources. This is a nuance(细微差别) of the way GKE handles RBAC and IAM permissions, and as such you should &lsquo;elevate&rsquo;(提升) your own privileges to that of a &lsquo;cluster-admin&rsquo; <strong>before</strong> running the above command. If you have already run the above command, you should run them again after elevating your permissions::</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create clusterrolebinding cluster-admin-binding <span class="se">\
</span><span class="se"></span>    --clusterrole<span class="o">=</span>cluster-admin <span class="se">\
</span><span class="se"></span>    --user<span class="o">=</span><span class="k">$(</span>gcloud config get-value core/account<span class="k">)</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="installing-with-helm">Installing with Helm</h4>
<p>As an alternative to the YAML manifests referenced above, we also provide an official Helm chart for installing cert-manager.</p>
<h5 id="pre-requisites">Pre-requisites</h5>
<ul>
<li><a href="https://helm.sh/" target="_blank" rel="noopener noreffer">Helm</a> and Tiller installed (or alternatively, use <a href="https://rimusz.net/tillerless-helm/" target="_blank" rel="noopener noreffer">Tillerless Helm v2</a>)</li>
<li><a href="https://github.com/helm/helm/blob/240e539cec44e2b746b3541529d41f4ba01e77df/docs/rbac.md#Example-Service-account-with-cluster-admin-role" target="_blank" rel="noopener noreffer">cluster-admin privileges bound to the Tiller pod</a></li>
</ul>
<h5 id="foreword">Foreword</h5>
<p>Before deploying cert-manager with Helm, you must ensure <a href="https://github.com/helm/helm" target="_blank" rel="noopener noreffer">Tiller</a> is up and running in your cluster. Tiller is the server side component to Helm.</p>
<p>Your cluster administrator may have already setup and configured Helm for you, in which case you can skip this step.</p>
<p>Full documentation on installing Helm can be found in the <a href="https://github.com/kubernetes/helm/blob/master/docs/install.md" target="_blank" rel="noopener noreffer">Installing helm docs</a>.</p>
<p>If your cluster has RBAC (Role Based Access Control) enabled (default in GKE v1.7+), you will need to take special care when deploying Tiller, to ensure Tiller has permission to create resources as a cluster administrator. More information on deploying Helm with RBAC can be found in the <a href="https://github.com/helm/helm/blob/master/docs/rbac.md" target="_blank" rel="noopener noreffer">Helm RBAC docs</a>.</p>
<h5 id="steps">Steps</h5>
<p>In order to install the Helm chart, you must run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Install the CustomResourceDefinition resources separately</span>
kubectl apply --validate<span class="o">=</span><span class="nb">false</span> -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/deploy/manifests/00-crds.yaml

<span class="c1"># Create the namespace for cert-manager</span>
kubectl create namespace cert-manager

<span class="c1"># Add the Jetstack Helm repository</span>
helm repo add jetstack https://charts.jetstack.io

<span class="c1"># Update your local Helm chart repository cache</span>
helm repo update

<span class="c1"># Install the cert-manager Helm chart</span>
helm install <span class="se">\
</span><span class="se"></span>    --name cert-manager <span class="se">\
</span><span class="se"></span>    --namespace cert-manager <span class="se">\
</span><span class="se"></span>    --version v0.11.0 <span class="se">\
</span><span class="se"></span>    jetstack/cert-manager
</code></pre></td></tr></table>
</div>
</div><p>The default cert-manager configuration is good for the majority of users, but a full list of the available options can be found in the <a href="https://github.com/jetstack/cert-manager/blob/release-0.11/deploy/charts/cert-manager/README.md" target="_blank" rel="noopener noreffer">Helm chart README</a>.</p>
<h4 id="verifying-the-installation">Verifying the installation</h4>
<p>Once you&rsquo;ve installed cert-manager, you can verify it is deployed correctly by checking the <code>cert-manager</code> namespace for running pods:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get pods --namespace cert-manager

NAME                                       READY   STATUS    RESTARTS   AGE
cert-manager-5c6866597-zw7kh               1/1     Running   <span class="m">0</span>          2m
cert-manager-cainjector-577f6d9fd7-tr77l   1/1     Running   <span class="m">0</span>          2m
cert-manager-webhook-787858fcdb-nlzsq      1/1     Running   <span class="m">0</span>          2m
</code></pre></td></tr></table>
</div>
</div><p>You should see the <code>cert-manager</code>, <code>cert-manager-cainjector</code> and <code>cert-manager-webhook</code> pod in a Running state. It may take a minute or so for the TLS assets required for the webhook to function to be provisioned. This may cause the webhook to take a while longer to start for the first time than other pods. If you experience problems, please check the <a href="" rel="">troubleshooting guide</a>.</p>
<p>The following steps will confirm that cert-manager is set up correctly and able to issue basic certificate types:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Create a ClusterIssuer to test the webhook works okay</span>
cat <span class="s">&lt;&lt;EOF &gt; test-resources.yaml
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Namespace
</span><span class="s">metadata:
</span><span class="s">    name: cert-manager-test
</span><span class="s">---
</span><span class="s">apiVersion: cert-manager.io/v1alpha2
</span><span class="s">kind: Issuer
</span><span class="s">metadata:
</span><span class="s">    name: test-selfsigned
</span><span class="s">    namespace: cert-manager-test
</span><span class="s">spec:
</span><span class="s">    selfSigned: {}
</span><span class="s">---
</span><span class="s">apiVersion: cert-manager.io/v1alpha2
</span><span class="s">kind: Certificate
</span><span class="s">metadata:
</span><span class="s">    name: selfsigned-cert
</span><span class="s">    namespace: cert-manager-test
</span><span class="s">spec:
</span><span class="s">    commonName: example.com
</span><span class="s">    secretName: selfsigned-cert-tls
</span><span class="s">    issuerRef:
</span><span class="s">    name: test-selfsigned
</span><span class="s">EOF</span>

<span class="c1"># Create the test resources</span>
kubectl apply -f test-resources.yaml

<span class="c1"># Check the status of the newly created certificate</span>
<span class="c1"># You may need to wait a few seconds before cert-manager processes the</span>
<span class="c1"># certificate request</span>
kubectl describe certificate -n cert-manager-test
...
Spec:
    Common Name:  example.com
    Issuer Ref:
    Name:       test-selfsigned
    Secret Name:  selfsigned-cert-tls
Status:
    Conditions:
    Last Transition Time:  2019-01-29T17:34:30Z
    Message:               Certificate is up to date and has not expired
    Reason:                Ready
    Status:                True
    Type:                  Ready
    Not After:               2019-04-29T17:34:29Z
Events:
    Type    Reason      Age   From          Message
    ----    ------      ----  ----          -------
    Normal  CertIssued  4s    cert-manager  Certificate issued successfully

<span class="c1"># Clean up the test resources</span>
kubectl delete -f test-resources.yaml
</code></pre></td></tr></table>
</div>
</div><p>If all the above steps have completed without error, you are good to go!</p>
<p>If you experience problems, please check the troubleshooting guide.</p>
<h4 id="configuring-your-first-issuer">Configuring your first Issuer</h4>
<p>Before you can begin issuing certificates, you must configure at least one Issuer or ClusterIssuer resource in your cluster.</p>
<p>You should read the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/index.html" target="_blank" rel="noopener noreffer">Setting up Issuers</a> guide to learn how to configure cert-manager to issue certificates from one of the supported backends.</p>
<h4 id="alternative-installation-methods">Alternative installation methods</h4>
<h5 id="helmfile">Helmfile</h5>
<p>Helmfile is a declarative spec for deploying helm charts.</p>
<p>&lsquo;cert-manager-installer&rsquo;: <a href="https://github.com/zakkg3/cert-manager-installer">https://github.com/zakkg3/cert-manager-installer</a></p>
<p>It&rsquo;s an easy and automated way to install cert-manager.</p>
<blockquote>
<p><strong>Note</strong>: This is an external link and it&rsquo;s not officially maintained by cert-manager
but by the community.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">git clone git@github.com:zakkg3/cert-manager-installer.git
<span class="nb">cd</span> cert-manager-installer
helmfile sync
</code></pre></td></tr></table>
</div>
</div><h5 id="kubeprod">kubeprod</h5>
<p><a href="https://github.com/bitnami/kube-prod-runtime/" target="_blank" rel="noopener noreffer">Bitnami Kubernetes Production Runtime</a> (BKPR, <code>kubeprod</code>) is a curated collection of the services you would need to deploy on top of your Kubernetes cluster to enable logging, monitoring, certificate management, automatic discovery of Kubernetes resources via public DNS servers and other common infrastructure needs.</p>
<p>It depends on <code>cert-manager</code> for certificate management, and it is <a href="https://github.com/bitnami/kube-prod-runtime/blob/master/Jenkinsfile" target="_blank" rel="noopener noreffer">regularly tested</a> so the components are known to work together for GKE and AKS clusters (EKS to be added soon). For its ingress stack it creates a DNS entry in the configured DNS zone and requests a TLS certificate from the <code>Let's Encrypt</code> staging server.</p>
<p>BKPR can be deployed using the <code>kubeprod install</code> command, which will deploy <code>cert-manager</code> as part of it. Details available in the <a href="https://github.com/bitnami/kube-prod-runtime/blob/master/docs/install.md" target="_blank" rel="noopener noreffer">BKPR installation guide</a>.</p>
<h4 id="debugging-installation-issues">Debugging installation issues</h4>
<p>If you have any issues with your installation, please refer to the troubleshooting guide.</p>
<h4 id="installing-on-openshift">Installing on OpenShift</h4>
<p>cert-manager supports running on OpenShift in a similar manner to Running on <a href="https://cert-manager.readthedocs.io/en/latest/getting-started/install/kubernetes.html" target="_blank" rel="noopener noreffer">Kubernetes</a>.</p>
<p>It runs within your OpenShift cluster as a series of deployment resources.</p>
<p>It utilises(利用) <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank" rel="noopener noreffer">CustomResourceDefinitions</a> to configure Certificate Authorities and request certificates.</p>
<p>It is deployed using regular YAML manifests, like any other application on OpenShift.</p>
<p>Once <code>cert-manager</code> has been deployed, you must configure <code>Issuer</code> or <code>ClusterIssuer</code> resources which represent certificate authorities. More information on configuring different Issuer types can be found in the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/index.html" target="_blank" rel="noopener noreffer">respective setup guides</a>.</p>
<blockquote>
<p><strong>warning</strong>
You should not install multiple instances of cert-manager on a single cluster. This will lead to undefined behaviour and you may be banned from providers such as <code>Let's Encrypt</code>.</p>
</blockquote>
<h5 id="login-to-your-openshift-cluster">Login to your OpenShift cluster</h5>
<p>Before you can install <code>cert-manager</code>, you must first ensure your local machine is configured to talk to your OpenShift cluster using the <code>oc</code> tool.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Login to the OpenShift cluster as the system:admin user</span>
oc login -u system:admin
</code></pre></td></tr></table>
</div>
</div><h5 id="installing-with-regular-manifests-1">Installing with regular manifests</h5>
<p>In order to install <code>cert-manager</code>, we must first create a namespace to run it within. This guide will install cert-manager into the <code>cert-manager</code> namespace. It is possible to run <code>cert-manager</code> in a different namespace, although you will need to make modifications to the deployment manifests.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Create a namespace to run cert-manager in</span>
oc create namespace cert-manager
</code></pre></td></tr></table>
</div>
</div><p>As part of the installation, <code>cert-manager</code> also deploys a webhook deployment as an <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/setup-extension-api-server" target="_blank" rel="noopener noreffer">APIService</a>. This can cause issues when uninstalling <code>cert-manager</code> if the
API service still exists but the webhook is no longer running as the API server
is unable to reach the validating webhook. Ensure to follow the documentation
when <a href="https://cert-manager.readthedocs.io/en/latest/tasks/uninstall/index.html" target="_blank" rel="noopener noreffer">uninstalling cert-manager</a>.</p>
<p>The webhook enables <code>cert-manager</code> to implement validation and mutating webhooks on cert-manager resources. A <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" target="_blank" rel="noopener noreffer">ValidatingWebhookConfiguration</a> resource is deployed to validate <code>cert-manager</code> resources we will create after installation. No mutating webhooks are currently implemented.</p>
<p>You can read more about the webhook on the <a href="https://cert-manager.readthedocs.io/en/latest/getting-started/webhook.html" target="_blank" rel="noopener noreffer">webhook document</a>.</p>
<p>We can now go ahead and install cert-manager. All resources (the CustomResourceDefinitions, cert-manager, and the webhook component) are included in a single YAML manifest file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Install the CustomResourceDefinitions and cert-manager itself</span>
oc apply --validate<span class="o">=</span><span class="nb">false</span> -f https://github.com/jetstack/cert-manager/releases/download/v0.11.0/cert-manager-openshift.yaml
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Note</strong>:
The <code>--validate=false</code> flag is added to the <code>oc apply</code> command above else you will receive a validation error relating to the <code>caBundle</code> field of the <code>ValidatingWebhookConfiguration</code> resource.</p>
</blockquote>
<h5 id="configuring-your-first-issuer-1">Configuring your first Issuer</h5>
<p>Before you can begin issuing certificates, you must configure at least one
Issuer or ClusterIssuer resource in your cluster.</p>
<p>You should read the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/index.html" target="_blank" rel="noopener noreffer">Setting up Issuers</a> guide to learn how to configure <code>cert-manager</code> to issue certificates from one of the supported backends.</p>
<h6 id="debugging-installation-issues-1">Debugging installation issues</h6>
<p>If you have any issues with your installation, please refer to the troubleshooting guide.</p>
<h3 id="webhook-component">Webhook component</h3>
<p>In order to provide advanced resource validation, cert-manager includes a <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" target="_blank" rel="noopener noreffer">ValidatingWebhookConfiguration</a> resource which is deployed into the cluster.</p>
<p>This allows cert-manager to validate that cert-manager API resources that are submitted to the apiserver are syntactically valid, and catch issues with your resources early on.</p>
<p>If you disable the webhook component, <code>cert-manager</code> will still perform the same resource validation however it will not reject <code>'create'</code> events when the resources are submitted to the apiserver if they are invalid. This means it may be possible for a user to submit a resource that renders(使) the controller inoperable(无法操作).</p>
<p>For this reason, it is strongly advised to keep the webhook <strong>enabled</strong>.</p>
<blockquote>
<p><strong>Note</strong>:
This feature requires Kubernetes v1.9 or greater.</p>
</blockquote>
<h4 id="how-it-works">How it works</h4>
<p>This sections walks through how the resource validation webhook is configured and explains the process required for it to provision.</p>
<p>The webhook is a <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" target="_blank" rel="noopener noreffer">ValidatingWebhookConfiguration</a> resource combined with an extra pod that is deployed alongside the <code>cert-manager-controller</code>.</p>
<p>The ValidatingWebhookConfiguration instructs the Kubernetes apiserver to POST the contents of any Create or Update operations performed(执行的操作) on cert-manager resource types in order to validate that they are setting valid configurations.</p>
<p>This allows us to ensure mis-configurations are caught early on and communicated to you.</p>
<p>In order for this to work, the webhook requires a <code>TLS certificate</code> that the apiserver is configured to trust. This is created by the webhook itself and is implemented by the following two Secrets:</p>
<ul>
<li><code>secret/cert-manager-webhook-ca</code> - A self-signed root CA certificate which is used to sign certificates for the webhook pod.</li>
<li><code>secret/cert-manager-webhook-tls</code> - A TLS certificate issued by the root CA above, served by the webhook.</li>
</ul>
<p>The webhook&rsquo;s <code>'webhookbootstrap' controller</code> is responsible for creating these secrets with no manual intervention(介入) needed.</p>
<p>If errors occur around the webhook but the webhook is running then the webhook is most likely not reachable from the API server. In this case, ensure that the API server can communicate with the webhook by following the GKE private cluster explanation below.</p>
<h5 id="cainjector">cainjector</h5>
<p>The <a href="https://cert-manager.readthedocs.io/en/latest/reference/cainjector.html" target="_blank" rel="noopener noreffer">cert-manager CA injector</a> is responsible for injecting the two CA bundles above into the webhook&rsquo;s ValidatingWebhookConfiguration and APIService resource in order to allow the Kubernetes apiserver to &lsquo;trust&rsquo; the webhook apiserver.</p>
<p>This component is configured using the <code>cert-manager.io/inject-apiserver-ca: &quot;true&quot;</code> and <code>cert-manager.io/inject-apiserver-ca: &quot;true&quot;</code> annotations on the APIService and ValidatingWebhookConfiguration resources.</p>
<p>It copies across the CA defined in the &lsquo;cert-manager-webhook-ca&rsquo; Secret generated above to the <code>caBundle</code> field on the APIService resource.</p>
<p>It also sets the webhook&rsquo;s <code>clientConfig.caBundle</code> field on the <code>cert-manager-webhook</code> ValidatingWebhookConfiguration resource to that of your Kubernetes API server in order to support Kubernetes versions earlier than v1.11.</p>
<h5 id="known-issues">Known issues</h5>
<p>This section contains known issues with the webhook component.</p>
<p>If you&rsquo;re having problems, or receiving errors when creating cert-manager resources, please read through this section for help.</p>
<h5 id="running-on-private-gke-clusters">Running on private GKE clusters</h5>
<p>When Google configure the control plane for private clusters, they automatically configure VPC peering between your Kubernetes cluster&rsquo;s network and a separate Google managed project.</p>
<p>In order to restrict what Google are able to access within your cluster, the firewall rules configured restrict access to your Kubernetes pods. This will mean that you will experience the webhook to not work and expierence errors such as <code>Internal error occurred: failed calling admission webhook ... the server is currently unable to handle the request</code>.</p>
<p>In order to use the webhook component with a GKE private cluster, you must configure an additional firewall rule to allow the GKE control plane access to your webhook pod.</p>
<p>You can read more information on how to add firewall rules for the GKE control plane nodes in the <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters#add_firewall_rules" target="_blank" rel="noopener noreffer">GKE docs</a>.</p>
<p>Alternatively, you can read how to <a href="https://cert-manager.readthedocs.io/en/latest/getting-started/webhook.html#disable-the-webhook-component" target="_blank" rel="noopener noreffer">disable the webhook component</a> below.</p>
<blockquote>
<p><strong>todo</strong>:
add an example command for how to do this here &amp; explain any security implications</p>
</blockquote>
<h4 id="disable-the-webhook-component">Disable the webhook component</h4>
<p>If you are having issues with the webhook and cannot use it at this time, you can optionally disable the webhook altogether.</p>
<p>Doing this may expose your cluster to mis-configuration problems that in some cases could cause cert-manager to stop working altogether (i.e. if invalid types are set for fields on cert-manager resources).</p>
<p>How you disable the webhook depends on your deployment method.</p>
<h5 id="with-helm">With Helm</h5>
<p>The Helm chart exposes an option that can be used to disable the webhook.</p>
<p>To do so with an existing installation, you can run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">helm upgrade cert-manager <span class="se">\
</span><span class="se"></span>    --reuse-values <span class="se">\
</span><span class="se"></span>    --set webhook.enabled<span class="o">=</span><span class="nb">false</span>
</code></pre></td></tr></table>
</div>
</div><p>If you have not installed cert-manager yet, you can add the <code>--set webhook.enabled=false</code> to the <code>helm install</code> command used to install cert-manager.</p>
<h5 id="with-static-manifests">With static manifests</h5>
<p>Because we cannot specify options when installing the static manifests to conditionally disable different components, we also ship a copy of the deployment files that do not include the webhook.</p>
<p>Instead of installing with <a href="https://github.com/jetstack/cert-manager/releases/download/v0.11.0/cert-manager.yaml" target="_blank" rel="noopener noreffer">cert-manager.yaml</a> file, you should instead use the <a href="https://github.com/jetstack/cert-manager/releases/download/v0.11.0/cert-manager-no-webhook.yaml" target="_blank" rel="noopener noreffer">cert-manager-no-webhook.yaml</a> file located in the deploy directory.</p>
<p>This is a destructive(具有破坏性的)) operation, as it will remove the CustomResourceDefinition resources causing your configured Issuers, Certificates etc to be deleted.</p>
<p>You should first <a href="https://cert-manager.readthedocs.io/en/latest/tasks/backup-restore-crds.html" target="_blank" rel="noopener noreffer">backup your configuration</a> before running the following commands.</p>
<p>To re-install cert-manager without the webhook, run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl delete -f https://github.com/jetstack/cert-manager/releases/download/v0.11.0/cert-manager.yaml

kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v0.11.0/cert-manager-no-webhook.yaml
</code></pre></td></tr></table>
</div>
</div><p>Once you have re-installed cert-manager, you should then <a href="https://cert-manager.readthedocs.io/en/latest/tasks/backup-restore-crds.html" target="_blank" rel="noopener noreffer">restore your configuration</a>.</p>
<h2 id="tutorials">Tutorials</h2>
<p>This section contains guides that help you get started using cert-manager for more specific use cases.</p>
<p>For more information on performing individual tasks, read the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/index.html" target="_blank" rel="noopener noreffer">tasks section</a>.</p>
<h3 id="acme-issuer-tutorials">ACME Issuer Tutorials</h3>
<p>This sections contains tutorials relating to the ACME issuer.</p>
<h4 id="quick-start-using-cert-manager-with-nginx-ingress">Quick-Start using Cert-Manager with NGINX Ingress</h4>
<h5 id="step-0---install-helm-client">Step 0 - Install Helm Client</h5>
<p><strong>Skip this section if you have helm installed.</strong></p>
<p>The easiest way to install <code>cert-manager</code> is to use <a href="https://helm.sh/" target="_blank" rel="noopener noreffer">Helm</a>, a templating and deployment tool for Kubernetes resources.</p>
<p>First, ensure the Helm client is installed following the <a href="https://github.com/helm/helm/blob/master/docs/install.md" target="_blank" rel="noopener noreffer">Helm installation instructions</a>.</p>
<p>For example, on macOS:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">brew install kubernetes-helm
</code></pre></td></tr></table>
</div>
</div><h5 id="step-1---installer-tiller">Step 1 - Installer Tiller</h5>
<p><strong>Skip this section if you have Tiller set-up.</strong></p>
<p>Tiller is Helm&rsquo;s server-side component, which the <code>helm</code> client uses to deploy resources.</p>
<p>Deploying resources is a privileged operation; in the general case requiring arbitrary(任意的) privileges(特权). With this example, we give Tiller complete control of the cluster. View the documentation on <a href="https://docs.helm.sh/using_helm/#securing-your-helm-installation" target="_blank" rel="noopener noreffer">securing helm</a> for details on setting up appropriate permissions for your environment.</p>
<p>Create the a ServiceAccount for tiller:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl create serviceaccount tiller --namespace<span class="o">=</span>kube-system
serviceaccount <span class="s2">&#34;tiller&#34;</span> created
</code></pre></td></tr></table>
</div>
</div><p>Grant the <code>tiller</code> service account <code>cluster-admin</code> privileges:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl create clusterrolebinding tiller-admin --serviceaccount<span class="o">=</span>kube-system:tiller --clusterrole<span class="o">=</span>cluster-admin
clusterrolebinding.rbac.authorization.k8s.io <span class="s2">&#34;tiller-admin&#34;</span> created
</code></pre></td></tr></table>
</div>
</div><p>Install tiller with the <code>tiller</code> service account:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ helm init --service-account<span class="o">=</span>tiller
<span class="nv">$HELM_HOME</span> has been configured at /Users/myaccount/.helm.

Tiller <span class="o">(</span>the Helm server-side component<span class="o">)</span> has been installed into your Kubernetes Cluster.

Please note: by default, Tiller is deployed with an insecure <span class="s1">&#39;allow unauthenticated users&#39;</span> policy.
To prevent this, run <span class="sb">`</span>helm init<span class="sb">`</span> with the --tiller-tls-verify flag.
For more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installation
Happy Helming!
</code></pre></td></tr></table>
</div>
</div><p>Update the helm repository with the latest charts:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ helm repo update
Hang tight <span class="k">while</span> we grab the latest from your chart repositories...
...Skip <span class="nb">local</span> chart repository
...Successfully got an update from the <span class="s2">&#34;stable&#34;</span> chart repository
...Successfully got an update from the <span class="s2">&#34;coreos&#34;</span> chart repository
Update Complete. ⎈ Happy Helming!⎈
</code></pre></td></tr></table>
</div>
</div><h5 id="step-2---deploy-the-nginx-ingress-controller">Step 2 - Deploy the NGINX Ingress Controller</h5>
<p>A <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener noreffer">kubernetes ingress controller</a> is designed to be the access point for HTTP and HTTPS traffic to the software running within your cluster. The nginx-ingress controller does this by providing an HTTP proxy service supported by your cloud provider&rsquo;s load balancer.</p>
<p>You can get more details about nginx-ingress and how it works from the <a href="https://kubernetes.github.io/ingress-nginx/" target="_blank" rel="noopener noreffer">documentation for nginx-ingress</a>.</p>
<p>Use <code>helm</code> to install an Nginx Ingress controller:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ helm install stable/nginx-ingress --name quickstart

NAME:   quickstart
LAST DEPLOYED: Sat Nov <span class="m">10</span> 10:25:06 <span class="m">2018</span>
NAMESPACE: default
STATUS: DEPLOYED

RESOURCES:
<span class="o">==</span>&gt; v1/ConfigMap
NAME                                 AGE
quickstart-nginx-ingress-controller  <span class="nv">0s</span>

<span class="o">==</span>&gt; v1beta1/ClusterRole
quickstart-nginx-ingress  <span class="nv">0s</span>

<span class="o">==</span>&gt; v1beta1/Deployment
quickstart-nginx-ingress-controller       0s
quickstart-nginx-ingress-default-backend  <span class="nv">0s</span>

<span class="o">==</span>&gt; v1/Pod<span class="o">(</span>related<span class="o">)</span>

NAME                                                      READY  STATUS             RESTARTS  AGE
quickstart-nginx-ingress-controller-6cfc45747-wcxrg       0/1    ContainerCreating  <span class="m">0</span>         0s
quickstart-nginx-ingress-default-backend-bf9db5c67-dkg4l  0/1    ContainerCreating  <span class="m">0</span>         <span class="nv">0s</span>

<span class="o">==</span>&gt; v1/ServiceAccount

NAME                      AGE
quickstart-nginx-ingress  <span class="nv">0s</span>

<span class="o">==</span>&gt; v1beta1/ClusterRoleBinding
quickstart-nginx-ingress  <span class="nv">0s</span>

<span class="o">==</span>&gt; v1beta1/Role
quickstart-nginx-ingress  <span class="nv">0s</span>

<span class="o">==</span>&gt; v1beta1/RoleBinding
quickstart-nginx-ingress  <span class="nv">0s</span>

<span class="o">==</span>&gt; v1/Service
quickstart-nginx-ingress-controller       0s
quickstart-nginx-ingress-default-backend  0s


NOTES:
The nginx-ingress controller has been installed.
It may take a few minutes <span class="k">for</span> the LoadBalancer IP to be available.
You can watch the status by running <span class="s1">&#39;kubectl --namespace default get services -o wide -w quickstart-nginx-ingress-controller&#39;</span>

An example Ingress that makes use of the controller:

    apiVersion: extensions/v1beta1
    kind: Ingress
    metadata:
    annotations:
        kubernetes.io/ingress.class: nginx
    name: example
    namespace: foo
    spec:
    rules:
        - host: www.example.com
        http:
            paths:
            - backend:
                serviceName: exampleService
                servicePort: <span class="m">80</span>
                path: /
    <span class="c1"># This section is only required if TLS is to be enabled for the Ingress</span>
    tls:
        - hosts:
            - www.example.com
            secretName: example-tls

If TLS is enabled <span class="k">for</span> the Ingress, a Secret containing the certificate and key must also be provided:

    apiVersion: v1
    kind: Secret
    metadata:
    name: example-tls
    namespace: foo
    data:
    tls.crt: &lt;base64 encoded cert&gt;
    tls.key: &lt;base64 encoded key&gt;
    type: kubernetes.io/tls
</code></pre></td></tr></table>
</div>
</div><p>It can take a minute or two for the cloud provider to provide and link a public IP address. When it is complete, you can see the external IP address using the <code>kubectl</code> command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get svc

NAME                                       TYPE           CLUSTER-IP      EXTERNAL-IP      PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
kubernetes                                 ClusterIP      10.63.240.1     &lt;none&gt;           443/TCP                      23m
quickstart-nginx-ingress-controller        LoadBalancer   10.63.248.177   35.233.154.161   80:31345/TCP,443:31376/TCP   16m
quickstart-nginx-ingress-default-backend   ClusterIP      10.63.250.234   &lt;none&gt;           80/TCP                       16m
</code></pre></td></tr></table>
</div>
</div><p>This command shows you all the services in your cluster (in the <code>default</code> namespace), and any external IP addresses they have. When you first create the controller, your cloud provider won&rsquo;t have assigned and allocated an IP address through the LoadBalancer yet. Until it does, the external IP address for the service will be listed as <code>&lt;pending&gt;</code>.</p>
<p>Your cloud provider may have options for reserving an IP address prior to creating the ingress controller and using that IP address rather than assigning an IP address from a pool. Read through the documentation from your cloud provider on how to arrange that.</p>
<h5 id="step-3---assign-a-dns-name">Step 3 - Assign a DNS name</h5>
<p><em><strong>The external IP that is allocated to the ingress-controller is the IP to which all incoming traffic should be routed</strong></em>. To enable this, add it to a DNS zone you control, for example as <code>example.your-domain.com</code>.</p>
<p>This quickstart assumes you know how to assign a DNS entry to an IP address and
will do so.</p>
<h5 id="step-4---deploy-an-example-service">Step 4 - Deploy an Example Service</h5>
<p>Your service may have its own chart, or you may be deploying it directly with manifests. This quickstart uses manifests to create and expose a sample service. The example service uses <a href="https://github.com/kubernetes-up-and-running/kuard" target="_blank" rel="noopener noreffer">kuard</a>, a demo application which makes an excellent back-end for examples.</p>
<p>The quickstart example uses three manifests for the sample. The first two are a sample deployment and an associated service:</p>
<ul>
<li>
<p>deployment manifest: <a href="https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/docs/tutorials/acme/quick-start/example/deployment.yaml" target="_blank" rel="noopener noreffer">deployment.yaml</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kuard</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">kuard</span><span class="w">
</span><span class="w"></span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w"></span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">kuard</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/kuar-demo/kuard-amd64:1</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kuard</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>service manifest: <a href="https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/docs/tutorials/acme/quick-start/example/service.yaml" target="_blank" rel="noopener noreffer">service.yaml</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kuard</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w"></span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">kuard</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>You can create download and reference these files locally, or you can reference them from the GitHub source repository for this documentation. To install the example service from the tutorial files straight from GitHub, you may use the commands:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl apply -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/docs/tutorials/acme/quick-start/example/deployment.yaml
deployment.extensions <span class="s2">&#34;kuard&#34;</span> created

$ kubectl apply -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/docs/tutorials/acme/quick-start/example/service.yaml
service <span class="s2">&#34;kuard&#34;</span> created
</code></pre></td></tr></table>
</div>
</div><p>An <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener noreffer">ingress resource</a> is what Kubernetes uses to expose this example service outside the cluster.  You will need to download and modify the example manifest
to reflect the domain that you own or control to complete this example.</p>
<p>A sample ingress you can start with is:</p>
<ul>
<li>ingress manifest: <a href="https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/docs/tutorials/acme/quick-start/example/ingress.yaml" target="_blank" rel="noopener noreffer">ingress.yaml</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kuard</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx&#34;</span><span class="w">    
</span><span class="w">    </span><span class="c">#cert-manager.io/issuer: &#34;letsencrypt-staging&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">example.example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">quickstart-example-tls</span><span class="w">
</span><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">example.example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">kuard</span><span class="w">
</span><span class="w">          </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>You can download the sample manifest from github, edit it, and submit the manifest to Kubernetes with the command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl create --edit -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/docs/tutorials/acme/quick-start/example/ingress.yaml

<span class="c1"># edit the file in your editor, and once it is saved:</span>
ingress.extensions <span class="s2">&#34;kuard&#34;</span> created
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>note</strong>:
The ingress example we show above has a <code>host</code> definition within it. The nginx-ingress-controller will route traffic when the hostname requested matches the definition in the ingress. You <em>can</em> deploy an ingress without a <code>host</code> definition in the rule, but that pattern isn&rsquo;t usable with a TLS certificate, which expects a fully qualified domain name.</p>
</blockquote>
<p>Once it is deployed, you can use the command <code>kubectl get ingress</code> to see the status of the ingress:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get ingress
NAME      HOSTS     ADDRESS   PORTS     AGE
kuard     *                   80, <span class="m">443</span>   17s
</code></pre></td></tr></table>
</div>
</div><p>It may take a few minutes, depending on your service provider, for the ingress to be fully created. When it has been created and linked into place, the ingress will show an address as well:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">NAME      HOSTS     ADDRESS         PORTS     AGE
kuard     *         35.199.170.62   <span class="m">80</span>        9m
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>note</strong>:
The IP address on the ingress <em>may not</em> match the IP address that the nginx-ingress-controller. This is fine, and is a quirk/implementation detail of the service provider hosting your Kubernetes cluster. Since we are using the nginx-ingress-controller instead of any cloud-provider specific ingress backend, use the IP address that was defined and allocated for the nginx-ingress-service LoadBalancer resource as the primary access point for your service.</p>
</blockquote>
<p>Make sure the service is reachable at the domain name you added above, for example <code>http://example.your-domain.com</code>. The simplest way is to open a browser and enter the name that you set up in DNS, and for which we just added the ingress.</p>
<p>You may also use a command line tool like <code>curl</code> to check the ingress.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ curl -kivL -H <span class="s1">&#39;Host: example.your-domain.com&#39;</span> <span class="s1">&#39;http://35.199.164.14&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>The options on this curl command will provide verbose(冗长的) output, following any redirects, show the TLS headers in the output, and not error on insecure certificates. With nginx-ingress-controller, the service will be available with a TLS certificate, but it will be using a self-signed certificate provided as a default from the nginx-ingress-controller. Browsers will show a warning that this is an invalid certificate. This is expected and normal, as we have not yet used cert-manager to get a fully trusted certificate for our site.</p>
<blockquote>
<p><strong>warning</strong>:
It is critical to make sure that your ingress is available and responding correctly on the internet. This quickstart example uses Let&rsquo;s Encypt to provide the certificates, which expects and validates both that the service is available and that during the process of issuing a certificate uses that valdiation as proof that the request for the domain belongs to someone with sufficient control over the domain.</p>
</blockquote>
<h5 id="step-5---deploy-cert-manager">Step 5 - Deploy Cert Manager</h5>
<p>We need to install cert-manager to do the work with kubernetes to request a certificate and respond to the challenge to validate it. We can use helm or plain Kubernetes manifest to install cert-manager.</p>
<p>Read the getting started guide to install cert-manager using your prefered method.</p>
<p>Cert-manager uses two different custom resources, also known as <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank" rel="noopener noreffer">CRD</a>&rsquo;s, to configure and control how it operates, as well as share status of its operation. These two resources are:</p>
<ul>
<li><a href="https://cert-manager.readthedocs.io/en/latest/reference/issuers.html" target="_blank" rel="noopener noreffer"><strong>Issuers</strong></a> (or <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html" target="_blank" rel="noopener noreffer"><strong>ClusterIssuers</strong></a>)</li>
</ul>
<p>An Issuer is the definition for where cert-manager will get request TLS certificates. An Issuer is specific to a single namespace in Kubernetes, and a ClusterIssuer is meant to be a cluster-wide definition for the same purpose.</p>
<p>Note that if you&rsquo;re using this document as a guide to configure cert-manager for your own Issuer, you must create the Issuers in the same namespace as your Ingress resouces by adding &lsquo;-n my-namespace&rsquo; to your &lsquo;kubectl create&rsquo; commands. Your other option is to replace your Issuers with ClusterIssuers.</p>
<p>ClusterIssuer resources apply across all Ingress resources in your cluster and don&rsquo;t have this namespace-matching requirement.</p>
<p>More information on the differences between Issuers and ClusterIssuers and when you might choose to use each can be found at: <a href="https://docs.cert-manager.io/en/latest/tasks/issuers/index.html#difference-between-issuers-and-clusterissuers">https://docs.cert-manager.io/en/latest/tasks/issuers/index.html#difference-between-issuers-and-clusterissuers</a></p>
<ul>
<li><a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html" target="_blank" rel="noopener noreffer">Certificate</a></li>
</ul>
<p>A certificate is the resource that cert-manager uses to expose the state of a request as well as track upcoming expirations.</p>
<h5 id="step-6---configure-lets-encrypt-issuer">Step 6 - Configure Let&rsquo;s Encrypt Issuer</h5>
<p>We will set up two issuers for <code>Let's Encrypt</code> in this example. The <code>Let's Encrypt</code> production issuer has <a href="https://letsencrypt.org/docs/rate-limits/" target="_blank" rel="noopener noreffer">very strict rate limits</a>. When you are experimenting and learning, it is very easy to  hit those limits, and confuse rate limiting with errors in configuration or operation.</p>
<p>Because of this, we will start with the <code>Let's Encrypt</code> staging issuer, and once that is working switch to a production issuer.</p>
<p>Create this definition locally and update the email address to your own. This email required by <code>Let's Encrypt</code> and used to notify you of certificate expirations and updates.</p>
<ul>
<li>
<p>staging issuer: <a href="https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/docs/tutorials/acme/quick-start/example/staging-issuer.yaml" target="_blank" rel="noopener noreffer">staging-issuer.yaml</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># The ACME server URL</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="w">
</span><span class="w">    </span><span class="c"># Email address used for ACME registration</span><span class="w">
</span><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">user@example.com</span><span class="w">
</span><span class="w">    </span><span class="c"># Name of a secret used to store the ACME account private key</span><span class="w">
</span><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w">    </span><span class="c"># Enable the HTTP-01 challenge provider</span><span class="w">
</span><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w">  </span><span class="l">nginx</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>Once edited, apply the custom resource:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl create --edit -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/docs/tutorials/acme/quick-start/example/staging-issuer.yaml
issuer.cert-manager.io <span class="s2">&#34;letsencrypt-staging&#34;</span> created
</code></pre></td></tr></table>
</div>
</div><p>Also create a production issuer and deploy it. As with the staging issuer, you will need to update this example and add in your own email address.</p>
<ul>
<li>
<p>production issuer: <a href="https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/docs/tutorials/acme/quick-start/example/production-issuer.yaml" target="_blank" rel="noopener noreffer">production-issuer.yaml</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># The ACME server URL</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-v02.api.letsencrypt.org/directory</span><span class="w">
</span><span class="w">    </span><span class="c"># Email address used for ACME registration</span><span class="w">
</span><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">user@example.com</span><span class="w">
</span><span class="w">    </span><span class="c"># Name of a secret used to store the ACME account private key</span><span class="w">
</span><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span><span class="w">    </span><span class="c"># Enable the HTTP-01 challenge provider</span><span class="w">
</span><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl create --edit -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/docs/tutorials/acme/quick-start/example/production-issuer.yaml
issuer.cert-manager.io <span class="s2">&#34;letsencrypt-prod&#34;</span> created
</code></pre></td></tr></table>
</div>
</div><p>Both of these issuers are configured to use the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/http01/index.html" target="_blank" rel="noopener noreffer">HTTP01</a> challenge provider.</p>
<p>Check on the status of the issuer after you create it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe issuer letsencrypt-staging

Name:         letsencrypt-staging
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  kubectl.kubernetes.io/last-applied-configuration<span class="o">={</span><span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;cert-manager.io/v1alpha2&#34;</span>,<span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;Issuer&#34;</span>,<span class="s2">&#34;metadata&#34;</span>:<span class="o">{</span><span class="s2">&#34;annotations&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;letsencrypt-staging&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;default&#34;</span><span class="o">}</span>,<span class="s2">&#34;spec&#34;</span>:<span class="o">{</span><span class="s2">&#34;a...
</span><span class="s2">API Version:  cert-manager.io/v1alpha2
</span><span class="s2">Kind:         Issuer
</span><span class="s2">Metadata:
</span><span class="s2">    Cluster Name:
</span><span class="s2">    Creation Timestamp:  2018-11-17T18:03:54Z
</span><span class="s2">    Generation:          0
</span><span class="s2">    Resource Version:    9092
</span><span class="s2">    Self Link:           /apis/cert-manager.io/v1alpha2/namespaces/default/issuers/letsencrypt-staging
</span><span class="s2">    UID:                 25b7ae77-ea93-11e8-82f8-42010a8a00b5
</span><span class="s2">Spec:
</span><span class="s2">    Acme:
</span><span class="s2">    Email:  your.email@your-domain.com
</span><span class="s2">    Private Key Secret Ref:
</span><span class="s2">        Key:
</span><span class="s2">        Name:  letsencrypt-staging
</span><span class="s2">    Server:  https://acme-staging-v02.api.letsencrypt.org/directory
</span><span class="s2">    Solvers:
</span><span class="s2">        Http 01:
</span><span class="s2">        Ingress:
</span><span class="s2">            Class:  nginx
</span><span class="s2">Status:
</span><span class="s2">    Acme:
</span><span class="s2">    Uri:  https://acme-staging-v02.api.letsencrypt.org/acme/acct/7374163
</span><span class="s2">    Conditions:
</span><span class="s2">    Last Transition Time:  2018-11-17T18:04:00Z
</span><span class="s2">    Message:               The ACME account was registered with the ACME server
</span><span class="s2">    Reason:                ACMEAccountRegistered
</span><span class="s2">    Status:                True
</span><span class="s2">    Type:                  Ready
</span><span class="s2">Events:                    &lt;none&gt;
</span></code></pre></td></tr></table>
</div>
</div><p>You should see the issuer listed with a registered account.</p>
<h5 id="step-7---deploy-a-tls-ingress-resource">Step 7 - Deploy a TLS Ingress Resource</h5>
<p>With all the pre-requisite configuration in place, we can now do the pieces to request the TLS certificate. There are two primary ways to do this: using annotations on the ingress with <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuing-certificates/ingress-shim.html" target="_blank" rel="noopener noreffer">ingress-shim</a> or directly creating a certificate resource.</p>
<p><strong>In this example, we will add annotations to the ingress, and take advantage of <code>ingress-shim</code> to have it create the certificate resource on our behalf. After creating a certificate, the cert-manager will update or create a ingress resource and use that to validate the domain. Once verified and issued, cert-manager will create or update the secret defined in the certificate.</strong></p>
<blockquote>
<p><strong>note</strong>:</p>
<ul>
<li>The secret that is used in the ingress should match the secret defined in the certificate.</li>
<li>There isn&rsquo;t any explicit(精密的) checking, so a typo(错字) will resut in the nginx-ingress-controller falling back to its self-signed certificate. In our example, we are using annotations on the ingress (and ingress-shim) which will create the correct secrets on your behalf.</li>
</ul>
</blockquote>
<p>Edit the ingress add the annotations that were commented out in our earlier example:</p>
<ul>
<li>
<p>ingress tls: <a href="https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/docs/tutorials/acme/quick-start/example/ingress-tls.yaml" target="_blank" rel="noopener noreffer">ingress-tls.yaml</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kuard</span><span class="w">
</span><span class="w"></span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">cert-manager.io/issuer</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;letsencrypt-staging&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">example.example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">quickstart-example-tls</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">example.example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">kuard</span><span class="w">
</span><span class="w">        </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>and apply it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl create --edit -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/docs/tutorials/acme/quick-start/example/ingress-tls.yaml
ingress.extensions <span class="s2">&#34;kuard&#34;</span> configured
</code></pre></td></tr></table>
</div>
</div><p>Cert-manager will read these annotations and use them to create a certificate, which you can request and see:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get certificate
NAME                     READY   SECRET                   AGE
quickstart-example-tls   True    quickstart-example-tls   16m
</code></pre></td></tr></table>
</div>
</div><p>Cert-manager reflects the state of the process for every request in the certificate object. You can view this information using the <code>kubectl describe</code> command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">$ kubectl describe certificate quickstart-example-tls</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">Name</span><span class="p">:</span><span class="w">         </span><span class="l">quickstart-example-tls</span><span class="w">
</span><span class="w"></span><span class="nt">Namespace</span><span class="p">:</span><span class="w">    </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">Labels</span><span class="p">:</span><span class="w">       </span><span class="l">&lt;none&gt;</span><span class="w">
</span><span class="w"></span><span class="nt">Annotations</span><span class="p">:</span><span class="w">  </span><span class="l">&lt;none&gt;</span><span class="w">
</span><span class="w"></span><span class="nt">API Version</span><span class="p">:</span><span class="w">  </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">Kind</span><span class="p">:</span><span class="w">         </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">Metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Cluster Name</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Creation Timestamp</span><span class="p">:</span><span class="w">  </span><span class="ld">2018-11-17T17:58:37Z</span><span class="w">
</span><span class="w">    </span><span class="nt">Generation</span><span class="p">:</span><span class="w">          </span><span class="m">0</span><span class="w">
</span><span class="w">    </span><span class="nt">Owner References</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">API Version</span><span class="p">:</span><span class="w">           </span><span class="l">extensions/v1beta1</span><span class="w">
</span><span class="w">    </span><span class="nt">Block Owner Deletion</span><span class="p">:</span><span class="w">  </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">Controller</span><span class="p">:</span><span class="w">            </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">Kind</span><span class="p">:</span><span class="w">                  </span><span class="l">Ingress</span><span class="w">
</span><span class="w">    </span><span class="nt">Name</span><span class="p">:</span><span class="w">                  </span><span class="l">kuard</span><span class="w">
</span><span class="w">    </span><span class="nt">UID</span><span class="p">:</span><span class="w">                   </span><span class="l">a3e9f935-ea87-11e8-82f8-42010a8a00b5</span><span class="w">
</span><span class="w">    </span><span class="nt">Resource Version</span><span class="p">:</span><span class="w">        </span><span class="m">9295</span><span class="w">
</span><span class="w">    </span><span class="nt">Self Link</span><span class="p">:</span><span class="w">               </span><span class="l">/apis/cert-manager.io/v1alpha2/namespaces/default/certificates/quickstart-example-tls</span><span class="w">
</span><span class="w">    </span><span class="nt">UID</span><span class="p">:</span><span class="w">                     </span><span class="l">68d43400-ea92-11e8-82f8-42010a8a00b5</span><span class="w">
</span><span class="w"></span><span class="nt">Spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Dns Names</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="l">example.your-domain.com</span><span class="w">
</span><span class="w">    </span><span class="nt">Issuer Ref</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Kind</span><span class="p">:</span><span class="w">       </span><span class="l">Issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">Name</span><span class="p">:</span><span class="w">       </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w">    </span><span class="nt">Secret Name</span><span class="p">:</span><span class="w">  </span><span class="l">quickstart-example-tls</span><span class="w">
</span><span class="w"></span><span class="nt">Status</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Order</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">URL</span><span class="p">:</span><span class="w">  </span><span class="l">https://acme-staging-v02.api.letsencrypt.org/acme/order/7374163/13665676</span><span class="w">
</span><span class="w">    </span><span class="nt">Conditions</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Last Transition Time</span><span class="p">:</span><span class="w">  </span><span class="ld">2018-11-17T18:05:57Z</span><span class="w">
</span><span class="w">    </span><span class="nt">Message</span><span class="p">:</span><span class="w">               </span><span class="l">Certificate issued successfully</span><span class="w">
</span><span class="w">    </span><span class="nt">Reason</span><span class="p">:</span><span class="w">                </span><span class="l">CertIssued</span><span class="w">
</span><span class="w">    </span><span class="nt">Status</span><span class="p">:</span><span class="w">                </span><span class="kc">True</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w">                  </span><span class="l">Ready</span><span class="w">
</span><span class="w"></span><span class="nt">Events</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="l">Type     Reason          Age                From          Message</span><span class="w">
</span><span class="w">    </span>---- <span class="w">    </span>------ <span class="w">         </span>---- <span class="w">              </span>---- <span class="w">         </span>-------<span class="w">
</span><span class="w">    </span><span class="l">Normal   CreateOrder     9m                 cert-manager  Created new ACME order, attempting validation...</span><span class="w">
</span><span class="w">    </span><span class="l">Normal   DomainVerified  8m                 cert-manager  Domain &#34;example.your-domain.com&#34; verified with &#34;http-01&#34; validation</span><span class="w">
</span><span class="w">    </span><span class="l">Normal   IssueCert       8m                 cert-manager  Issuing certificate...</span><span class="w">
</span><span class="w">    </span><span class="l">Normal   CertObtained    7m                 cert-manager  Obtained certificate from ACME server</span><span class="w">
</span><span class="w">    </span><span class="l">Normal   CertIssued      7m                 cert-manager  Certificate issued Successfully</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The events associated with this resource and listed at the bottom of the <code>describe</code> results show the state of the request. In the above example the certificate was validated and issued within a couple of minutes.</p>
<p>Once complete, cert-manager will have created a secret with the details of the certificate based on the secret used in the ingress resource. You can use the describe command as well to see some details:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe secret quickstart-example-tls

Name:         quickstart-example-tls
Namespace:    default
Labels:       cert-manager.io/certificate-name<span class="o">=</span>quickstart-example-tls
Annotations:  cert-manager.io/alt-names<span class="o">=</span>example.your-domain.com
                cert-manager.io/common-name<span class="o">=</span>example.your-domain.com
                cert-manager.io/issuer-kind<span class="o">=</span>Issuer
                cert-manager.io/issuer-name<span class="o">=</span>letsencrypt-staging

Type:  kubernetes.io/tls

<span class="nv">Data</span>
<span class="o">====</span>
tls.crt:  <span class="m">3566</span> bytes
tls.key:  <span class="m">1675</span> bytes
</code></pre></td></tr></table>
</div>
</div><p>Now that we have confidence that everything is configured correctly, you can update the annotations in the ingress to specify the production issuer:</p>
<ul>
<li>
<p>ingress tls final: <a href="https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/docs/tutorials/acme/quick-start/example/ingress-tls-final.yaml" target="_blank" rel="noopener noreffer">ingress-tls-final.yaml</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kuard</span><span class="w">
</span><span class="w"></span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">cert-manager.io/issuer</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;letsencrypt-prod&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">example.example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">quickstart-example-tls</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">example.example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">kuard</span><span class="w">
</span><span class="w">        </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl create --edit -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/docs/tutorials/acme/quick-start/example/ingress-tls-final.yaml

ingress.extensions <span class="s2">&#34;kuard&#34;</span> configured
</code></pre></td></tr></table>
</div>
</div><p>You will also need to delete the existing secret, which <code>cert-manager</code> is watching and will cause it to reprocess the request with the updated issuer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl delete secret quickstart-example-tls

secret <span class="s2">&#34;quickstart-example-tls&#34;</span> deleted
</code></pre></td></tr></table>
</div>
</div><p>This will start the process to get a new certificate, and using describe you can see the status. Once the production certificate has been updated, you should see the example <code>KUARD</code> running at your domain with a signed TLS certificate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe certificate

Name:         quickstart-example-tls
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
API Version:  cert-manager.io/v1alpha2
Kind:         Certificate
Metadata:
    Cluster Name:
    Creation Timestamp:  2018-11-17T18:36:48Z
    Generation:          <span class="m">0</span>
    Owner References:
    API Version:           extensions/v1beta1
    Block Owner Deletion:  <span class="nb">true</span>
    Controller:            <span class="nb">true</span>
    Kind:                  Ingress
    Name:                  kuard
    UID:                   a3e9f935-ea87-11e8-82f8-42010a8a00b5
    Resource Version:        <span class="m">283686</span>
    Self Link:               /apis/cert-manager.io/v1alpha2/namespaces/default/certificates/quickstart-example-tls
    UID:                     bdd93b32-ea97-11e8-82f8-42010a8a00b5
Spec:
    Dns Names:
    example.your-domain.com
    Issuer Ref:
    Kind:       Issuer
    Name:       letsencrypt-prod
    Secret Name:  quickstart-example-tls
Status:
    Conditions:
    Last Transition Time:  2019-01-09T13:52:05Z
    Message:               Certificate does not exist
    Reason:                NotFound
    Status:                False
    Type:                  Ready
Events:
    Type    Reason        Age   From          Message
kubectl describe certificate quickstart-example-tls   ----    ------        ----  ----          -------
    Normal  Generated     18s   cert-manager  Generated new private key
    Normal  OrderCreated  18s   cert-manager  Created Order resource <span class="s2">&#34;quickstart-example-tls-889745041&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>You can see the current state of the ACME Order by running <code>kubectl describe</code> on the Order resource that cert-manager has created for your Certificate:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe order quickstart-example-tls-889745041
...
Events:
    Type    Reason      Age   From          Message
    ----    ------      ----  ----          -------
    Normal  Created     90s   cert-manager  Created Challenge resource <span class="s2">&#34;quickstart-example-tls-889745041-0&#34;</span> <span class="k">for</span> domain <span class="s2">&#34;example.your-domain.com&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Here, we can see that cert-manager has created 1 &lsquo;Challenge&rsquo; resource to fulfil the Order. You can dig into the state of the current ACME challenge by running <code>kubectl describe</code> on the automatically created Challenge resource:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe challenge quickstart-example-tls-889745041-0
...

Status:
    Presented:   <span class="nb">true</span>
    Processing:  <span class="nb">true</span>
    Reason:      Waiting <span class="k">for</span> http-01 challenge propagation
    State:       pending
Events:
    Type    Reason     Age   From          Message
    ----    ------     ----  ----          -------
    Normal  Started    15s   cert-manager  Challenge scheduled <span class="k">for</span> processing
    Normal  Presented  14s   cert-manager  Presented challenge using http-01 challenge mechanism
</code></pre></td></tr></table>
</div>
</div><p>From above, we can see that the challenge has been &lsquo;presented&rsquo; and cert-manager is waiting for the challenge record to propagate(传播) to the ingress controller.</p>
<p>You should keep an eye out for new events on the challenge resource, as a &lsquo;success&rsquo; event should be printed after a minute or so (depending on how fast your ingress controller is at updating rules):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe challenge quickstart-example-tls-889745041-0
...

Status:
    Presented:   <span class="nb">false</span>
    Processing:  <span class="nb">false</span>
    Reason:      Successfully authorized domain
    State:       valid
Events:
    Type    Reason          Age   From          Message
    ----    ------          ----  ----          -------
    Normal  Started         71s   cert-manager  Challenge scheduled <span class="k">for</span> processing
    Normal  Presented       70s   cert-manager  Presented challenge using http-01 challenge mechanism
    Normal  DomainVerified  2s    cert-manager  Domain <span class="s2">&#34;example.your-domain.com&#34;</span> verified with <span class="s2">&#34;http-01&#34;</span> validation
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>note</strong>:
If your challenges are not becoming &lsquo;valid&rsquo; and remain in the &lsquo;pending&rsquo; state (or enter into a &lsquo;failed&rsquo; state), it is likely there is some kind of configuration error. Read the <a href="https://cert-manager.readthedocs.io/en/latest/reference/challenges.html" target="_blank" rel="noopener noreffer">Challenge resource reference docs</a> for more information on debugging failing challenges.</p>
</blockquote>
<p>Once the challenge(s) have been completed, their corresponding challenge resources will be <em>deleted</em>, and the &lsquo;Order&rsquo; will be updated to reflect the new state of the Order:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe order quickstart-example-tls-889745041
...
Events:
    Type    Reason      Age   From          Message
    ----    ------      ----  ----          -------
    Normal  Created     90s   cert-manager  Created Challenge resource <span class="s2">&#34;quickstart-example-tls-889745041-0&#34;</span> <span class="k">for</span> domain <span class="s2">&#34;example.your-domain.com&#34;</span>
    Normal  OrderValid  16s   cert-manager  Order completed successfully
</code></pre></td></tr></table>
</div>
</div><p>Finally, the &lsquo;Certificate&rsquo; resource will be updated to reflect the state of the issuance process. If all is well, you should be able to &lsquo;describe&rsquo; the Certificate and see something like the below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe certificate quickstart-example-tls

Status:
    Conditions:
    Last Transition Time:  2019-01-09T13:57:52Z
    Message:               Certificate is up to date and has not expired
    Reason:                Ready
    Status:                True
    Type:                  Ready
    Not After:               2019-04-09T12:57:50Z
Events:
    Type    Reason         Age                  From          Message
    ----    ------         ----                 ----          -------
    Normal  Generated      11m                  cert-manager  Generated new private key
    Normal  OrderCreated   11m                  cert-manager  Created Order resource <span class="s2">&#34;quickstart-example-tls-889745041&#34;</span>
    Normal  OrderComplete  10m                  cert-manager  Order <span class="s2">&#34;quickstart-example-tls-889745041&#34;</span> completed successfully
</code></pre></td></tr></table>
</div>
</div><h4 id="issuing-an-acme-certificate-using-dns-validation">Issuing an ACME certificate using DNS validation</h4>
<blockquote>
<p><strong>todo</strong>:
This guide needs rewriting to be clearer, splitting into sections and potentially rewriting altogether.<br>
这一节以后会被重写。</p>
</blockquote>
<p>cert-manager can be used to obtain certificates from a CA using the <a href="https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment" target="_blank" rel="noopener noreffer">ACME</a> protocol. The ACME protocol supports various challenge mechanisms which are used to prove
ownership of a domain so that a valid certificate can be issued for that domain.<br>
cert-manager 可以用于从一个 CA（证书颁发者机构） 使用 ACME 协议获取证书。 ACME 协议支持各种质询机制来证明一个域名的拥有者，从而对应的域名能够被签发有效的证书。</p>
<p><strong>One such challenge mechanism is <code>DNS-01</code>. With a <code>DNS-01 challenge</code>, you prove ownership of a domain by proving you control its DNS records. This is done by creating a TXT record with specific content that proves you have control of the domains DNS records.</strong><br>
怎么提供呢？</p>
<p>The following Issuer defines the necessary information to enable DNS validation. You can read more about the Issuer resource in the <a href="https://cert-manager.readthedocs.io/en/latest/reference/issuers.html" target="_blank" rel="noopener noreffer">Issuer reference docs</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="w">
</span><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">user@example.com</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># Name of a secret used to store the ACME account private key</span><span class="w">
</span><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># ACME DNS-01 provider configurations</span><span class="w">
</span><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># An empty &#39;selector&#39; means that this solver matches all domains</span><span class="w">
</span><span class="w">    </span>- <span class="nt">selector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">        </span><span class="nt">dns01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">clouddns</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="c"># The ID of the GCP project</span><span class="w">
</span><span class="w">            </span><span class="c"># reference: https://docs.cert-manager.io/en/latest/tasks/issuers/setup-acme/dns01/google.html</span><span class="w">
</span><span class="w">            </span><span class="nt">project</span><span class="p">:</span><span class="w"> </span><span class="l">$PROJECT_ID</span><span class="w">
</span><span class="w">            </span><span class="c"># This is the secret used to access the service account</span><span class="w">
</span><span class="w">            </span><span class="nt">serviceAccountSecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clouddns-dns01-solver-svc-acct</span><span class="w">
</span><span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">key.json</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># We only use cloudflare to solve challenges for foo.com.</span><span class="w">
</span><span class="w">    </span><span class="c"># Alternative options such as &#39;matchLabels&#39; and &#39;dnsZones&#39; can be specified</span><span class="w">
</span><span class="w">    </span><span class="c"># as part of a solver&#39;s selector too.</span><span class="w">
</span><span class="w">    </span>- <span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">foo.com</span><span class="w">
</span><span class="w">        </span><span class="nt">dns01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">cloudflare</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">my-cloudflare-acc@example.com</span><span class="w">
</span><span class="w">            </span><span class="c"># !! Remember to create a k8s secret before</span><span class="w">
</span><span class="w">            </span><span class="c"># kubectl create secret generic cloudflare-api-key</span><span class="w">
</span><span class="w">            </span><span class="nt">apiKeySecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloudflare-api-key-secret</span><span class="w">
</span><span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">api-key</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>We have specified the ACME server URL for <code>Let's Encrypt</code>&rsquo;s <a href="https://letsencrypt.org/docs/staging-environment/" target="_blank" rel="noopener noreffer">staging environment</a>.</p>
<p>The staging environment will not issue trusted certificates but is used to ensure that the verification process is working properly before moving to production. <code>Let's Encrypt</code>&rsquo;s production environment imposes much stricter <a href="https://letsencrypt.org/docs/rate-limits/" target="_blank" rel="noopener noreffer">rate limits</a>, so to reduce the chance of you hitting those limits it is highly recommended to start by using the staging environment. To move to production, simply create a new Issuer with the URL set to <code>https://acme-v02.api.letsencrypt.org/directory</code>.</p>
<p>The first stage of the ACME protocol is for the client to register with the ACME server. This phase includes generating an asymmetric(不对称) key pair which is then associated with the email address specified in the Issuer. Make sure to change this email address to a valid one that you own. It is commonly used to send expiry notices when your certificates are coming up for renewal. The generated private key is stored in a Secret named <code>letsencrypt-staging</code>.</p>
<p>The <code>dns01</code> stanza(节) contains a list of DNS-01 providers that can be used to solve DNS challenges. Our Issuer defines two providers. This gives us a choice of which one to use when obtaining certificates.</p>
<p>More information about the DNS provider configuration, including a list of supported providers, can be found <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/dns01/index.html#supported-dns01-providers" target="_blank" rel="noopener noreffer">in the dns01 reference docs</a>.</p>
<p>Once we have created the above Issuer we can use it to obtain a certificate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-com</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">example-com-tls</span><span class="w">
</span><span class="w">    </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w">    </span><span class="nt">commonName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;*.example.com&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">example.com</span><span class="w">
</span><span class="w">    </span>- <span class="l">foo.com</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The Certificate resource describes our desired certificate and the possible methods that can be used to obtain it.</p>
<p>You can obtain certificates for wildcard domains just like any other. Make sure to wrap wildcard domains with asterisks in your YAML resources, to avoid formatting issues.</p>
<p>If you specify both <code>example.com</code> and <code>*.example.com</code> on the same Certificate, it will take slightly longer to perform validation as each domain will have to be validated one after the other.</p>
<p>You can learn more about the Certificate resource in the <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html" target="_blank" rel="noopener noreffer">reference docs</a>.</p>
<p>If the certificate is obtained successfully, the resulting key pair will be stored in a secret called <code>example-com-tls</code> in the same namespace as the Certificate.</p>
<p>The certificate will have a common name of <code>*.example.com</code> and the <a href="https://en.wikipedia.org/wiki/Subject_Alternative_Name" target="_blank" rel="noopener noreffer">Subject Alternative Names</a> (SANs) will be <code>*.example.com</code>, <code>example.com</code> and <code>foo.com</code>.</p>
<p>In our Certificate we have referenced the <code>letsencrypt-staging</code> Issuer above. The Issuer must be in the same namespace as the Certificate. If you want to reference a ClusterIssuer, which is a cluster-scoped version of an Issuer, you must add <code>kind: ClusterIssuer</code> to the <code>issuerRef</code> stanza. For more information on ClusterIssuers, read <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html" target="_blank" rel="noopener noreffer">the ClusterIssuer reference docs</a>.</p>
<p>The <code>acme</code> stanza defines the configuration for our ACME challenges. <strong>Here we have defined the configuration for our DNS challenges which will be used to verify domain ownership.</strong></p>
<p>For each domain mentioned in a <code>dns01</code> stanza, cert-manager will use the provider&rsquo;s credentials from the referenced Issuer to create a TXT record called <code>_acme-challenge</code>. This record will then be verified by the ACME server in order to issue the
certificate.</p>
<p>Once domain ownership has been verified, any cert-manager affected records will
be cleaned up.</p>
<blockquote>
<p><strong>note</strong>:
It is your responsibility to ensure the selected provider is authoritative for your domain.</p>
</blockquote>
<p>After creating the above Certificate, we can check whether it has been obtained successfully using <code>kubectl describe</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe certificate example-com
Events:
    Type    Reason          Age      From          Message
    ----    ------          ----     ----          -------
    Normal  CreateOrder     57m      cert-manager  Created new ACME order, attempting validation...
    Normal  DomainVerified  55m      cert-manager  Domain <span class="s2">&#34;*.example.com&#34;</span> verified with <span class="s2">&#34;dns-01&#34;</span> validation
    Normal  DomainVerified  55m      cert-manager  Domain <span class="s2">&#34;example.com&#34;</span> verified with <span class="s2">&#34;dns-01&#34;</span> validation
    Normal  DomainVerified  55m      cert-manager  Domain <span class="s2">&#34;foo.com&#34;</span> verified with <span class="s2">&#34;dns-01&#34;</span> validation
    Normal  IssueCert       55m      cert-manager  Issuing certificate...
    Normal  CertObtained    55m      cert-manager  Obtained certificate from ACME server
    Normal  CertIssued      55m      cert-manager  Certificate issued successfully
</code></pre></td></tr></table>
</div>
</div><p>You can also check whether issuance was successful with <code>kubectl get secret example-com-tls -o yaml</code>. You should see a base64 encoded signed TLS key pair.</p>
<p>Once our certificate has been obtained, cert-manager will periodically check its validity and attempt to renew it if it gets close to expiry. cert-manager considers certificates to be close to expiry when the &lsquo;Not After&rsquo; field on the certificate is less than the current time plus 30 days.</p>
<h4 id="issuing-an-acme-certificate-using-http-validation">Issuing an ACME certificate using HTTP validation</h4>
<p>cert-manager can be used to obtain certificates from a CA using the <a href="https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment" target="_blank" rel="noopener noreffer">ACME</a> protocol. The ACME protocol supports various challenge mechanisms which are used to prove ownership of a domain so that a valid certificate can be issued for that domain.</p>
<p><strong>One such challenge mechanism is the <code>HTTP-01 challenge</code>. With a HTTP-01 challenge, you prove ownership of a domain by ensuring that a particular file is present at
the domain. It is assumed that you control the domain if you are able to publish the given file under a given path.</strong></p>
<p>The following Issuer defines the necessary information to enable HTTP validation. You can read more about the Issuer resource in the <a href="https://cert-manager.readthedocs.io/en/latest/reference/issuers.html" target="_blank" rel="noopener noreffer">Issuer reference docs</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># The ACME server URL</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="w">
</span><span class="w">    </span><span class="c"># Email address used for ACME registration</span><span class="w">
</span><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">user@example.com</span><span class="w">
</span><span class="w">    </span><span class="c"># Name of a secret used to store the ACME account private key</span><span class="w">
</span><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w">    </span><span class="c"># Enable the HTTP-01 challenge provider</span><span class="w">
</span><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># An empty &#39;selector&#39; means that this solver matches all domains</span><span class="w">
</span><span class="w">    </span>- <span class="nt">selector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">        </span><span class="nt">http01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>We have specified the ACME server URL for Let&rsquo;s Encrypt&rsquo;s <a href="https://letsencrypt.org/docs/staging-environment/" target="_blank" rel="noopener noreffer">staging environment</a>. The staging environment will not issue trusted certificates but is used to
ensure that the verification process is working properly before moving to production. Let&rsquo;s Encrypt&rsquo;s production environment imposes much stricter <a href="https://letsencrypt.org/docs/rate-limits/" target="_blank" rel="noopener noreffer">rate limits</a>, so to reduce the chance of you hitting those limits it is highly recommended to start by using the staging environment. To move to production, simply create a new Issuer with the URL set to <code>https://acme-v02.api.letsencrypt.org/directory</code>.</p>
<p>The first stage of the ACME protocol is for the client to register with the ACME server. This phase includes generating an asymmetric key pair which is then associated with the email address specified in the Issuer. Make sure to change this email address to a valid one that you own. It is commonly used to send expiry notices when your certificates are coming up for renewal. The generated private key is stored in a Secret named <code>letsencrypt-staging</code>.</p>
<p>We must provide one or more Solvers for handling the ACME challenge. In this case we want to use HTTP validation so we specify an <code>http01</code> Solver. We could optionally map different domains to use different Solver configurations.</p>
<p>Once we have created the above Issuer we can use it to obtain a certificate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-com</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">example-com-tls</span><span class="w">
</span><span class="w">    </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w">    </span><span class="nt">commonName</span><span class="p">:</span><span class="w"> </span><span class="l">example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">www.example.com</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The Certificate resource describes our desired certificate and the possible methods that can be used to obtain it. You can learn more about the Certificate resource in the <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html" target="_blank" rel="noopener noreffer">reference docs</a>.</p>
<p>If the certificate is obtained successfully, the resulting key pair will be stored in a secret called <code>example-com-tls</code> in the same namespace as the Certificate. The certificate will have a common name of <code>example.com</code> and the <a href="https://en.wikipedia.org/wiki/Subject_Alternative_Name" target="_blank" rel="noopener noreffer">Subject Alternative Names</a>(SANs) will be <code>example.com</code> and <code>www.example.com</code>.</p>
<p>In our Certificate we have referenced the <code>letsencrypt-staging</code> Issuer above. The Issuer must be in the same namespace as the Certificate. If you want to reference a ClusterIssuer, which is a cluster-scoped version of an Issuer, you must add <code>kind: ClusterIssuer</code> to the <code>issuerRef</code> stanza. For more information on ClusterIssuers, read the <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html" target="_blank" rel="noopener noreffer">ClusterIssuer reference docs</a>.</p>
<p>The <code>acme</code> stanza defines the configuration for our ACME challenges. Here we have defined the configuration for our HTTP-01 challenges which will be used to verify domain ownership.</p>
<p>To verify ownership of each domain mentioned in an <code>http01</code> stanza, cert-manager will create a Pod, Service and Ingress that exposes an HTTP endpoint that satisfies the HTTP-01 challenge.</p>
<p>The fields <code>ingress</code> and <code>ingressClass</code> in the <code>http01</code> stanza can be used to control how cert-manager interacts with Ingress resources:</p>
<ul>
<li>
<p>If the <code>ingress</code> field is specified, then an Ingress resource with the same name in the same namespace as the Certificate must already exist and it will be modified only to add the appropriate rules to solve the challenge. This field is useful for the GCLB ingress controller, as well as a number of others, that assign a single public IP address for each ingress resource. Without manual intervention, creating a new ingress resource would cause any challenges to fail.</p>
</li>
<li>
<p>If the <code>ingressClass</code> field is specified, a new ingress resource with a randomly generated name will be created in order to solve the challenge. This new resource will have an annotation with key <code>kubernetes.io/ingress.class</code> and value set to the value of the <code>ingressClass</code> field. This works for the likes of the NGINX ingress controller.</p>
</li>
<li>
<p>If neither are specified, new ingress resources will be created with a randomly generated name, but they will not have the ingress class annotation set.</p>
</li>
<li>
<p>If both are specified, then the <code>ingress</code> field will take precedence.</p>
</li>
</ul>
<p>Once domain ownership has been verified, any cert-manager affected resources will be cleaned up or deleted.</p>
<blockquote>
<p><strong>note</strong>:
It is your responsibilty to point each domain name at the correct IP address for your ingress controller.</p>
</blockquote>
<p>After creating the above Certificate, we can check whether it has been obtained successfully using <code>kubectl describe</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe certificate example-com
Events:
    Type    Reason          Age      From          Message
    ----    ------          ----     ----          -------
    Normal  CreateOrder     57m      cert-manager  Created new ACME order, attempting validation...
    Normal  DomainVerified  55m      cert-manager  Domain <span class="s2">&#34;example.com&#34;</span> verified with <span class="s2">&#34;http-01&#34;</span> validation
    Normal  DomainVerified  55m      cert-manager  Domain <span class="s2">&#34;www.example.com&#34;</span> verified with <span class="s2">&#34;http-01&#34;</span> validation
    Normal  IssueCert       55m      cert-manager  Issuing certificate...
    Normal  CertObtained    55m      cert-manager  Obtained certificate from ACME server
    Normal  CertIssued      55m      cert-manager  Certificate issued successfully
</code></pre></td></tr></table>
</div>
</div><p>You can also check whether issuance was successful with <code>kubectl get secret example-com-tls -o yaml</code>. You should see a base64 encoded signed TLS key pair.</p>
<p>Once our certificate has been obtained, cert-manager will periodically check its validity and attempt to renew it if it gets close to expiry. cert-manager considers certificates to be close to expiry when the &lsquo;Not After&rsquo; field on the certificate is less than the current time plus 30 days.</p>
<h4 id="migrating-from-kube-lego">Migrating from kube-lego</h4>
<p><a href="https://github.com/jetstack/kube-lego" target="_blank" rel="noopener noreffer">kube-lego</a> is an older Jetstack project for obtaining TLS certificates from Let&rsquo;s Encrypt (or another ACME server).</p>
<p>Since cert-managers release, kube-lego has been gradually deprecated in favour of this project. There are a number of key differences between the two:</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>kube-lego</th>
<th>cert-manager</th>
</tr>
</thead>
<tbody>
<tr>
<td>Configuration</td>
<td>Annotations on Ingress resources</td>
<td>CRDs</td>
</tr>
<tr>
<td>CAs</td>
<td>ACME</td>
<td>ACME, signing keypair</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>v1.2 - v1.8</td>
<td>v1.7+</td>
</tr>
<tr>
<td>Debugging</td>
<td>Look at logs</td>
<td>Kubernetes Events API</td>
</tr>
<tr>
<td>Multi-tenancy</td>
<td>Not supported</td>
<td>Supported</td>
</tr>
<tr>
<td>Distinct issuance sources per Certificate</td>
<td>Not supported</td>
<td>Supported</td>
</tr>
</tbody>
</table>
<p>This guide will walk through how you can safely migrate your kube-lego installation to cert-manager, without service interruption.</p>
<p>By the end of the guide, we should have:</p>
<ol>
<li>
<p>Scaled down and removed kube-lego</p>
</li>
<li>
<p>Installed cert-manager</p>
</li>
<li>
<p>Migrated ACME private key to cert-manager</p>
</li>
<li>
<p>Created an ACME ClusterIssuer using this private key, to issue certificates throughout your cluster</p>
</li>
<li>
<p>Configured cert-manager&rsquo;s <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuing-certificates/ingress-shim.html" target="_blank" rel="noopener noreffer">ingress-shim</a> to automatically provision Certificate resources for all Ingress resources with the <code>kubernetes.io/tls-acme: &quot;true&quot;</code> annotation, using the ClusterIssuer we have created</p>
</li>
<li>
<p>Verified that the cert-manager installation is working</p>
</li>
</ol>
<h5 id="1-scale-down-kube-lego">1. Scale down kube-lego</h5>
<p>Before we begin deploying cert-manager, it is best we scale our kube-lego deployment down to 0 replicas. This will prevent the two controllers potentially &lsquo;fighting&rsquo; each other. If you deployed kube-lego using the official deployment YAMLs, a command like so should do:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl scale deployment kube-lego <span class="se">\
</span><span class="se"></span>    --namespace kube-lego <span class="se">\
</span><span class="se"></span>    --replicas<span class="o">=</span><span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div><p>You can then verify your kube-lego pod is no longer running with:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get pods --namespace kube-lego
</code></pre></td></tr></table>
</div>
</div><h5 id="2-deploy-cert-manager">2. Deploy cert-manager</h5>
<p>cert-manager should be deployed using Helm, according to our official <a href="https://cert-manager.readthedocs.io/en/latest/getting-started/index.html" target="_blank" rel="noopener noreffer">getting-started</a> guide. No special steps are required here. We will return to this deployment at the end of this guide and perform an upgrade of some of the CLI flags we deploy cert-manager with however.</p>
<p>Please take extra care to ensure you have configured RBAC correctly when deploying Helm and cert-manager - there are some nuances described in our deploying document!</p>
<h5 id="3-obtaining-your-acme-account-private-key">3. Obtaining your ACME account private key</h5>
<p>In order to continue issuing and renewing certificates on your behalf, we need to migrate the user account private key that kube-lego has created for you over to cert-manager.</p>
<p>Your ACME user account identity is a private key, stored in a secret resource. By default, kube-lego will store this key in a secret named <code>kube-lego-account</code> in the same namespace as your kube-lego Deployment. You may have overridden this value when you deploy kube-lego, in which case the secret name to use will be the value of the <code>LEGO_SECRET_NAME</code> environment variable.</p>
<p>You should download a copy of this secret resource and save it in your local directory:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get secret kube-lego-account -o yaml <span class="se">\
</span><span class="se"></span>    --namespace kube-lego <span class="se">\
</span><span class="se"></span>    --export &gt; kube-lego-account.yaml
</code></pre></td></tr></table>
</div>
</div><p>Once saved, open up this file and change the <code>metadata.name</code> field to something more relevant to cert-manager. For the rest of this guide, we&rsquo;ll assume you chose <code>letsencrypt-private-key</code>.</p>
<p>Once done, we need to create this new resource in the <code>kube-system</code> namespace. <strong>By default, cert-manager stores supporting resources for ClusterIssuers in the namespace that it is running in</strong>, and we used <code>kube-system</code> when deploying cert-manager above. You should change this if you have deployed cert-manager into a different namespace.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl create -f kube-lego-account.yaml <span class="se">\
</span><span class="se"></span>    --namespace kube-system
</code></pre></td></tr></table>
</div>
</div><h5 id="4-creating-an-acme-clusterissuer-using-your-old-acme-account">4. Creating an ACME ClusterIssuer using your old ACME account</h5>
<p>We need to create a ClusterIssuer which will hold information about the ACME account previously registered via kube-lego. In order to do so, we need two more pieces of information from our old kube-lego deployment: the server URL of the ACME server, and the email address used to register the account.</p>
<p>Both of these bits of information are stored within the kube-lego ConfigMap.</p>
<p>To retrieve them, you should be able to <code>get</code> the ConfigMap using <code>kubectl</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get configmap kube-lego -o yaml <span class="se">\
</span><span class="se"></span>    --namespace kube-lego <span class="se">\
</span><span class="se"></span>    --export
</code></pre></td></tr></table>
</div>
</div><p>Your email address should be shown under the <code>.data.lego.email</code> field, and the ACME server URL under <code>.data.lego.url</code>.</p>
<p>For the purposes of this guide, we will assume the lego email is <code>user@example.com</code> and the URL <code>https://acme-staging-v02.api.letsencrypt.org/directory</code>.</p>
<p>Now that we have migrated our private key to the new Secret resource, as well as obtaining our ACME email address and URL, we can create a ClusterIssuer resource!</p>
<p>Create a file named <code>cluster-issuer.yaml</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># Adjust the name here accordingly</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># The ACME server URL</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="w">
</span><span class="w">    </span><span class="c"># Email address used for ACME registration</span><span class="w">
</span><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">user@example.com</span><span class="w">
</span><span class="w">    </span><span class="c"># Name of a secret used to store the ACME account private key from step 3</span><span class="w">
</span><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-private-key</span><span class="w">
</span><span class="w">    </span><span class="c"># Enable the HTTP-01 challenge provider</span><span class="w">
</span><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>We then submit this file to our Kubernetes cluster:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl create -f cluster-issuer.yaml
</code></pre></td></tr></table>
</div>
</div><p>You should be able to verify the ACME account has been verified successfully:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe clusterissuer letsencrypt-staging
...
Status:
    Acme:
    Uri:  https://acme-staging-v02.api.letsencrypt.org/acme/acct/7571319
    Conditions:
    Last Transition Time:  2019-01-30T14:52:03Z
    Message:               The ACME account was registered with the ACME server
    Reason:                ACMEAccountRegistered
    Status:                True
    Type:                  Ready
</code></pre></td></tr></table>
</div>
</div><h5 id="5-configuring-ingress-shim-to-use-our-new-clusterissuer-by-default">5. Configuring ingress-shim to use our new ClusterIssuer by default</h5>
<p>Now that our ClusterIssuer is ready to issue certificates, we have one last thing to do: we must reconfigure ingress-shim (deployed as part of cert-manager) to automatically create Certificate resources for all Ingress resources it finds with appropriate annotations.</p>
<p>More information on the role of <code>ingress-shim</code> can be found <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuing-certificates/ingress-shim.html" target="_blank" rel="noopener noreffer">in the docs</a>, but for now we can just run a <code>helm upgrade</code> in order to add a few additional flags. Assuming you&rsquo;ve named your ClusterIssuer <code>letsencrypt-staging</code> (as above), run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">helm upgrade cert-manager <span class="se">\
</span><span class="se"></span>    jetstack/cert-manager <span class="se">\
</span><span class="se"></span>    --namespace kube-system <span class="se">\
</span><span class="se"></span>    --set ingressShim.defaultIssuerName<span class="o">=</span>letsencrypt-staging <span class="se">\
</span><span class="se"></span>    --set ingressShim.defaultIssuerKind<span class="o">=</span>ClusterIssuer
</code></pre></td></tr></table>
</div>
</div><p>You should see the cert-manager pod be re-created, and once started it should automatically create Certificate resources for all of your ingresses that previously had kube-lego enabled.</p>
<h5 id="6-verify-each-ingress-now-has-a-corresponding-certificate">6. Verify each ingress now has a corresponding Certificate</h5>
<p>Before we finish, we should make sure there is now a Certificate resource for each ingress resource you previously enabled kube-lego on.</p>
<p>You should be able to check this by running:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get certificates --all-namespaces
</code></pre></td></tr></table>
</div>
</div><p>There should be an entry for each ingress in your cluster with the kube-lego annotation.</p>
<p>We can also verify that cert-manager has &lsquo;adopted&rsquo; the old TLS certificates by viewing the logs for cert-manager:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl logs -n kube-system -l <span class="nv">app</span><span class="o">=</span>cert-manager -c cert-manager
...
I1025 21:54:02.869269       <span class="m">1</span> sync.go:206<span class="o">]</span> Certificate my-example-certificate scheduled <span class="k">for</span> renewal in <span class="m">292</span> hours
</code></pre></td></tr></table>
</div>
</div><p>Here we can see cert-manager has verified the existing TLS certificate and scheduled it to be renewed in 292h time.</p>
<h3 id="securing-ingresses-with-venafi">Securing Ingresses with Venafi</h3>
<p>This guide walks you through how to secure a Kubernetes <a href="https://cert-manager.readthedocs.io/en/latest/tutorials/venafi/securing-ingress.html#id1" target="_blank" rel="noopener noreffer">Ingress</a> resource
using the Venafi Issuer type.</p>
<p>Whilst stepping through, you will learn how to:</p>
<ul>
<li>Create an EKS cluster using <a href="https://github.com/weaveworks/eksctl" target="_blank" rel="noopener noreffer">eksctl</a></li>
<li>Install cert-manager into the EKS cluster</li>
<li>Deploy <a href="https://cert-manager.readthedocs.io/en/latest/tutorials/venafi/securing-ingress.html#id3" target="_blank" rel="noopener noreffer">nginx-ingress</a> to expose applications running in the cluster</li>
<li>Configure a Venafi Cloud issuer</li>
<li>Configure cert-manager to secure your application traffic</li>
</ul>
<p>While this guide focuses on EKS(Amazon Elastic Kubernetes Service) as a Kubernetes provisioner and Venafi as a Certificate issuer, the steps here should be generally re-usable for other Issuer types.</p>
<h4 id="prerequisites">Prerequisites</h4>
<ul>
<li>An AWS account</li>
<li>kubectl installed</li>
<li>Access to a publicly registered DNS zone</li>
<li>A Venafi Cloud account and API credentials</li>
</ul>
<h4 id="create-an-eks-cluster">Create an EKS cluster</h4>
<p>If you already have a running EKS cluster you can skip this step and move onto deploying cert-manager.</p>
<p><a href="https://github.com/weaveworks/eksctl" target="_blank" rel="noopener noreffer">eksctl</a> is a tool that makes it easier to deploy and manage an EKS cluster.</p>
<p>Installation instructions for various platforms can be found in the <a href="https://eksctl.io/introduction/installation/" target="_blank" rel="noopener noreffer">eksctl installation instructions</a>.</p>
<p>Once installed, you can create a basic cluster by running:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">eksctl create cluster
</code></pre></td></tr></table>
</div>
</div><p>This process may take up to 20 minutes to complete. Complete instructions on using eksctl can be found in the <a href="https://eksctl.io/usage/creating-and-managing-clusters/" target="_blank" rel="noopener noreffer">eksctl usage section</a>.</p>
<p>Once your cluster has been created, you should verify that your cluster is running correctly by running the following command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get pods --all-namespaces
NAME                      READY   STATUS    RESTARTS   AGE
aws-node-8xpkp            1/1     Running   <span class="m">0</span>          115s
aws-node-tflxs            1/1     Running   <span class="m">0</span>          118s
coredns-694d9447b-66vlp   1/1     Running   <span class="m">0</span>          23s
coredns-694d9447b-w5bg8   1/1     Running   <span class="m">0</span>          23s
kube-proxy-4dvpj          1/1     Running   <span class="m">0</span>          115s
kube-proxy-tpvht          1/1     Running   <span class="m">0</span>          118s
</code></pre></td></tr></table>
</div>
</div><p>You should see output similar to the above, with all pods in a Running state.</p>
<h4 id="installing-cert-manager">Installing cert-manager</h4>
<p>There are no special requirements to note when installing cert-manager on EKS, so the regular <a href="https://cert-manager.readthedocs.io/en/latest/getting-started/install/kubernetes.html" target="_blank" rel="noopener noreffer">Running on Kubernetes</a> guide can be used to install cert-manager.</p>
<p>Please walk through the installation guide and return to this step once you have validated cert-manager is deployed correctly.</p>
<h4 id="installing-ingress-nginx">Installing ingress-nginx</h4>
<p>A <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener noreffer">Kubernetes ingress controller</a> is designed to be the access point for HTTP and HTTPS traffic to the software running within your cluster. The <a href="https://cert-manager.readthedocs.io/en/latest/tutorials/venafi/securing-ingress.html#id5" target="_blank" rel="noopener noreffer">ingress-nginx</a> controller does this by providing an HTTP proxy service supported by your cloud provider&rsquo;s load balancer (in this case, a <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/network/introduction.html" target="_blank" rel="noopener noreffer">Network Load Balancer (NLB)</a>.</p>
<p>You can get more details about nginx-ingress and how it works from the <a href="https://kubernetes.github.io/ingress-nginx/" target="_blank" rel="noopener noreffer">documentation for nginx-ingress</a>.</p>
<p>To deploy ingress-nginx using an ELB to expose the service, run the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Deploy the AWS specific pre-requisite manifest</span>
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/aws/service-nlb.yaml

<span class="c1"># Deploy the &#39;generic&#39; ingress-nginx manifest</span>
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml
</code></pre></td></tr></table>
</div>
</div><p>You may have to wait up to 5 minutes for all the required components in your cluster and AWS account to become ready.</p>
<p>You can run the following command to determine the address that Amazon has assigned to your NLB:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get service -n ingress-nginx
NAME            TYPE           CLUSTER-IP      EXTERNAL-IP                                                                     PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
ingress-nginx   LoadBalancer   10.100.52.175   a8c2870a5a8a311e9a9a10a2e7af57d7-6c2ec8ede48726ab.elb.eu-west-1.amazonaws.com   80:31649/TCP,443:30567/TCP   4m10s
</code></pre></td></tr></table>
</div>
</div><p>The <em>EXTERNAL-IP</em> field may say <code>&lt;pending&gt;</code> for a while. This indicates the NLB is still being created. Retry the command until an <em>EXTERNAL-IP</em> has been provisioned.</p>
<p>Once the <em>EXTERNAL-IP</em> is available, you should run the following command to verify that traffic is being correctly routed to ingress-nginx:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">curl http://a8c2870a5a8a311e9a9a10a2e7af57d7-6c2ec8ede48726ab.elb.eu-west-1.amazonaws.com/

&lt;html&gt;
&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;openresty/1.15.8.1&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></td></tr></table>
</div>
</div><p>Whilst the above message would normally indicate an error (the page not being found), in this instance it indicates that traffic is being correctly routed to the ingress-nginx service.</p>
<blockquote>
<p><strong>note</strong>:
Although the AWS Application Load Balancer (ALB) is a modern load balancer offered by AWS that can can be provisioned from within EKS, at the time of writing, the <a href="https://github.com/kubernetes-sigs/aws-alb-ingress-controller" target="_blank" rel="noopener noreffer">alb-ingress-controller</a> is only capable of serving sites using certificates stored in AWS Certificate Manager (ACM). Version 1.15 of Kubernetes should address multiple bug fixes for this controller and allow for TLS termination support.</p>
</blockquote>
<h4 id="configure-your-dns-records">Configure your DNS records</h4>
<p>Now that our NLB has been provisioned, we should point our application&rsquo;s DNS records at the NLBs address.</p>
<p>Go into your DNS provider&rsquo;s console and set a CNAME record pointing to your NLB.</p>
<p>For the purposes of demonstration, we will assume in this guide you have created the following DNS entry:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">example.com CNAME a8c2870a5a8a311e9a9a10a2e7af57d7-6c2ec8ede48726ab.elb.eu-west-1.amazonaws.com
</code></pre></td></tr></table>
</div>
</div><p>As you progress through the rest of this tutorial, please replace <code>example.com</code> with your own registered domain.</p>
<h4 id="deploying-a-demo-application">Deploying a demo application</h4>
<p>For the purposes of this demo, we provide an example deployment which is a simple &ldquo;hello world&rdquo; website.</p>
<p>First, create a new namespace that will contain your application:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create namespace demo
namespace/demo created
</code></pre></td></tr></table>
</div>
</div><p>Save the following YAML into a file named <code>demo-deployment.yaml</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hello-kubernetes</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">    </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">hello-kubernetes</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hello-kubernetes</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">    </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">hello-kubernetes</span><span class="w">
</span><span class="w">    </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">hello-kubernetes</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hello-kubernetes</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">paulbouwer/hello-kubernetes:1.5</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">100Mi</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Then run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -n demo -f demo-deployment.yaml
</code></pre></td></tr></table>
</div>
</div><p>Note that the Service resource we deploy is of type ClusterIP and not LoadBalancer, as we will expose and secure traffic for this service using ingress-nginx that we deployed earlier.</p>
<p>You should be able to see two Pods and one Service in the <code>demo</code> namespace:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get po,svc -n demo
NAME                                READY   STATUS    RESTARTS   AGE
hello-kubernetes-66d45d6dff-m2lnr   1/1     Running   <span class="m">0</span>          7s
hello-kubernetes-66d45d6dff-qt2kb   1/1     Running   <span class="m">0</span>          7s

NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
service/hello-kubernetes   ClusterIP   10.100.164.58   &lt;none&gt;        80/TCP    7s
</code></pre></td></tr></table>
</div>
</div><p>Note that we have not yet exposed this application to be accessible over the internet. We will expose the demo application to the internet in later steps.</p>
<h4 id="creating-a-venafi-issuer-resource">Creating a Venafi Issuer resource</h4>
<p>cert-manager supports both <code>Venafi TPP</code> and <code>Venafi Cloud</code>.</p>
<p>Please only follow one of the below sections according to where you want to retrieve your Certificates from.</p>
<h5 id="venafi-tpp">Venafi TPP</h5>
<p>Assuming you already have a Venafi TPP server set up properly, you can create a Venafi Issuer resource that can be used to issue certificates.</p>
<p>To do this, you need to make sure you have your TPP <em>username</em> and <em>password</em>.</p>
<p>In order for cert-manager to be able to authenticate with your Venafi TPP server and set up an Issuer resource, you&rsquo;ll need to create a Kubernetes Secret containing your username and password:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create secret generic <span class="se">\
</span><span class="se"></span>    venafi-tpp-secret <span class="se">\
</span><span class="se"></span>    --namespace<span class="o">=</span>demo <span class="se">\
</span><span class="se"></span>    --from-literal<span class="o">=</span><span class="nv">username</span><span class="o">=</span><span class="s1">&#39;YOUR_TPP_USERNAME_HERE&#39;</span> <span class="se">\
</span><span class="se"></span>    --from-literal<span class="o">=</span><span class="nv">password</span><span class="o">=</span><span class="s1">&#39;YOUR_TPP_PASSWORD_HERE&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>We must then create a Venafi Issuer resource, which represents a certificate authority within Kubernetes.</p>
<p>Save the following YAML into a file named <code>venafi-issuer.yaml</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">venafi-issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">venafi</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Default&#34;</span><span class="w"> </span><span class="c"># Set this to the Venafi policy zone you want to use</span><span class="w">
</span><span class="w">    </span><span class="nt">tpp</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">https://venafi-tpp.example.com/vedsdk</span><span class="w"> </span><span class="c"># Change this to the URL of your TPP instance</span><span class="w">
</span><span class="w">        </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;base64 encoded string of caBundle PEM file, or empty to use system root CAs&gt;</span><span class="w">
</span><span class="w">        </span><span class="nt">credentialsRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">venafi-tpp-secret</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Then run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -n demo -f venafi-issuer.yaml
</code></pre></td></tr></table>
</div>
</div><p>When you run the following command, you should see that the Status stanza of the output shows that the Issuer is Ready (i.e. has successfully validated itself with the Venafi TPP server).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl describe issuer -n demo venafi-issuer

Status:
    Conditions:
    Last Transition Time:  2019-07-17T15:46:00Z
    Message:               Venafi issuer started
    Reason:                Venafi issuer started
    Status:                True
    Type:                  Ready
Events:
    Type    Reason  Age   From          Message
    ----    ------  ----  ----          -------
    Normal  Ready   14s   cert-manager  Verified issuer with Venafi server
</code></pre></td></tr></table>
</div>
</div><h5 id="venafi-cloud">Venafi Cloud</h5>
<p>You can sign up for a Venafi Cloud account by visiting the <a href="https://www.venafi.com/platform/cloud/devops" target="_blank" rel="noopener noreffer">enroll page</a>.</p>
<p>Once registered, you should fetch your API key by clicking your name in the top right of the control panel interface.</p>
<p>In order for cert-manager to be able to authenticate with your Venafi Cloud account and set up an Issuer resource, you&rsquo;ll need to create a Kubernetes Secret containing your API key:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create secret generic <span class="se">\
</span><span class="se"></span>    venafi-cloud-secret <span class="se">\
</span><span class="se"></span>    --namespace<span class="o">=</span>demo <span class="se">\
</span><span class="se"></span>    --from-literal<span class="o">=</span><span class="nv">apikey</span><span class="o">=</span>&lt;API_KEY&gt;
</code></pre></td></tr></table>
</div>
</div><p>We must then create a Venafi Issuer resource, which represents a certificate authority within Kubernetes.</p>
<p>Save the following YAML into a file named <code>venafi-issuer.yaml</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">venafi-issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">venafi</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Default&#34;</span><span class="w"> </span><span class="c"># Set this to the Venafi policy zone you want to use</span><span class="w">
</span><span class="w">    </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://api.venafi.cloud/v1&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">apiTokenSecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">venafi-cloud-secret</span><span class="w">
</span><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">apikey</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Then run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -n demo -f venafi-issuer.yaml
</code></pre></td></tr></table>
</div>
</div><p>When you run the following command, you should see that the Status stanza of the output shows that the Issuer is Ready (i.e. has successfully validated itself with the Venafi Cloud service).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl describe issuer -n demo venafi-issuer

Status:
    Conditions:
    Last Transition Time:  2019-07-17T15:46:00Z
    Message:               Venafi issuer started
    Reason:                Venafi issuer started
    Status:                True
    Type:                  Ready
Events:
    Type    Reason  Age   From          Message
    ----    ------  ----  ----          -------
    Normal  Ready   14s   cert-manager  Verified issuer with Venafi server
</code></pre></td></tr></table>
</div>
</div><h4 id="request-a-certificate">Request a Certificate</h4>
<p>Now that the Issuer is configured and we have confirmed it has been set up correctly, we can begin requesting certificates which can be used by Kubernetes applications.</p>
<p>Full information on how to specify and request Certificate resources can be found in the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuing-certificates/index.html" target="_blank" rel="noopener noreffer">Issuing certificates</a> guide.</p>
<p>For now, we will create a basic x509 Certificate that is valid for our domain, <code>example.com</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-com-tls</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">example-com-tls</span><span class="w">
</span><span class="w">    </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">venafi-issuer</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Save this YAML into a file named <code>example-com-tls.yaml</code> and run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -n demo -f example-com-tls.yaml
</code></pre></td></tr></table>
</div>
</div><p>As long as you&rsquo;ve ensured that the zone of your Venafi Cloud account (in our example, we use the &ldquo;Default&rdquo; zone) has been configured with a CA or contains a custom certificate, cert-manager can now take steps to populate the <code>example-com-tls</code> Secret with a certificate. It does this by identifying itself with Venafi Cloud using the API key, then requesting a certificate to match the specifications of the Certificate resource that we&rsquo;ve created.</p>
<p>You can run <code>kubectl describe</code> to check the progress of your Certificate:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl describe certificate -n demo example-com-tls

...
Status:
    Conditions:
    Last Transition Time:  2019-07-17T17:43:01Z
    Message:               Certificate is up to date and has not expired
    Reason:                Ready
    Status:                True
    Type:                  Ready
    Not After:               2019-10-15T12:00:00Z
Events:
    Type    Reason       Age   From          Message
    ----    ------       ----  ----          -------
    Normal  Issuing      33s   cert-manager  Requesting new certificate...
    Normal  GenerateKey  33s   cert-manager  Generated new private key
    Normal  Validate     33s   cert-manager  Validated certificate request against Venafi zone policy
    Normal  Requesting   33s   cert-manager  Requesting certificate from Venafi server...
    Normal  Retrieve     15s   cert-manager  Retrieved certificate from Venafi server
    Normal  CertIssued   15s   cert-manager  Certificate issued successfully
</code></pre></td></tr></table>
</div>
</div><p>Once the Certificate has been issued, you should see events similar to above.</p>
<p>You should then be able to see the certificate has been successfully stored in the Secret resource:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get secret -n demo example-com-tls

NAME              TYPE                DATA   AGE
example-com-tls   kubernetes.io/tls   <span class="m">3</span>      2m47s

kubectl get secret example-com-tls -o <span class="s1">&#39;go-template={{index .data &#34;tls.crt&#34;}}&#39;</span> <span class="p">|</span> <span class="se">\
</span><span class="se"></span>    base64 --decode <span class="p">|</span> <span class="se">\
</span><span class="se"></span>    openssl x509 -noout -text

Certificate:
    Data:
        Version: <span class="m">3</span> <span class="o">(</span>0x2<span class="o">)</span>
        Serial Number:
            0d:ce:bf:89:04:d4:41:83:f4:4c:32:66:64:fb:60:14
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: <span class="nv">C</span><span class="o">=</span>US, <span class="nv">O</span><span class="o">=</span>DigiCert Inc, <span class="nv">CN</span><span class="o">=</span>DigiCert Test SHA2 Intermediate CA-1
        Validity
            Not Before: Jul <span class="m">17</span> 00:00:00 <span class="m">2019</span> GMT
            Not After : Oct <span class="m">15</span> 12:00:00 <span class="m">2019</span> GMT
        Subject: <span class="nv">C</span><span class="o">=</span>US, <span class="nv">ST</span><span class="o">=</span>California, <span class="nv">L</span><span class="o">=</span>Palo Alto, <span class="nv">O</span><span class="o">=</span>Venafi Cloud, <span class="nv">OU</span><span class="o">=</span>SerialNumber, <span class="nv">CN</span><span class="o">=</span>example.com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: <span class="o">(</span><span class="m">2048</span> bit<span class="o">)</span>
                Modulus:
                    00:ad:2e:66:02:20:c9:b1:6a:00:63:70:4e:22:3c:
                    45:63:6e:e7:fd:4c:94:7d:75:50:22:a2:01:72:99:
                    9c:23:04:90:51:85:4d:47:32:e4:8b:ee:b1:ea:09:
                    1a🇩🇪97:5d:31:05:a2:73:73:4f:06:a3:b2:59:ee:
                    bc:30:f7:26:85:3d:b3:56:e4:c2:97:34:b6:ac:6d:
                    65:7e:a2:4e:b4:ce:f2:0a:0a:4c:d7:32:d7:5a:18:
                    e8:69:c6:34:28:26:36:ef:c5:bc:ae:ba:ca:d2:46:
                    3f:d4:61:39:66:8f:19:cc:d6:d6:10:77:af:51:93:
                    1b:4d:f8:d1:10:19:ab:ac:b3:7b:0b:98:58:29:e6:
                    a9:ac:9f:7a:dc:63:0d:51:f5:bd:9f:f3:03:2e:b3:
                    2d:2f:00:87:f4:e1:cd:5a:32:c6:d8:fb:49:c4:e7:
                    da:3f:0f:8f:bb:66:94:28:5d:99:fe:7c:f0:17:1b:
                    fd:3e:ed:dd:36:bf:8e:62:60:0c:85:7f:76:74:4b:
                    37:d9:c2:e8:74:49:04:bf:f1:83:81:cc:4f:9b:f3:
                    40:97:d4:dc:b6:d3:2d:dc:73:18:93:48:a5:8f:6c:
                    57:7f:ec:62:c0:bc:c2:b0:e9:0a:51:2d:c4:b6:87:
                    68:96:87:f8:9a:86:3c:6a:f1:01:ca:57:c4:07:e7:
                    b0:51
                Exponent: <span class="m">65537</span> <span class="o">(</span>0x10001<span class="o">)</span>
        X509v3 extensions:
            X509v3 Authority Key Identifier:
                keyid:D6:4D:F9:39:60:6C:73:C3:22:F5:AD:30:0C:2F:A0:D5:CA:75:4A:2A

            X509v3 Subject Key Identifier:
                A3:B3:47:2C:41:5E:9C:B2:27:97:57:14:A4:2E:BA:8C:93:E7:01:65
            X509v3 Subject Alternative Name:
                DNS:example.com
            X509v3 Key Usage: critical
                Digital Signature, Key Encipherment
            X509v3 Extended Key Usage:
                TLS Web Server Authentication, TLS Web Client Authentication
            X509v3 CRL Distribution Points:

                Full Name:
                    URI:http://crl3.digicert.com/DigiCertTestSHA2IntermediateCA1.crl

                Full Name:
                    URI:http://crl4.digicert.com/DigiCertTestSHA2IntermediateCA1.crl

            X509v3 Certificate Policies:
                Policy: 2.16.840.1.114412.1.1
                    CPS: https://www.digicert.com/CPS

            Authority Information Access:
                OCSP - URI:http://ocsp.digicert.com
                CA Issuers - URI:http://cacerts.test.digicert.com/DigiCertTestSHA2IntermediateCA1.crt

            X509v3 Basic Constraints: critical
                CA:FALSE
    Signature Algorithm: sha256WithRSAEncryption
        ae:d4:9c:8a:66:19:9e:7d:12:b7:05:c2:b6:33:b3:9c:a5:40:
        47🆎34:8d:1b:0f:51:96:de:e9:46:5a:e4:16:10:43:56:bf:
        fa:f8:64:f4:cb:53:39:5b:45:ca:7f:15:d9:59:25:21:23:c4:
        4d:dc:a7:f7:83:21:d2:3f:a8:0a:26:f4:ef:fa:1b:2b:7d:97:
        7e:28:f3:ca:cd:b2:c4:92:f3:92:27:7f:e0:f1:ac:d6:db:4c:
        10:8a:f8:6f:09:bb:b3:4f:19:06:aa:bb:74:1c:e0:51:42:f6:
        8c:7d:77:f7:80:a4:03🆎a9:ae:ae:2b:89:17:af:2f:eb:f7:
        3d:61:7c:dd:e1:5d:d2:5a:c5:6a:f6:c8:92:4c:0a:b5:75:d1:
        dd:39:f2:a7:a2:10:8c:6d:bf:ca:08:ad:b9:a9:df:e3:59:8f:
        64:16:3c:7e:8a:6e:27:fc:49:d7:06:f0:bd:94:15:f2:fd:0f:
        94:8a:b8:73:67:73:53:22:df:9d:36:e9:34:f9:2a:68:00:59:
        78:6d:2d:8f:a0:0f:13:af:bd:b3:aa:8c:37:c4:22:cf:23:fb:
        56:bc:4e:55:ae:3a:0a:e6:3e:b1:1a:22:71:7b:08:b8:00:41:
        14:26:f6:9b:9b:72:3f:eb:dc:dd:1b:db:a8:20:fd:54:75:ae:
        25:7f:80:e6
</code></pre></td></tr></table>
</div>
</div><p>In the next step, we&rsquo;ll configure your application to actually use this new Certificate resource.</p>
<h3 id="exposing-and-securing-your-application">Exposing and securing your application</h3>
<p>Now that we have issued a Certificate, we can expose our application using a Kubernetes Ingress resource.</p>
<p>Create a file named <code>application-ingress.yaml</code> and save the following in it, replacing <code>example.com</code> with your own domain name:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">frontend-ingress</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">example-com-tls</span><span class="w">
</span><span class="w">    </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">hello-kubernetes</span><span class="w">
</span><span class="w">            </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>You can then apply this resource with:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -n demo -f application-ingress.yaml
</code></pre></td></tr></table>
</div>
</div><p>Once this has been created, you should be able to visit your application at the configured hostname, here <code>example.com</code>!</p>
<p>Navigate to the address in your web browser and you should see the certificate obtained via Venafi being used to secure application traffic.</p>
<h2 id="tasks">Tasks</h2>
<p>This section contains guides on using specific features of cert-manager, such as configuring different Issuer types and any special settings that you may want to configure.</p>
<h3 id="setting-up-issuers">Setting up Issuers</h3>
<p>Before you can begin issuing certificates, you must configure at least one Issuer or ClusterIssuer resource in your cluster.</p>
<p>These represent a certificate authority from which signed x509 certificates can be obtained, such as <code>Let's Encrypt</code>, or <code>your own signing key pair stored in a Kubernetes Secret resource</code>. They are referenced by Certificate resources in order to request certificates from them.</p>
<p>An <a href="https://cert-manager.readthedocs.io/en/latest/reference/issuers.html" target="_blank" rel="noopener noreffer">Issuer</a> is scoped to a single namespace, and can only fulfill(履行，落实) <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html" target="_blank" rel="noopener noreffer">Certificate</a> resources within its own namespace. This is useful in a multi-tenant(多租户) environment where multiple teams or independent parties operate within a single cluster.</p>
<p>On the other hand, a <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html" target="_blank" rel="noopener noreffer">ClusterIssuer</a> is a cluster wide version of an <a href="https://cert-manager.readthedocs.io/en/latest/reference/issuers.html" target="_blank" rel="noopener noreffer">Issuer</a>. It is able to be referenced by <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html" target="_blank" rel="noopener noreffer">Certificate</a> resources in any namespace.</p>
<p>Users often create <code>letsencrypt-staging</code> and <code>letsencrypt-prod</code> <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html" target="_blank" rel="noopener noreffer">ClusterIssuers</a> if they operate a single-tenant environment and want to expose a cluster-wide mechanism for obtaining TLS certificates from <a href="https://letsencrypt.org/" target="_blank" rel="noopener noreffer">Let&rsquo;s Encrypt</a>.</p>
<h4 id="supported-issuer-types">Supported issuer types</h4>
<p>cert-manager supports a number of different issuer backends, each with their own different types of configuration.</p>
<p>Please follow one of the below linked guides to learn how to set up the issuer types you require:</p>
<ul>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-ca.html" target="_blank" rel="noopener noreffer">CA</a> - issue certificates signed by a X509 signing keypair, stored in a Secret in the Kubernetes API server.</li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-selfsigned.html" target="_blank" rel="noopener noreffer">Self signed</a> - issue self signed certificates.</li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/index.html" target="_blank" rel="noopener noreffer">ACME</a> - issue certificates obtained by performing challenge validations against an ACME server such as <a href="https://letsencrypt.org" target="_blank" rel="noopener noreffer">Let&rsquo;s Encrypt</a>.</li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-vault.html" target="_blank" rel="noopener noreffer">Vault</a> - issue certificates from a Vault instance configured with the <a href="https://www.vaultproject.io/docs/secrets/pki/index.html" target="_blank" rel="noopener noreffer">Vault PKI backend</a>.</li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-venafi.html" target="_blank" rel="noopener noreffer">Venafi</a> - issue certificates from a <a href="https://venafi.com" target="_blank" rel="noopener noreffer">Venafi</a> Cloud or Trust Protection Platform instance.</li>
</ul>
<h4 id="additional-information">Additional information</h4>
<p>There are a few key things to know about Issuers, but for full information
you can refer to the <a href="https://cert-manager.readthedocs.io/en/latest/reference/issuers.html" target="_blank" rel="noopener noreffer">Issuer reference docs</a>.</p>
<h5 id="difference-between-issuers-and-clusterissuers">Difference between Issuers and ClusterIssuers</h5>
<p><strong>ClusterIssuers</strong> are a resource type similar to <a href="https://cert-manager.readthedocs.io/en/latest/reference/issuers.html" target="_blank" rel="noopener noreffer">Issuers</a>. They are specified in exactly the same way, but they do not belong to a single namespace and can be referenced by Certificate resources from multiple different namespaces.</p>
<p>They are particularly useful when you want to provide the ability to obtain certificates from a central authority (e.g. Letsencrypt, or your internal CA) and you run single-tenant clusters.</p>
<p>The resource spec is identical, and you should set the <code>certificate.spec.issuerRef.kind</code> field to <code>ClusterIssuer</code> when creating your Certificate resources.</p>
<h4 id="setting-up-acme-issuers">Setting up ACME Issuers</h4>
<p>The ACME Issuer type represents a single Account registered with the ACME server.</p>
<p>When you create a new ACME Issuer, cert-manager will generate a private key which is used to identify you with the ACME server.</p>
<p>To set up a basic ACME issuer, you should create a new <code>Issuer</code> or <code>ClusterIssuer</code> resource.</p>
<p>You should read the guides linked at the bottom of this page to learn more about the ACME challenge validation mechanisms that cert-manager supports and how to configure the various DNS01 provider implementations.</p>
<h5 id="creating-a-basic-acme-issuer">Creating a basic ACME Issuer</h5>
<p>The below example configures a ClusterIssuer named <code>letsencrypt-staging</code> that is configured to HTTP01 challenge solving with configuration suitable for ingress controllers such as <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/index.html#id1" target="_blank" rel="noopener noreffer">ingress-nginx</a>.</p>
<p>You should copy and paste this example into a new file named <code>letsencrypt-staging.yaml</code> and update the <code>spec.acme.email</code> field to be your own email address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># You must replace this email address with your own.</span><span class="w">
</span><span class="w">    </span><span class="c"># Let&#39;s Encrypt will use this to contact you about expiring</span><span class="w">
</span><span class="w">    </span><span class="c"># certificates, and issues related to your account.</span><span class="w">
</span><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">user@example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="w">
</span><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># Secret resource used to store the account&#39;s private key.</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-issuer-account-key</span><span class="w">
</span><span class="w">    </span><span class="c"># Add a single challenge solver, HTTP01 using nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>You can then create this resource using <code>kubectl apply</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f letsencrypt-staging.yaml
</code></pre></td></tr></table>
</div>
</div><p>To verify that the account has been registered successfully, you can run <code>kubectl describe</code> and check the &lsquo;Ready&rsquo; condition:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl describe clusterissuer letsencrypt-staging
...
Status:
    Acme:
    Uri:  https://acme-staging-v02.api.letsencrypt.org/acme/acct/7571319
    Conditions:
    Last Transition Time:  2019-01-30T14:52:03Z
    Message:               The ACME account was registered with the ACME server
    Reason:                ACMEAccountRegistered
    Status:                True
    Type:                  Ready
</code></pre></td></tr></table>
</div>
</div><p>Any Certificate you create that references this Issuer resource will use the HTTP01 challenge solver you have configured above.</p>
<blockquote>
<p><strong>note</strong>:
<strong>Let&rsquo;s Encrypt does not support issuing wildcard certificates with HTTP-01 challenges. To issue wildcard certificates, you must use the DNS-01 challenge.</strong></p>
</blockquote>
<h5 id="adding-multiple-solver-types">Adding multiple solver types</h5>
<p>You may want to use different types of challenge solver configuration for different ingress controllers, for example if you want to issue wildcard certificates using DNS01 alongside other certificates that are validated using HTTP01.</p>
<p>The <code>solvers</code> stanza has an optional <code>selector</code> field, that can be used to specify which Certificates, and further, what DNS names <strong>on those certificates</strong> should be used to solve challenges.</p>
<p>For example, to configure HTTP01 using nginx ingress as the default solver, along with a DNS01 solver that can be used for wildcard certificates:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="l">...</span><span class="w">
</span><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span>- <span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">use-cloudflare-solver</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">dns01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">cloudflare</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">user@example.com</span><span class="w">
</span><span class="w">            </span><span class="nt">apiKeySecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloudflare-apikey-secret</span><span class="w">
</span><span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">apikey</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>In order to utilise the configured cloudflare DNS01 solver, you must add the <code>use-cloudflare-solver: &quot;true&quot;</code> label to your Certificate resources.</p>
<h6 id="using-multiple-solvers-for-a-single-certificate">Using multiple solvers for a single certificate</h6>
<p>The solver&rsquo;s <code>selector</code> stanza has an additional field <code>dnsNames</code> that further refines the set of domains that the solver configuration applies to.</p>
<p>If any <code>dnsNames</code> are specified, then that challenge solver will be used if the domain being validated is named in that list.</p>
<p>For example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="l">...</span><span class="w">
</span><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span>- <span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="s1">&#39;*.example.com&#39;</span><span class="w">
</span><span class="w">        </span><span class="nt">dns01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">cloudflare</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">user@example.com</span><span class="w">
</span><span class="w">            </span><span class="nt">apiKeySecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloudflare-apikey-secret</span><span class="w">
</span><span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">apikey</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>In this instance, a Certificate that specified both <code>*.example.com</code> and <code>example.com</code> would use the HTTP01 challenge solver for <code>example.com</code> and the DNS01 challenge solver for <code>*.example.com</code>.</p>
<p>It is possible to specify both <code>matchLabels</code> AND <code>dnsNames</code> on an ACME solver selector.</p>
<h5 id="configuring-http01-ingress-provider">Configuring HTTP01 Ingress Provider</h5>
<p>This page contains details on the different options available on the <code>Issuer</code> resource&rsquo;s HTTP01 challenge solver configuration.</p>
<p>For more information on configuring ACME issuers and their API format, read the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/index.html" target="_blank" rel="noopener noreffer">Setting up ACME Issuers</a> documentation.</p>
<h6 id="how-http01-validations-work">How HTTP01 validations work</h6>
<p>You can read about how the HTTP01 challenge type works on the <a href="https://letsencrypt.org/docs/challenge-types/#http-01-challenge" target="_blank" rel="noopener noreffer">Let&rsquo;s Encrypt challenge types page</a>.</p>
<h6 id="options">Options</h6>
<p>The HTTP01 Issuer supports a number of additional options. For full details on the range of options available, read the <a href="https://docs.cert-manager.io/en/latest/reference/api-docs/index.html#acmeissuerhttp01config-v1alpha2" target="_blank" rel="noopener noreffer">reference documentation</a>.</p>
<p><em><strong>ingressClass</strong></em></p>
<p>If the <code>ingressClass</code> field is specified, cert-manager will create new Ingress resources in order to route traffic to the &lsquo;acmesolver&rsquo; pods, which are responsible for responding to ACME challenge validation requests.</p>
<p>If this field is not specified, and <code>ingressName</code> is also not specified, cert-manager will default to create <strong>new</strong> ingress resources but will <strong>not</strong> set the ingress class on these resources, meaning <strong>all</strong> ingress controllers installed in your cluster will server traffic for the challenge solver, potentially occurring additional cost.</p>
<p><em><strong>ingressName</strong></em></p>
<p>If the &lsquo;ingressName&rsquo; field is specified, cert-manager will edit the named ingress resource in order to solve HTTP01 challenges.</p>
<p>This is useful for compatibility with ingress controllers such as <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/http01/index.html#id1" target="_blank" rel="noopener noreffer">ingress-gce</a>, which utilise a unique IP address for each Ingress resource created.</p>
<p>This mode should be avoided when using ingress controllers that expose a single IP for all ingress resources, as it can create compatibility problems with certain ingress-controller specific annotations.</p>
<p><em><strong>servicePort</strong></em></p>
<p>In rare cases it might be not possible/desired to use NodePort as type for the http01 challenge response service, e.g. because of Kubernetes limit restrictions. To define which Kubernetes service type to use during challenge response specify the following http01 config:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">http01</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># Valid values are ClusterIP and NodePort</span><span class="w">
</span><span class="w">    </span><span class="nt">serviceType</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>By default type NodePort will be used when you don&rsquo;t set http01 or when you set serviceType to an empty string. Normally there&rsquo;s no need to change this.</p>
<p><em><strong>podTemplate</strong></em></p>
<p>You may wish to change or add to the labels and annotations of solver pods. These can be configured under the <code>metadata</code> field under <code>podTemplate</code>.</p>
<p>Similarly, you can set the nodeSelector, tolerations and affinity of solver pods by configuring under the <code>spec</code> field of the <code>podTemplate</code>. No other spec fields can be edited.</p>
<p>An example of how you could configure the template is as so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">...</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">...</span><span class="w">
</span><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">...</span><span class="w">
</span><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">podTemplate</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">foo</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;bar&#34;</span><span class="w">
</span><span class="w">                </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;prod&#34;</span><span class="w">
</span><span class="w">            </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">bar</span><span class="p">:</span><span class="w"> </span><span class="l">baz</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The added labels and annotations will merge on top of the cert-manager defaults, overriding entries with the same key.</p>
<p>No other fields can be edited.</p>
<h5 id="configuring-dns01-challenge-providers">Configuring DNS01 Challenge Providers</h5>
<p>This page contains details on the different options available on the <code>Issuer</code> resource&rsquo;s DNS01 challenge solver configuration.</p>
<p>For more information on configuring ACME issuers and their API format, read the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/index.html" target="_blank" rel="noopener noreffer">Setting up ACME Issuers</a> documentation.</p>
<p>DNS01 provider configuration must be specified on the Issuer resource, similar to the examples in the setting up documentation:</p>
<p>You can read about how the DNS01 challenge type works on the
<a href="https://letsencrypt.org/docs/challenge-types/#http-01-challenge" target="_blank" rel="noopener noreffer">Let&rsquo;s Encrypt challenge types page</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-issuer</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">user@example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="w">
</span><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-issuer-account-key</span><span class="w">
</span><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">dns01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">clouddns</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">project</span><span class="p">:</span><span class="w"> </span><span class="l">my-project</span><span class="w">
</span><span class="w">            </span><span class="nt">serviceAccountSecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">prod-clouddns-svc-acct-secret</span><span class="w">
</span><span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">service-account.json</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Each issuer can specify multiple different DNS01 challenge providers, and it is also possible to have multiple instances of the same DNS provider on a single Issuer (e.g. two clouddns accounts could be set, each with their own name).</p>
<p>For more information on utilising multiple solver types on a single Issuer, read the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/dns01/index.html#id2" target="_blank" rel="noopener noreffer">multiple-solver-types</a> section.</p>
<h6 id="setting-nameservers-for-dns01-self-check">Setting nameservers for DNS01 self check</h6>
<p>cert-manager will check the correct DNS records exist before attempting a DNS01 challenge.</p>
<p>By default, the DNS servers for this check will be taken from <code>/etc/resolv.conf</code>.</p>
<p>If this is not desired (for example with multiple authoritative nameservers or split-horizon DNS), the cert-manager controller exposes a flag that allows you alter this behaviour:</p>
<p>Example usage::</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--dns01-recursive-nameservers &#34;8.8.8.8:53,1.1.1.1:53&#34;
</code></pre></td></tr></table>
</div>
</div><p>If you&rsquo;re using the <code>cert-manager</code> helm chart, you can set recursive nameservers through <code>.Values.extraArgs</code> or at the command at helm install/upgrade time with <code>--set</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--set &#39;extraArgs={--dns01-recursive-nameservers=8.8.8.8:53\,1.1.1.1:53}&#39;
</code></pre></td></tr></table>
</div>
</div><h6 id="delegated-domains-for-dns01">Delegated Domains for DNS01</h6>
<p>By default, cert-manager will not follow CNAME records pointing to subdomains.</p>
<p>If granting cert-manager access to the root DNS zone is not desired, then the _acme-challenge.example.com subdomain can instead be delegated to some other, less privileged domain.</p>
<p>Once a CNAME record has been configured to point at the desired domain, and the DNS configuration/credentials for the zone that <em>should be updated</em> have been provided, all that is left to be done is adding an additional field into the relevant <code>dns01</code> solver:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="l">...</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="l">...</span><span class="w">
</span><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">dns01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># Valid values are None and Follow</span><span class="w">
</span><span class="w">        </span><span class="nt">cnameStrategy</span><span class="p">:</span><span class="w"> </span><span class="l">Follow</span><span class="w">
</span><span class="w">        </span><span class="nt">clouddns</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="l">...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>cert-manager will then follow CNAME records recursively in order to determine which DNS zone to update during DNS01 challenges.</p>
<h6 id="supported-dns01-providers">Supported DNS01 providers</h6>
<p>A number of different DNS providers are supported for the ACME issuer. Below is
a listing of available providers, their <code>.yaml</code> configurations, along with additional Kubernetes
and provider specific notes regarding their usage.</p>
<ul>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/dns01/acme-dns.html" target="_blank" rel="noopener noreffer">ACME-DNS</a></li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/dns01/akamai.html" target="_blank" rel="noopener noreffer">Akamai FastDNS</a></li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/dns01/azuredns.html" target="_blank" rel="noopener noreffer">AzureDNS</a></li>
<li>[Cloudflare](<a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/dns01/">https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/dns01/</a>* cloudflare.html)</li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/dns01/google.html" target="_blank" rel="noopener noreffer">Google CloudDNS</a></li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/dns01/route53.html" target="_blank" rel="noopener noreffer">Amazon Route53</a></li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/dns01/digitalocean.html" target="_blank" rel="noopener noreffer">DigitalOcean</a></li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/dns01/rfc2136.html" target="_blank" rel="noopener noreffer">RFC-2136</a></li>
</ul>
<h4 id="setting-up-ca-issuers">Setting up CA Issuers</h4>
<p>cert-manager can be used to obtain certificates using an arbitrary signing key pair stored in a Kubernetes Secret resource.<br>
cert-manager可用于使用存储在Kubernetes Secret资源中的任意签名密钥对来获取证书。</p>
<p>This guide will show you how to configure and create a CA based issuer, backed by a signing key pair stored in a Secret resource.</p>
<h5 id="1-optional-generate-a-signing-key-pair">1. (Optional) Generate a signing key pair</h5>
<p>The CA Issuer does not automatically create and manage a signing key pair for you. As a result, you will need to either supply your own or generate a self signed CA using a tool such as <a href="https://github.com/openssl/openssl" target="_blank" rel="noopener noreffer">openssl</a> or <a href="https://github.com/cloudflare/cfssl" target="_blank" rel="noopener noreffer">cfssl</a>.</p>
<p>This guide will explain how to generate a new signing key pair, however you can substitute it for your own so long as it has the <code>CA</code> flag set.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Generate a CA private key</span>
$ openssl genrsa -out ca.key <span class="m">2048</span>

<span class="c1"># Create a self signed Certificate, valid for 10yrs with the &#39;signing&#39; option set</span>
$ openssl req -x509 -new -nodes -key ca.key -subj <span class="s2">&#34;/CN=</span><span class="si">${</span><span class="nv">COMMON_NAME</span><span class="si">}</span><span class="s2">&#34;</span> -days <span class="m">3650</span> -reqexts v3_req -extensions v3_ca -out ca.crt
</code></pre></td></tr></table>
</div>
</div><p>The output of these commands will be two files, <code>ca.key</code> and <code>ca.crt</code>, the key and certificate for your signing key pair. If you already have your own key pair, you should name the private key and certificate <code>ca.key</code> and <code>ca.crt</code> respectively.</p>
<h5 id="2-save-the-signing-key-pair-as-a-secret">2. Save the signing key pair as a Secret</h5>
<p>We are going to create an Issuer that will use this key pair to generate signed certificates. You can read more about the Issuer resource in <a href="https://cert-manager.readthedocs.io/en/latest/reference/issuers.html" target="_blank" rel="noopener noreffer">the Issuer reference docs</a>. To allow the Issuer to reference our key pair we will store it in a Kubernetes Secret resource.</p>
<p>Issuers are namespaced resources and so they can only reference Secrets in their own namespace. We will therefore put the key pair into the same namespace as the Issuer. We could alternatively create a <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html" target="_blank" rel="noopener noreffer">ClusterIssuer</a>, a cluster-scoped version of an Issuer. For more information on ClusterIssuers, read the <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html" target="_blank" rel="noopener noreffer">ClusterIssuer reference documentation</a>.</p>
<p>The following command will create a Secret containing a signing key pair in the default namespace:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create secret tls ca-key-pair <span class="se">\
</span><span class="se"></span>    --cert<span class="o">=</span>ca.crt <span class="se">\
</span><span class="se"></span>    --key<span class="o">=</span>ca.key <span class="se">\
</span><span class="se"></span>    --namespace<span class="o">=</span>default
</code></pre></td></tr></table>
</div>
</div><h5 id="3-creating-an-issuer-referencing-the-secret">3. Creating an Issuer referencing the Secret</h5>
<p>We can now create an Issuer referencing the Secret resource we just created:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">   </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w">   </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w">   </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">     </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ca-issuer</span><span class="w">
</span><span class="w">     </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">   </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">     </span><span class="nt">ca</span><span class="p">:</span><span class="w">
</span><span class="w">       </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">ca-key-pair</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>We are now ready to obtain certificates!</p>
<h5 id="4-obtain-a-signed-certificate">4. Obtain a signed Certificate</h5>
<p>We can now create the following Certificate resource which specifies the desired certificate. You can read more about the <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html" target="_blank" rel="noopener noreffer">Certificate</a> resource in the reference docs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-com</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">example-com-tls</span><span class="w">
</span><span class="w">    </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">       </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ca-issuer</span><span class="w">
</span><span class="w">      </span><span class="c"># We can reference ClusterIssuers by changing the kind here.</span><span class="w">
</span><span class="w">      </span><span class="c"># The default value is Issuer (i.e. a locally namespaced Issuer)</span><span class="w">
</span><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">commonName</span><span class="p">:</span><span class="w"> </span><span class="l">example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">organization</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">Example CA</span><span class="w">
</span><span class="w">    </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">example.com</span><span class="w">
</span><span class="w">    </span>- <span class="l">www.example.com</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>In order to use the Issuer to obtain a Certificate, we must create a Certificate resource in the <strong>same namespace as the Issuer</strong>, as an Issuer is a namespaced resource. We could alternatively create a <code>ClusterIssuer</code> if we wanted to reuse the signing key pair across multiple namespaces.</p>
<p>Once we have created the Certificate resource, cert-manager will attempt to use the Issuer <code>ca-issuer</code> to obtain a certificate. If successful, the certificate will be stored in a Secret resource named <code>example-com-tls</code> in the same namespace as the Certificate resource (<code>default</code>).</p>
<p>The example above explicitly sets the <code>commonName</code> field to <code>example.com</code>. cert-manager automatically adds the <code>commonName</code> field as a <a href="https://en.wikipedia.org/wiki/Subject_Alternative_Name" target="_blank" rel="noopener noreffer">DNS SAN</a> if it is not already contained in the <code>dnsNames</code> field.</p>
<p>If we had <strong>not</strong> specified the <code>commonName</code> field, then the <strong>first</strong> DNS SAN that is specified (under <code>dnsNames</code>) would be used as the certificate&rsquo;s common name.</p>
<p>After creating the above Certificate, we can check whether it has been obtained successfully like so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">   </span><span class="l">$ kubectl describe certificate example-com</span><span class="w">
</span><span class="w">   </span><span class="nt">Events</span><span class="p">:</span><span class="w">
</span><span class="w">     </span><span class="l">Type     Reason                 Age              From                     Message</span><span class="w">
</span><span class="w">     </span>---- <span class="w">    </span>------ <span class="w">                </span>---- <span class="w">            </span>---- <span class="w">                    </span>-------<span class="w">
</span><span class="w">     </span><span class="nt">Warning  ErrorCheckCertificate  26s              cert-manager-controller  Error checking existing TLS certificate</span><span class="p">:</span><span class="w"> </span><span class="l">secret &#34;example-com-tls&#34; not found</span><span class="w">
</span><span class="w">     </span><span class="l">Normal   PrepareCertificate     26s              cert-manager-controller  Preparing certificate with issuer</span><span class="w">
</span><span class="w">     </span><span class="l">Normal   IssueCertificate       26s              cert-manager-controller  Issuing certificate...</span><span class="w">
</span><span class="w">     </span><span class="l">Normal   CertificateIssued      25s              cert-manager-controller  Certificate issued successfully</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>You can also check whether issuance was successful with <code>kubectl get secret example-com-tls -o yaml</code>. You should see a base64 encoded signed TLS key pair.</p>
<p>Once the certificate has been obtained, cert-manager will keep checking its validity and attempt to renew it if it gets close to expiry. cert-manager considers certificates to be close to expiry when the &lsquo;Not After&rsquo; field on the certificate is less than the current time plus 30 days. For CA based Issuers, cert-manager will issue certificates with the &lsquo;Not After&rsquo; field set to the current time plus 365 days.</p>
<h4 id="setting-up-self-signing-issuers">Setting up self signing Issuers</h4>
<p>Self signed Issuers will issue self signed certificates.</p>
<p>This is useful when building PKI within Kubernetes, or as a means to generate a root CA for use with the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-ca.html" target="_blank" rel="noopener noreffer">CA Issuer</a>.</p>
<p>A self-signed Issuer contains no additional configuration fields, and can be created with a resource like so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">selfsigning-issuer</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">selfSigned</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>note</strong>:
The presence of the <code>selfSigned: {}</code> line is enough to indicate that this Issuer is of type &lsquo;self signed&rsquo;.</p>
</blockquote>
<p>Once created, you should be able to issue certificates like usual by referencing the newly created Issuer in your <code>issuerRef</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-crt</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">my-selfsigned-cert</span><span class="w">
</span><span class="w">    </span><span class="nt">commonName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;my-selfsigned-root-ca&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">isCA</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">selfsigning-issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="setting-up-vault-issuers">Setting up Vault Issuers</h4>
<h5 id="installing-vault">Installing Vault</h5>
<p>Vault installation is a complex subject. For a thorough tour of the subject you can read the official HashiCorp Vault <a href="https://learn.hashicorp.com/vault/getting-started/install" target="_blank" rel="noopener noreffer">documentation</a>.</p>
<h5 id="vault-pki-backend">Vault PKI Backend</h5>
<p>The PKI Secrets Engine needs to be initialized for cert-manager to be able to generate certificate. The official Vault documentation can be found <a href="https://www.vaultproject.io/docs/secrets/pki/index.html" target="_blank" rel="noopener noreffer">here</a>.</p>
<h6 id="vault-authentication-with-a-approle">Vault Authentication with a AppRole</h6>
<p>This Vault authentication method uses a <a href="https://www.vaultproject.io/docs/auth/approle.html" target="_blank" rel="noopener noreffer">Vault AppRole</a>.</p>
<p>The secret ID of the AppRole is stored in a secret.</p>
<p>Here an example of a secret containing the secretId of the AppRole:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager-vault-approle</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretId</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;MDI...&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Where the secretId is the base 64 encoded value of the appRole <em>secretId</em> giving access to the pki backend in Vault.</p>
<p>We can now create a cluster issuer referencing this secret:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vault-issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">vault</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">pki_int/sign/example-dot-com</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://vault</span><span class="w">
</span><span class="w">    </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;base64 encoded caBundle PEM file&gt;</span><span class="w">
</span><span class="w">    </span><span class="nt">auth</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">appRole</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">approle</span><span class="w">
</span><span class="w">        </span><span class="nt">roleId</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;291b9d21-8ff5-...&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">secretRef</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager-vault-approle</span><span class="w">
</span><span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">secretId</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Where <em>path</em> is the Vault role path of the PKI backend and <em>server</em> is the Vault server base URL. The <em>path</em> MUST USE the vault <code>sign</code> endpoint.</p>
<p>The Vault appRole credentials are supplied as the Vault authentication method using the appRole created in Vault. The secretRef references the Kubernetes secret created previously. More specifically, the field <em>name</em> is the Kubernetes secret name and <em>key</em> is the name given as the key value that store the <em>secretId</em>. The optional attribute <em>path</em> specifies where the AppRole authentication is mounted in Vault. The attribute <em>path</em> default value is <em>approle</em>.</p>
<p>An optional base64 encoded <em>caBundle</em> in PEM format can be provided to validate the TLS connection to the Vault Server. When <em>caBundle</em> is set it replaces the CA bundle inside the container running cert-manager This parameter has no effect if the connection used is in plain HTTP.</p>
<p>Once we have created the above Issuer we can use it to obtain a certificate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-com</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">example-com-tls</span><span class="w">
</span><span class="w">    </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vault-issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">commonName</span><span class="p">:</span><span class="w"> </span><span class="l">example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">www.example.com</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The Certificate resource describes our desired certificate and the possible methods that can be used to obtain it. You can learn more about the <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html" target="_blank" rel="noopener noreffer">Certificate</a> resource in the reference docs.</p>
<p>If the certificate is obtained successfully, the resulting key pair will be stored in a secret called <code>example-com-tls</code> in the same namespace as the Certificate.</p>
<p>The certificate will have a common name of <code>example.com</code> and the <a href="https://en.wikipedia.org/wiki/Subject_Alternative_Name" target="_blank" rel="noopener noreffer">Subject Alternative Names (SANs)</a> will be <code>example.com</code> and <code>www.example.com</code>.</p>
<p>In our Certificate we have referenced the <code>vault-issuer</code> Issuer above. The Issuer must be in the same namespace as the Certificate. If you want to reference a <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html" target="_blank" rel="noopener noreffer">ClusterIssuer</a>, which is a cluster-scoped version of an Issuer, you must add <code>kind: ClusterIssuer</code> to the <code>issuerRef</code> stanza.</p>
<h6 id="vault-authentication-with-a-token">Vault Authentication with a Token</h6>
<p>This Vault authentication method uses a plain token. A Vault token is generated by one of the many authentication backends supported by Vault. Tokens in Vault have expiration and need to be refreshed.</p>
<p>You need to be aware that cert-manager does not refresh these tokens. Another process must be put in place to keep them from expiring.</p>
<p>For testing purposes a root token is generated at Vault installation time.</p>
<p><strong>WARNING: Root tokens do not expire, so should only be used for testing purposes.</strong></p>
<p>Please refer to the <a href="https://www.vaultproject.io/docs/concepts/tokens.html" target="_blank" rel="noopener noreffer">official token documentation</a> for all the details.</p>
<p>Here an example of a secret Kubernetes resource containing the Vault token:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager-vault-token</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;MjI...&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Where the token value is the base 64 encoded value of the token giving access to the PKI backend in Vault.</p>
<p>We can now create an issuer referencing this secret:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vault-issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">vault</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">auth</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">tokenSecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager-vault-token</span><span class="w">
</span><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">token</span><span class="w">
</span><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">pki_int/sign/example-dot-com</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://vault</span><span class="w">
</span><span class="w">    </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;base64 encoded caBundle PEM file&gt;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Where <em>path</em> is the Vault role path of the PKI backend and <em>server</em> is the Vault server base URL. The secret created previously is referenced in the issuer with its <em>name</em> and <em>key</em> corresponding to the name of the Kubernetes secret and the property name containing the token value respectively.</p>
<p>An optional base64 encoded <em>caBundle</em> in PEM format can be provided to validate the TLS connection to the Vault Server. When <em>caBundle</em> is set it replaces the CA bundle inside the container running cert-manager. This parameter as no effect if the connection used is in plain HTTP.</p>
<p>Once we have created the above Issuer we can use it to obtain a certificate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-com</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">example-com-tls</span><span class="w">
</span><span class="w">    </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vault-issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">commonName</span><span class="p">:</span><span class="w"> </span><span class="l">example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">www.example.com</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The Certificate resource describes our desired certificate and the possible methods that can be used to obtain it. You can learn more about the <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html" target="_blank" rel="noopener noreffer">Certificate resource</a> in the reference docs. If the certificate is obtained successfully, the resulting key pair will be stored in a secret called <code>example-com-tls</code> in the same namespace as the Certificate.</p>
<p>The certificate will have a common name of <code>example.com</code> and the <a href="https://en.wikipedia.org/wiki/Subject_Alternative_Name" target="_blank" rel="noopener noreffer">Subject Alternative Names (SANs)</a> will be <code>example.com</code> and <code>www.example.com</code>.</p>
<p>In our Certificate we have referenced the <code>vault-issuer</code> Issuer above. The Issuer must be in the same namespace as the Certificate. If you want to reference a <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html" target="_blank" rel="noopener noreffer">ClusterIssuer</a>, which is a cluster-scoped version of an Issuer, you must add <code>kind: ClusterIssuer</code> to the <code>issuerRef</code> stanza.</p>
<h6 id="vault-authentication-with-kubernetes-service-accounts">Vault Authentication with Kubernetes Service Accounts</h6>
<p>This Vault authentication method uses Service Account tokens created by Kubernetes to authenticate requests to Vault for signing certificates. You can find more information on how to configure vault for Kubernetes based Service Account authentication in the <a href="https://www.vaultproject.io/docs/auth/kubernetes.html" target="_blank" rel="noopener noreffer">documentation</a>.</p>
<p>This authentication expects three stanzas; a secret reference of the Service Account to use, an optional authentication mount path that is defaulted to <code>kubernetes</code>, and finally a Vault role that the Service Account is to assume.</p>
<p>Here is an example Vault issuer using the Kubernetes Service Account authentication method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vault-issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">vault</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">pki_int/sign/example-dot-com</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://vault</span><span class="w">
</span><span class="w">    </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;base64 encoded caBundle PEM file&gt;</span><span class="w">
</span><span class="w">    </span><span class="nt">auth</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">kubernetes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/kubernetes/cluster-1</span><span class="w">
</span><span class="w">        </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-1</span><span class="w">
</span><span class="w">        </span><span class="nt">secretRef</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-service-account-secret</span><span class="w">
</span><span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">token</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Once created and is ready you can create Certificates referencing this issuer in the normal way.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-com</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">example-com-tls</span><span class="w">
</span><span class="w">    </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vault-issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">commonName</span><span class="p">:</span><span class="w"> </span><span class="l">example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">www.example.com</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="setting-up-venafi-issuers">Setting up Venafi Issuers</h4>
<p>The Venafi Issuer types allows you to obtain certificates from <a href="https://pki.venafi.com/venafi-cloud/" target="_blank" rel="noopener noreffer">Venafi Cloud</a> and <a href="https://venafi.com/" target="_blank" rel="noopener noreffer">Venafi Trust Protection Platform</a> instances.</p>
<p>Register your account at <a href="https://ui.venafi.cloud/enroll">https://ui.venafi.cloud/enroll</a> and get an API key from your dashboard.</p>
<p>You can have multiple different Venafi Issuer types installed within the same cluster, including mixtures of Cloud and TPP issuer types. This allows you to be flexible with the types of Venafi account you use.</p>
<p>Automated certificate renewal and management are provided for Certificates using the Venafi issuer.</p>
<blockquote>
<p><strong>note</strong>:
The Venafi Issuer has been recently added, and the exact structure of the Issuer resource is subject to change. Such changes will be clearly documented, and migration steps will be provided.</p>
</blockquote>
<h5 id="creating-an-issuer-resource">Creating an Issuer resource</h5>
<p>A single Venafi Issuer represents a single &lsquo;zone&rsquo; within the Venafi API, therefore you must create an Issuer resource for each Venafi Zone you want to obtain certificates from.</p>
<p>You can configure your Issuer resource to either issue certificates only within a single namespace, or cluster-wide (using a ClusterIssuer resource). For more information on the distinction between Issuer and ClusterIssuer resources, read the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/index.html#issuer-vs-clusterissuer" target="_blank" rel="noopener noreffer">issuer_vs_clusterissuer</a> section.</p>
<h6 id="creating-a-venafi-cloud-issuer">Creating a Venafi Cloud Issuer</h6>
<p>In order to set up a Venafi Cloud Issuer, you must first create a Kubernetes Secret resource containing your Venafi Cloud API credentials:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">   </span><span class="l">kubectl create secret generic \</span><span class="w">
</span><span class="w">        </span><span class="l">cloud-secret \</span><span class="w">
</span><span class="w">        </span>--<span class="l">namespace=&#39;NAMESPACE OF YOUR ISSUER RESOURCE&#39; \</span><span class="w">
</span><span class="w">        </span>--<span class="l">from-literal=apikey=&#39;YOUR_CLOUD_API_KEY_HERE&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>note</strong>:
If you are configuring your Issuer as a ClusterIssuer resource in order to issue Certificates across your whole cluster, you must set the <code>--namespace</code> parameter to <code>cert-manager</code>, which is the default &lsquo;cluster resource namespace&rsquo;.</p>
</blockquote>
<p>This API key will be used by cert-manager to interact with the Venafi Cloud service on your behalf.</p>
<p>Once the API key Secret has been created, you can create your Issuer or ClusterIssuer resource. If you are creating a ClusterIssuer resource, you must change the <code>kind</code> field to <code>ClusterIssuer</code> and remove the <code>metadata.namespace</code> field.</p>
<p>Save the below content after making your amendments to a file named <code>venafi-cloud-issuer.yaml</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-venafi-issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;NAMESPACE YOU WANT TO ISSUE CERTIFICATES IN&gt;</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">venafi</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;DevOps&#34;</span><span class="w"> </span><span class="c"># Set this to the Venafi policy zone you want to use</span><span class="w">
</span><span class="w">    </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">apiTokenSecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-secret</span><span class="w">
</span><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">apikey</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>You can then create the Issuer using <code>kubectl create -f</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create -f venafi-cloud-issuer.yaml
</code></pre></td></tr></table>
</div>
</div><p>Verify the Issuer has been initialised correctly using <code>kubectl describe</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl describe issuer cloud-venafi-issuer --namespace<span class="o">=</span><span class="s1">&#39;NAMESPACE OF YOUR ISSUER RESOURCE&#39;</span>

<span class="o">(</span>TODO<span class="o">)</span> include sample output
</code></pre></td></tr></table>
</div>
</div><p>You are now ready to issue certificates using the newly provisioned Venafi Issuer.</p>
<p>Read the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuing-certificates/index.html" target="_blank" rel="noopener noreffer">Issuing Certificates</a> document for more information on how to create Certificate resources.</p>
<h5 id="creating-a-venafi-trust-protection-platform-issuer">#Creating a Venafi Trust Protection Platform Issuer</h5>
<p>The Venafi Trust Protection integration allows you to obtain certificates from a properly configured Venafi TPP instance.</p>
<p>The setup is similar to the Venafi Cloud configuration above, however some of the connection parameters are slightly different.</p>
<blockquote>
<p><strong>note</strong>:
You <strong>must</strong> allow &ldquo;User Provided CSRs&rdquo; as part of your TPP policy, as this is the only type supported by cert-manager at this time.</p>
</blockquote>
<p>In order to set up a Venafi Trust Protection Platform Issuer, you must first create a Kubernetes Secret resource containing your Venafi TPP API credentials:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create secret generic <span class="se">\
</span><span class="se"></span>    tpp-secret <span class="se">\
</span><span class="se"></span>    --namespace<span class="o">=</span>&lt;NAMESPACE OF YOUR ISSUER RESOURCE&gt; <span class="se">\
</span><span class="se"></span>    --from-literal<span class="o">=</span><span class="nv">username</span><span class="o">=</span><span class="s1">&#39;YOUR_TPP_USERNAME_HERE&#39;</span> <span class="se">\
</span><span class="se"></span>    --from-literal<span class="o">=</span><span class="nv">password</span><span class="o">=</span><span class="s1">&#39;YOUR_TPP_PASSWORD_HERE&#39;</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>note</strong>:
If you are configuring your Issuer as a ClusterIssuer resource in order to issue Certificates across your whole cluster, you must set the <code>--namespace</code> parameter to <code>cert-manager</code>, which is the default &lsquo;cluster resource namespace&rsquo;.</p>
</blockquote>
<p>These credentials will be used by cert-manager to interact with your Venafi TPP instance.  Username attribute must be adhere to the <code>&lt;identity provider&gt;:&lt;username&gt;</code> format. For example: <code>local:admin</code>.</p>
<p>Once the Secret containing credentials has been created, you can create your Issuer or ClusterIssuer resource. If you are creating a ClusterIssuer resource, you must change the <code>kind</code> field to <code>ClusterIssuer</code> and remove the <code>metadata.namespace</code> field.</p>
<p>Save the below content after making your amendments to a file named <code>venafi-tpp-issuer.yaml</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tpp-venafi-issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;NAMESPACE YOU WANT TO ISSUE CERTIFICATES IN&gt;</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">venafi</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w"> </span><span class="l">devops\cert-manager</span><span class="w"> </span><span class="c"># Set this to the Venafi policy zone you want to use</span><span class="w">
</span><span class="w">    </span><span class="nt">tpp</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">https://tpp.venafi.example/vedsdk</span><span class="w"> </span><span class="c"># Change this to the URL of your TPP instance</span><span class="w">
</span><span class="w">        </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;base64 encoded string of caBundle PEM file, or empty to use system root CAs&gt;</span><span class="w">
</span><span class="w">        </span><span class="nt">credentialsRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tpp-secret</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>You can then create the Issuer using <code>kubectl create -f</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create -f venafi-tpp-issuer.yaml
</code></pre></td></tr></table>
</div>
</div><p>Verify the Issuer has been initialised correctly using <code>kubectl describe</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl describe issuer tpp-venafi-issuer --namespace<span class="o">=</span><span class="s1">&#39;NAMESPACE OF YOUR ISSUER RESOURCE&#39;</span>

<span class="o">(</span>TODO<span class="o">)</span> include sample output
</code></pre></td></tr></table>
</div>
</div><p>You are now ready to issue certificates using the newly provisioned Venafi Issuer.</p>
<p>Read the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuing-certificates/index.html" target="_blank" rel="noopener noreffer">Issuing Certificates document</a> for more information on how to create Certificate resources.</p>
<h3 id="issuing-certificates">Issuing Certificates</h3>
<p>The Certificate resource type is used to request certificates from different Issuers.</p>
<p>In order to issue any certificates, you&rsquo;ll need to configure an Issuer resource first.</p>
<p>If you have not configured any issuers yet, you should read the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/index.html" target="_blank" rel="noopener noreffer">Setting up Issuers</a> guide.</p>
<h4 id="creating-certificate-resources">Creating Certificate resources</h4>
<p>A Certificate resource specifies fields that are used to generated certificate signing requests which are then fulfilled by the issuer type you have referenced.</p>
<p>Certificates specify which issuer they want to obtain the certificate from by specifying the <code>certificate.spec.issuerRef</code> field.</p>
<p>A basic Certificate resource, for the <code>example.com</code> and <code>www.example.com</code> DNS names, <code>spiffe://cluster.local/ns/sandbox/sa/example</code> URI Subject Alternative Name, that is valid for 90d and renews 15d before expiry is below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-com</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">example-com-tls</span><span class="w">
</span><span class="w">    </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">2160h</span><span class="w"> </span><span class="c"># 90d</span><span class="w">
</span><span class="w">    </span><span class="nt">renewBefore</span><span class="p">:</span><span class="w"> </span><span class="l">360h</span><span class="w"> </span><span class="c"># 15d</span><span class="w">
</span><span class="w">    </span><span class="nt">commonName</span><span class="p">:</span><span class="w"> </span><span class="l">example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">example.com</span><span class="w">
</span><span class="w">    </span>- <span class="l">www.example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">uriSANs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">spiffe://cluster.local/ns/sandbox/sa/example</span><span class="w">
</span><span class="w">    </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ca-issuer</span><span class="w">
</span><span class="w">    </span><span class="c"># We can reference ClusterIssuers by changing the kind here.</span><span class="w">
</span><span class="w">    </span><span class="c"># The default value is Issuer (i.e. a locally namespaced Issuer)</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The signed certificate will be stored in a Secret resource named <code>example-com-tls</code> once the issuer has successfully issued the requested certificate.</p>
<p>The Certificate will be issued using the issuer named <code>ca-issuer</code> in the <code>default</code> namespace (the same namespace as the Certificate resource).</p>
<blockquote>
<p><strong>note</strong>:
If you want to create an Issuer that can be referenced by Certificate resources in <strong>all</strong> namespaces, you should create a <code>ClusterIssuer</code> resource and set the <code>certificate.spec.issuerRef.kind</code> field to <code>ClusterIssuer</code>.</p>
</blockquote>
<blockquote>
<p><strong>note</strong>:
The <code>renewBefore</code> and <code>duration</code> fields must be specified using Golang&rsquo;s <code>time.Time</code> string format, which does not allow the <code>d</code> (days) suffix. You must specify these values using <code>s</code>, <code>m</code> and <code>h</code> suffixes instead. Failing to do so without installing the <a href="https://cert-manager.readthedocs.io/en/latest/getting-started/webhook.html" target="_blank" rel="noopener noreffer">webhook</a> component can prevent cert-manager from functioning correctly (<a href="https://github.com/jetstack/cert-manager/issues/1269" target="_blank" rel="noopener noreffer">#1269</a>).</p>
</blockquote>
<blockquote>
<p><strong>note</strong>:
Take care when setting the <code>renewBefore</code> field to be very close to the <code>duration</code> as this can lead to a renewal loop, where the Certificate is always in the renewal period. Some Issuers set the <code>notBefore</code> field on their issued X.509 certificate before the issue time to fix clock-skew issues, leading to the working duration of a certificate to be less than the full duration of the certificate. For example, Let&rsquo;s Encrypt sets it to be one hour before issue time, so the actual <em>working duration</em> of the certificate is 89 days, 23 hours (the <em>full duration</em> remains 90 days).</p>
</blockquote>
<p>A full list of the fields supported on the Certificate resource can be found in
the <a href="https://docs.cert-manager.io/en/release-0.11/reference/api-docs/index.html#certificatespec-v1alpha2" target="_blank" rel="noopener noreffer">API reference documentation</a>.</p>
<h4 id="temporary-certificates-whilst-issuing">Temporary certificates whilst issuing</h4>
<p>With some Issuer types, certificates can take a few minutes to be issued.</p>
<p>A temporary untrusted certificate will be issued whilst this process takes places if another certificate does not already exist in the target Secret resource.</p>
<p>This helps to improve compatibility with certain ingress controllers (e.g. <a href="https://github.com/kubernetes/ingress-gce" target="_blank" rel="noopener noreffer">ingress-gce</a>) which require a TLS certificate to be present at all times in order to function.</p>
<p>After the real, valid certificate has been obtained, cert-manager will replace the temporary self signed certificate with the valid one, <strong>but will retain the same private key</strong></p>
<p>You can disable issuing temporary certificate by setting feature gate flag <code>--feature-gates=IssueTemporaryCertificate=false</code></p>
<h4 id="automatically-creating-certificates-for-ingress-resources">Automatically creating Certificates for Ingress resources</h4>
<p><strong>cert-manager can be configured to automatically provision TLS certificates for Ingress resources via annotations on your Ingresses.</strong></p>
<p>A small sub-component of cert-manager, <em><strong>ingress-shim</strong></em>, is responsible for this.</p>
<h5 id="how-it-works-1">How it works</h5>
<p><code>ingress-shim</code> watches Ingress resources across your cluster. If it observes an Ingress with <em>any</em> of the annotations described in the &lsquo;Usage&rsquo; section, it will ensure a Certificate resource with the same name as the Ingress, and configured as described on the Ingress exists.</p>
<p>For example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># add an annotation indicating the issuer to use.</span><span class="w">
</span><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l">nameOfClusterIssuer</span><span class="w">
</span><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myIngress</span><span class="w">
</span><span class="w"></span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">myIngress</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">myingress.com</span><span class="w">
</span><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">backend</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">myservice</span><span class="w">
</span><span class="w">        </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span><span class="w"></span><span class="nt">tls</span><span class="p">:</span><span class="w"> </span><span class="c"># &lt; placing a host in the TLS config will indicate a cert should be created</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">myingress.com</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">myingress-cert</span><span class="w"> </span><span class="c"># &lt; cert-manager will store the created certificate in this secret.</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h5 id="configuration">Configuration</h5>
<p>Since cert-manager v0.2.2, <code>ingress-shim</code> is deployed automatically as part of a Helm chart installation.</p>
<p>If you would also like to use the old <a href="https://github.com/jetstack/kube-lego" target="_blank" rel="noopener noreffer">kube-lego</a> <code>kubernetes.io/tls-acme: &quot;true&quot;</code> annotation for fully automated TLS, you will need to configure a default Issuer when deploying cert-manager. This can be done by adding the following <code>--set</code> when deploying using Helm:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">--set ingressShim.defaultIssuerName<span class="o">=</span>letsencrypt-prod <span class="se">\
</span><span class="se"></span>--set ingressShim.defaultIssuerKind<span class="o">=</span>ClusterIssuer
</code></pre></td></tr></table>
</div>
</div><p>In the above example, cert-manager will create Certificate resources that reference the ClusterIssuer <code>letsencrypt-prod</code> for all Ingresses that have a <code>kubernetes.io/tls-acme: &quot;true&quot;</code> annotation.</p>
<p>For more information on deploying cert-manager, read the <a href="https://cert-manager.readthedocs.io/en/latest/getting-started/index.html" target="_blank" rel="noopener noreffer">deployment guide</a>.</p>
<h5 id="supported-annotations">Supported annotations</h5>
<p>You can specify the following annotations on ingresses in order to trigger Certificate resources to be automatically created:</p>
<ul>
<li>
<p><code>cert-manager.io/issuer</code> - the name of an Issuer to acquire the certificate required for this ingress from. The Issuer <strong>must</strong> be in the same namespace as the Ingress resource.</p>
</li>
<li>
<p><code>cert-manager.io/cluster-issuer</code> - the name of a ClusterIssuer to acquire the certificate required for this ingress from. It does not matter which namespace your Ingress resides, as ClusterIssuers are non-namespaced resources.</p>
</li>
<li>
<p><code>kubernetes.io/tls-acme: &quot;true&quot;</code> - this annotation requires additional configuration of the ingress-shim (see above). Namely, a default issuer must be specified as arguments to the ingress-shim container.</p>
</li>
<li>
<p><code>acme.cert-manager.io/http01-ingress-class</code> - this annotation allows you to configure ingress class that will be used to solve challenges for this ingress. Customising this is useful when you are trying to secure internal services, and need to solve challenges using different ingress class to that of the ingress. If not specified and the &lsquo;acme-http01-edit-in-place&rsquo; annotation is not set, this defaults to the ingress class of the ingress resource.</p>
</li>
<li>
<p><code>acme.cert-manager.io/http01-edit-in-place: &quot;true&quot;</code> - this controls whether the ingress is modified &lsquo;in-place&rsquo;, or a new one created specifically for the http01 challenge. If present, and set to &ldquo;true&rdquo; the existing ingress will be modified. Any other value, or the absence of the annotation assumes &ldquo;false&rdquo;.</p>
</li>
</ul>
<h3 id="backing-up-and-restoring">Backing up and restoring</h3>
<p>If you need to uninstall cert-manager, or transfer your installation to a new cluster, you can backup all of cert-manager&rsquo;s configuration in order to later re-install.</p>
<h4 id="backing-up">Backing up</h4>
<p>To backup all of your cert-manager configuration resources, run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">kubectl get -o yaml \</span><span class="w">
</span><span class="w">    </span>--<span class="l">all-namespaces \</span><span class="w">
</span><span class="w">    </span><span class="l">issuer,clusterissuer,certificates,orders,challenges,certificaterequests &gt; cert-manager-backup.yaml</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>If you are transferring data to a new cluster, you may also need to copy across additional Secret resources that are referenced by your configured Issuers, such as:</p>
<p><em><strong>CA Issuers</strong></em></p>
<ul>
<li>The root CA Secret referenced by <code>issuer.spec.ca.secretName</code></li>
</ul>
<p><em><strong>Vault Issuers</strong></em></p>
<ul>
<li>The token authentication Secret referenced by <code>issuer.spec.vault.auth.tokenSecretRef</code></li>
<li>The approle configuration Secret referenced by <code>issuer.spec.vault.auth.appRole.secretRef</code></li>
</ul>
<p><em><strong>ACME Issuers</strong></em></p>
<ul>
<li>The ACME account private key Secret referenced by <code>issuer.acme.privateKeySecretRef</code></li>
<li>Any Secrets referenced by DNS providers configured under the <code>issuer.acme.dns01.providers</code> and <code>issuer.acme.solvers.dns01</code> fields.</li>
</ul>
<p><em><strong>Restoring</strong></em></p>
<p>In order to restore your configuration, you can simply <code>kubectl apply</code> the files created above after installing cert-manager.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">kubectl apply -f cert-manager-backup.yaml</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>If you have migrated from an old cluster, you will need to make sure to run a similar <code>kubectl apply</code> command to restore your Secret resources too.</p>
<h3 id="uninstalling-cert-manager">Uninstalling cert-manager</h3>
<p>cert-manager supports running on Kubernetes and OpenShift. The uninstallation process between the two platforms is similar, although there are a number of extra notes to be aware of per-platform.</p>
<h4 id="uninstalling-on-kubernetes">Uninstalling on Kubernetes</h4>
<p>Below is the processes for uninstalling cert-manager on Kubernetes. There are two processes to chose depending on which method you used to install cert-manager - static manifests or <code>helm</code>.</p>
<blockquote>
<p><strong>warning</strong>:
To uninstall cert-manger you should always use the same process for installing but in reverse. Deviating from the following process whether cert-manager has been installed from static manifests or helm can cause issues and potentially broken states. Please ensure you follow the below steps when uninstalling to prevent this happening.</p>
</blockquote>
<p>Before continuing, ensure that all cert-manager resources that have been created by users have been deleted. You can check for any existing resources with the following command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get Issuers,ClusterIssuers,Certificates,CertificateRequests,Orders,Challenges --all-namespaces
</code></pre></td></tr></table>
</div>
</div><p>Once all these resources have been deleted you are ready to uninstall cert-manager using the procedure determined by how you installed.</p>
<h5 id="uninstalling-with-regular-manifests">Uninstalling with regular manifests</h5>
<p>Uninstalling from an installation with regular manifests is a case of running the installation process, <em>in reverse</em>, using the delete command of <code>kubectl</code>.</p>
<p>Delete the installation manifests using a link to your currently running version vX.Y.Z like so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl delete -f https://github.com/jetstack/cert-manager/releases/download/vX.Y.Z/cert-manager.yaml
</code></pre></td></tr></table>
</div>
</div><h5 id="uninstalling-with-helm">Uninstalling with Helm</h5>
<p>Uninstalling cert-manager from a <code>helm</code> installation is a case of running the installation process, <em>in reverse</em>, using the delete command on both <code>kubectl</code> and <code>helm</code>.</p>
<p>Firstly, delete the cert-manager installation using <code>helm</code>. Ensure the <code>--purge</code> flag is applied.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">helm delete cert-manager --purge
</code></pre></td></tr></table>
</div>
</div><p>Next, delete the cert-manager namespace:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl delete namespace cert-manager
</code></pre></td></tr></table>
</div>
</div><p>Finally, delete the cert-manger <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank" rel="noopener noreffer">CustomResourceDefinitions</a> using the link to the version vX.Y you installed:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl delete -f https://raw.githubusercontent.com/jetstack/cert-manager/release-X.Y/deploy/manifests/00-crds.yaml
</code></pre></td></tr></table>
</div>
</div><h5 id="namespace-stuck-in-terminating-state">Namespace Stuck in Terminating State</h5>
<p>If the namespace has been marked for deletion without deleting the cert-manager installation first, the namespace may become stuck in a terminating state. This is typically due to the fact that the <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/setup-extension-api-server" target="_blank" rel="noopener noreffer">APIService</a> resource still exists however the webhook is no longer running so is no longer reachable. To resolve this, ensure you have run the above commands correctly, and if you&rsquo;re still experiencing issues then run <code>kubectl delete apiservice v1beta1.webhook.cert-manager.io</code>.</p>
<h4 id="uninstalling-on-openshift">Uninstalling on OpenShift</h4>
<p>Below is the processes for uninstalling cert-manager on OpenShift.</p>
<blockquote>
<p><strong>warning</strong>:
To uninstall cert-manger you should always use the same process for installing but in reverse. Deviating from the following process can cause issues and potentially broken states. Please ensure you follow the below steps when uninstalling to prevent this happening.</p>
</blockquote>
<h5 id="login-to-your-openshift-cluster-1">Login to your OpenShift cluster</h5>
<p>Before you can uninstall cert-manager, you must first ensure your local machine is configured to talk to your OpenShift cluster using the <code>oc</code> tool.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Login to the OpenShift cluster as the system:admin user</span>
oc login -u system:admin
</code></pre></td></tr></table>
</div>
</div><h5 id="uninstalling-with-regular-manifests-1">Uninstalling with regular manifests</h5>
<p>Before continuing, ensure that all cert-manager resources that have been created by users have been deleted. You can check for any existing resources with the following command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">oc get Issuers,ClusterIssuers,Certificates,CertificateRequests,Orders,Challenges --all-namespaces
</code></pre></td></tr></table>
</div>
</div><p>Once all these resources have been deleted you are ready to uninstall cert-manager.</p>
<p>Uninstalling from an installation with regular manifests is a case of running the installation process, <em>in reverse</em>, using the delete command of <code>oc</code>.</p>
<p>Delete the installation manifests using a link to your currently running version vX.Y.Z like so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">oc delete -f https://github.com/jetstack/cert-manager/releases/download/vX.Y.Z/cert-manager-openshift.yaml
</code></pre></td></tr></table>
</div>
</div><h5 id="namespace-stuck-in-terminating-state-1">Namespace Stuck in Terminating State</h5>
<p>If the namespace has been marked for deletion without deleting the cert-manager installation first, the namespace may become stuck in a terminating state. This is typically due to the fact that the <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/setup-extension-api-server" target="_blank" rel="noopener noreffer">APIService</a> resource still exists however the webhook is no longer running so is no longer reachable. To resolve this, ensure you have run the above commands correctly, and if you&rsquo;re still experiencing issues then run <code>oc delete apiservice v1beta1.webhook.cert-manager.io</code>.</p>
<h3 id="upgrading-cert-manager">Upgrading cert-manager</h3>
<p>This section contains information on upgrading cert-manager. It also contains documents detailing breaking changes between cert-manager versions, and information on things to look out for when upgrading.</p>
<blockquote>
<p><strong>note</strong>:
Before performing upgrades of cert-manager, it is advised to take a backup of all your cert-manager resources just in case an issue occurs whilst upgrading. You can read how to backup and restore cert-manager in the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/backup-restore-crds.html" target="_blank" rel="noopener noreffer">Backing up and restoring</a> guide..</p>
</blockquote>
<h4 id="upgrading-with-helm">Upgrading with Helm</h4>
<p>If you installed cert-manager using Helm, you can easily upgrade using the Helm
CLI.</p>
<blockquote>
<p><strong>note</strong>:
Before upgrading, please read the relevant instructions at the links below for your from and to version.</p>
</blockquote>
<p>Once you have read the relevant upgrading notes and taken any appropriate actions, you can begin the upgrade process like so - replacing <code>&lt;release_name&gt;</code> with the name of your Helm release for cert-manager (usually this is <code>cert-manager</code>) and replacing <code>&lt;version&gt;</code> with the
version number you want to install:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Install the cert-manager CustomResourceDefinition resources before</span>
<span class="c1"># upgrading the Helm chart</span>
kubectl apply <span class="se">\
</span><span class="se"></span>    --validate<span class="o">=</span><span class="nb">false</span> <span class="se">\
</span><span class="se"></span>    -f https://raw.githubusercontent.com/jetstack/cert-manager/&lt;version&gt;/deploy/manifests/00-crds.yaml

<span class="c1"># Add the Jetstack Helm repository if you haven&#39;t already</span>
helm repo add jetstack https://charts.jetstack.io

<span class="c1"># Ensure the local Helm chart repository cache is up to date</span>
helm repo update

helm upgrade --version &lt;version&gt; &lt;release_name&gt; jetstack/cert-manager
</code></pre></td></tr></table>
</div>
</div><p>This will upgrade you to the latest version of cert-manager, as listed in the <a href="https://cert-manager.readthedocs.io/en/latest/tasks/upgrading/index.html#id1" target="_blank" rel="noopener noreffer">Jetstack Helm chart repository</a>.</p>
<blockquote>
<p><strong>note</strong>:
You can find out your release name using <code>helm list | grep cert-manager</code>.</p>
</blockquote>
<h4 id="upgrading-using-static-manifests">Upgrading using static manifests</h4>
<p>If you installed cert-manager using the static deployment manifests published on each release, you can upgrade them in a similar way to how you first installed them.</p>
<blockquote>
<p><strong>note</strong>:
Before upgrading, please read the relevant instructions at the links below for your from and to version.</p>
</blockquote>
<p>Once you have read the relevant notes and taken any appropriate actions, you can begin the upgrade process like so - replacing <code>&lt;version&gt;</code> with the version number you want to install:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl apply <span class="se">\
</span><span class="se"></span>    --validate<span class="o">=</span><span class="nb">false</span> <span class="se">\
</span><span class="se"></span>    -f https://github.com/jetstack/cert-manager/releases/download/&lt;version&gt;/cert-manager.yaml
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>note</strong>::
If you are running Kubernetes v1.15 or below, you will need to add the <code>--validate=false</code> flag to your <code>kubectl apply</code> command above else you will receive a validation error relating to the <code>x-kubernetes-preserve-unknown-fields</code> field in our <code>CustomResourceDefinition</code> resources. This is a benign error and occurs due to the way <code>kubectl</code> performs resource validation.</p>
</blockquote>
<ul>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/upgrading/upgrading-0.2-0.3.html" target="_blank" rel="noopener noreffer">Upgrading from v0.2 to v0.3</a></li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/upgrading/upgrading-0.3-0.4.html" target="_blank" rel="noopener noreffer">Upgrading from v0.3 to v0.4</a></li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/upgrading/upgrading-0.4-0.5.html" target="_blank" rel="noopener noreffer">Upgrading from v0.4 to v0.5</a></li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/upgrading/upgrading-0.5-0.6.html" target="_blank" rel="noopener noreffer">Upgrading from v0.5 to v0.6</a></li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/upgrading/upgrading-0.6-0.7.html" target="_blank" rel="noopener noreffer">Upgrading from v0.6 to v0.7</a></li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/upgrading/upgrading-0.7-0.8.html" target="_blank" rel="noopener noreffer">Upgrading from v0.7 to v0.8</a></li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/upgrading/upgrading-0.8-0.9.html" target="_blank" rel="noopener noreffer">Upgrading from v0.8 to v0.9</a></li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/upgrading/upgrading-0.9-0.10.html" target="_blank" rel="noopener noreffer">Upgrading from v0.9 to v0.10</a></li>
<li><a href="https://cert-manager.readthedocs.io/en/latest/tasks/upgrading/upgrading-0.10-0.11.html" target="_blank" rel="noopener noreffer">Upgrading from v0.10 to v0.11</a></li>
</ul>
<h2 id="reference-documentation">Reference documentation</h2>
<p>This section contains detailed reference documentation about cert-manager’s types and how it operates. It also includes some simple example configurations in order to help users activate advanced functionality of cert-manager.</p>
<p>Step by step user guides and tutorials can be found in the <a href="https://cert-manager.readthedocs.io/en/latest/tutorials/index.html" target="_blank" rel="noopener noreffer">tutorials</a> section.</p>
<h3 id="certificates">Certificates</h3>
<p>cert-manager has the concept of &lsquo;Certificates&rsquo; that define a desired X.509 certificate. A Certificate is a namespaced resource that references an Issuer or ClusterIssuer for information on how to obtain the certificate.</p>
<p>A simple Certificate could be defined as:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">acme-crt</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">acme-crt-secret</span><span class="w">
</span><span class="w">    </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">foo.example.com</span><span class="w">
</span><span class="w">    </span>- <span class="l">bar.example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ingressClass</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">domains</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">foo.example.com</span><span class="w">
</span><span class="w">        </span>- <span class="l">bar.example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span><span class="w">    </span><span class="c"># We can reference ClusterIssuers by changing the kind here.</span><span class="w">
</span><span class="w">    </span><span class="c"># The default value is Issuer (i.e. a locally namespaced Issuer)</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>This Certificate will tell cert-manager to attempt to use the Issuer named <code>letsencrypt-prod</code> to obtain a certificate key pair for the <code>foo.example.com</code> and <code>bar.example.com</code> domains. If successful, the resulting key and certificate will be stored in a secret named <code>acme-crt-secret</code> with keys of <code>tls.key</code> and <code>tls.crt</code> respectively. This secret will live in the same namespace as the <code>Certificate</code> resource.</p>
<p>The <code>dnsNames</code> field specifies a list of <a href="https://en.wikipedia.org/wiki/Subject_Alternative_Name" target="_blank" rel="noopener noreffer">Subject Alternative Names</a> to be associated with the certificate. If the <code>commonName</code> field is omitted, the first element in the list will be the common name.</p>
<p>The referenced Issuer must exist in the same namespace as the Certificate. A Certificate can alternatively reference a ClusterIssuer which is non-namespaced.</p>
<h4 id="certificate-duration-and-renewal-window">Certificate Duration and Renewal Window</h4>
<p>cert-manager Certificate resources also support custom validity durations and renewal windows.</p>
<p><strong>Important</strong>: The backend service implementation can choose to generate a certificate with a different validity period than what is requested in the issuer.</p>
<p>Although the duration and renewal periods are specified on the Certificate resources, the corresponding Issuer or ClusterIssuer must support this.</p>
<p>The table below shows the support state of the different backend services used by issuer types:</p>
<table>
<thead>
<tr>
<th>Issuer</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ACME</td>
<td>Only &lsquo;renewBefore&rsquo; supported</td>
</tr>
<tr>
<td>CA</td>
<td>Fully supported</td>
</tr>
<tr>
<td>Vault</td>
<td>Fully supported (although the requested duration must be lower than the configured Vault role&rsquo;s TTL)</td>
</tr>
<tr>
<td>Self Signed</td>
<td>Fully supported</td>
</tr>
<tr>
<td>Venafi</td>
<td>Fully supported</td>
</tr>
</tbody>
</table>
<p>The default duration for all certificates is 90 days and the default renewal windows is 30 days. This means that certificates are considered valid for 3 months and renewal will be attempted within 1 month of expiration.</p>
<p>The <em>duration</em> and <em>renewBefore</em> parameters must be given in the golang <a href="https://golang.org/pkg/time/#ParseDuration" target="_blank" rel="noopener noreffer">parseDuration string format</a>.</p>
<h4 id="example-usage">Example Usage</h4>
<p>Here an example of an issuer specifying the duration and renewal window.</p>
<p>The certificate from the previous section is extended with a validity period of 24 hours and to begin trying to renew 12 hours before the certificate expiration.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">example-tls</span><span class="w">
</span><span class="w">    </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">24h</span><span class="w">
</span><span class="w">    </span><span class="nt">renewBefore</span><span class="p">:</span><span class="w"> </span><span class="l">12h</span><span class="w">
</span><span class="w">    </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">foo.example.com</span><span class="w">
</span><span class="w">    </span>- <span class="l">bar.example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-internal-ca</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="certificate-key-encoding">Certificate Key Encoding</h4>
<p>cert-manager Certificate resources support two types of key encodings for its private key known as the private key cryptography standards (PKCS).</p>
<p>The two key encodings are <code>PKCS#1</code> and <code>PKCS#8</code>.</p>
<p>The default encoding is PKCS#1, if the <code>keyEncoding</code> field of the Certificate spec is left empty.</p>
<p>A limitation exists where once a Certificate resource is generated with a specific key encoding, it cannot be generated with a different key encoding.</p>
<h5 id="example-usage-1">Example Usage</h5>
<p>Here is an example of a Certificate specifying the use of PKCS#8 encoding on its private key.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-pkcs8-cert</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">example-pkcs8-secret</span><span class="w">
</span><span class="w">    </span><span class="nt">keyEncoding</span><span class="p">:</span><span class="w"> </span><span class="l">pkcs8</span><span class="w">
</span><span class="w">    </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">foo.example.com</span><span class="w">
</span><span class="w">    </span>- <span class="l">bar.example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-internal-ca</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="certificaterequests">CertificateRequests</h3>
<p>A &lsquo;CertificateRequest&rsquo; is a resource in cert-manager that is used to request x509 certificates from an issuer. The resource contains a base64 encoded string of a PEM encoded certificate request which is sent to the referenced issuer. A successful issuance will return a signed certificate, based on the certificate signing request. &lsquo;CertificateRequets&rsquo; are typically consumed and managed by controllers or other systems and should not be used by humans - unless
specifically needed.</p>
<p>A simple CertificateRequest looks like the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CertificateRequest</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-ca-cr</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">csr</span><span class="p">:</span><span class="w"> </span><span class="l">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQzNqQ0NBY1lDQVFBd2daZ3hDekFKQmdOVkJBWVRBbHBhTVE4d0RRWURWUVFJREFaQmNHOXNiRzh4RFRBTApCZ05WQkFjTUJFMXZiMjR4RVRBUEJnTlZCQW9NQ0VwbGRITjBZV05yTVJVd0V3WURWUVFMREF4alpYSjBMVzFoCmJtRm5aWEl4RVRBUEJnTlZCQU1NQ0dwdmMyaDJZVzVzTVN3d0tnWUpLb1pJaHZjTkFRa0JGaDFxYjNOb2RXRXUKZG1GdWJHVmxkWGRsYmtCcVpYUnpkR0ZqYXk1cGJ6Q0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQwpBUW9DZ2dFQkFLd01tTFhuQkNiRStZdTIvMlFtRGsxalRWQ3BvbHU3TlZmQlVFUWl1bDhFMHI2NFBLcDRZQ0c5Cmx2N2kwOHdFMEdJQUgydnJRQmxVd3p6ZW1SUWZ4YmQvYVNybzRHNUFBYTJsY2NMaFpqUlh2NEVMaER0aVg4N3IKaTQ0MWJ2Y01OM0ZPTlRuczJhRkJYcllLWGxpNG4rc0RzTEVuZmpWdXRiV01Zeis3M3ptaGZzclRJUjRzTXo3cQpmSzM2WFM4UkRjNW5oVVcyYU9BZ3lnbFZSOVVXRkxXNjNXYXVhcHg2QUpBR1RoZnJYdVVHZXlZUUVBSENxZmZmCjhyOEt3YTFYK1NwYm9YK1ppSVE0Nk5jQ043OFZnL2dQVHNLZmphZURoNWcyNlk1dEVidHd3MWdRbWlhK0MyRHIKWHpYNU13RzJGNHN0cG5kUnRQckZrU1VnMW1zd0xuc0NBd0VBQWFBQU1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQgpBUUFXR0JuRnhaZ0gzd0N3TG5IQ0xjb0l5RHJrMUVvYkRjN3BJK1VVWEJIS2JBWk9IWEFhaGJ5RFFLL2RuTHN3CjJkZ0J3bmlJR3kxNElwQlNxaDBJUE03eHk5WjI4VW9oR3piN0FVakRJWHlNdmkvYTJyTVhjWjI1d1NVQmxGc28Kd005dE1QU2JwcEVvRERsa3NsOUIwT1BPdkFyQ0NKNnZGaU1UbS9wMUJIUWJSOExNQW53U0lUYVVNSFByRzJVMgpjTjEvRGNMWjZ2enEyeENjYVoxemh2bzBpY1VIUm9UWmV1ZEp6MkxmR0VHM1VOb2ppbXpBNUZHd0RhS3BySWp3ClVkd1JmZWZ1T29MT1dNVnFNbGRBcTlyT24wNHJaT3Jnak1HSE9tTWxleVdPS1AySllhaDNrVDdKU01zTHhYcFYKV0ExQjRsLzFFQkhWeGlKQi9Zby9JQWVsCi0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=</span><span class="w">
</span><span class="w">    </span><span class="nt">isCA</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span><span class="nt">duraton</span><span class="p">:</span><span class="w"> </span><span class="l">90d</span><span class="w">
</span><span class="w">    </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ca-issuer</span><span class="w">
</span><span class="w">    </span><span class="c"># We can reference ClusterIssuers by changing the kind here.</span><span class="w">
</span><span class="w">    </span><span class="c"># The default value is Issuer (i.e. a locally namespaced Issuer)</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>This <code>CertificateRequest</code> will make cert-manager attempt to make the Issuer <code>letsencrypt-prod</code> in the default issuer pool <code>cert-manager.io</code>, return a certificate based upon the certificate signing request. Other groups can be specified inside the <code>issuerRef</code> which will change the targeted issuers to other external, third party issuers you may have installed.</p>
<p>The resource also exposes the option for stating the certificate as CA and requested validity duration.</p>
<p>A successful issuance of the certificate signing request will cause an update to the resource, setting the status with the signed certificate, the CA of the certificate (if available), and setting the <code>Ready</code> condition to <code>True</code>.</p>
<p>Whether issuance of the controller was successful or not, a retry of the issuance will <em>not</em> happen. It is the responsibility of some other controller to manage the logic and life cycle of CertificateRequets.</p>
<h4 id="conditions">Conditions</h4>
<p>CertificateRequests have a set of strongly defined conditions that should be used and relied upon by controllers or services to make decisions on what actions to take next on the resource. Each condition consists of the pair <code>Ready</code> - a boolean value, and <code>Reason</code> - a string. The set of values and meanings are as follows:</p>
<table>
<thead>
<tr>
<th><em>Ready</em></th>
<th><em>Reason</em></th>
<th>Condition Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>False</td>
<td>Pending</td>
<td>The CertificateRequest is currently pending, waiting for some other operation to take place. This could be that the Issuer does not exist yet or the Issuer is in the process of issuing a certificate.</td>
</tr>
<tr>
<td>False</td>
<td>Failed</td>
<td>The certificate has failed to be issued - either the returned certificate failed to be decoded or an instance of the referenced issuer used for signing failed. No further action will be taken on the CertificateRequest by it&rsquo;s controller.</td>
</tr>
<tr>
<td>True</td>
<td>Issued</td>
<td>A signed certificate has been successfully issued by the referenced Issuer.</td>
</tr>
</tbody>
</table>
<h3 id="orders">Orders</h3>
<p>Order resources are used by the ACME issuer to manage the lifecycle of an ACME &lsquo;order&rsquo; for a signed TLS certificate.</p>
<p>When a Certificate resource is created that references an ACME issuer, cert-manager will create an Order resource in order to obtain a signed certificate.</p>
<p>As an end-user, you will never need to manually create an Order resource. Once created, an Order cannot be changed. Instead, a new Order resource must be created.</p>
<h4 id="debugging-order-resources">Debugging Order resources</h4>
<p>In order to debug why a Certificate isn&rsquo;t being issued, we can first run <code>kubectl describe</code> on the Certificate resource we&rsquo;re having issues with:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe certificate example-com

...
Events:
    Type    Reason        Age   From          Message
    ----    ------        ----  ----          -------
    Normal  Generated     1m    cert-manager  Generated new private key
    Normal  OrderCreated  1m    cert-manager  Created Order resource <span class="s2">&#34;example-com-1217431265&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>We can see here that Certificate controller has created an Order resource to request a new certificate from the ACME server.</p>
<p>Orders are a useful source of information when debugging failures issuing ACME certificates. By running <code>kubectl describe order</code> on a particular order, information can be gleaned about failures in the process:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe order example-com-1248919344

...
Reason:
State:         pending
URL:           https://acme-v02.api.letsencrypt.org/acme/order/41123272/265506123
Events:
    Type    Reason   Age   From          Message
    ----    ------   ----  ----          -------
    Normal  Created  1m    cert-manager  Created Challenge resource <span class="s2">&#34;example-com-1217431265-0&#34;</span> <span class="k">for</span> domain <span class="s2">&#34;test1.example.com&#34;</span>
    Normal  Created  1m    cert-manager  Created Challenge resource <span class="s2">&#34;example-com-1217431265-1&#34;</span> <span class="k">for</span> domain <span class="s2">&#34;test2.example.com&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Here we can see that cert-manager has created two Challenge resources in order to fulfil(满足
) the requirements of the ACME order to obtain a signed certificate.</p>
<p>You can then go on to run <code>kubectl describe challenge example-com-1217431265-0</code> to further debug the progress of the Order.</p>
<p>Once an Order is successful, you should see an event like the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe order example-com-1248919344

...
Reason:
State:         valid
URL:           https://acme-v02.api.letsencrypt.org/acme/order/41123272/265506123
Events:
    Type    Reason      Age   From          Message
    ----    ------      ----  ----          -------
    Normal  Created     72s   cert-manager  Created Challenge resource <span class="s2">&#34;example-com-1217431265-0&#34;</span> <span class="k">for</span> domain <span class="s2">&#34;test1.example.com&#34;</span>
    Normal  Created     72s   cert-manager  Created Challenge resource <span class="s2">&#34;example-com-1217431265-1&#34;</span> <span class="k">for</span> domain <span class="s2">&#34;test2.example.com&#34;</span>
    Normal  OrderValid  4s    cert-manager  Order completed successfully
</code></pre></td></tr></table>
</div>
</div><p>If the Order is not completing successfully, you can debug the challenges for the Order by running <code>kubectl describe</code> on the Challenge resource.</p>
<p>For more information on debugging Challenge resources, read the <a href="https://cert-manager.readthedocs.io/en/latest/reference/challenges.html" target="_blank" rel="noopener noreffer">challenge reference docs</a>.</p>
<h3 id="challenges">Challenges</h3>
<p>Challenge resources are used by the ACME issuer to manage the lifecycle of an ACME &lsquo;challenge&rsquo; that must be completed in order to complete an &lsquo;authorization&rsquo; for a single DNS name/identifier.</p>
<p>When an <strong>Order</strong> resource is created, the order controller will create Challenge resources for each DNS name that is being authorized with the ACME server.</p>
<p>As an end-user, you will never need to manually create a Challenge resource. Once created, a Challenge cannot be changed. Instead, a new Challenge resource must be created.</p>
<h4 id="challenge-lifecycle">Challenge lifecycle</h4>
<p>After a Challenge resource has been created, it will be initially queued for processing. Processing will not begin until the challenge has been &lsquo;scheduled&rsquo; to start. This scheduling process prevents too many challenges being attempted at once, or multiple challenges for the same DNS name being attempted at once. For more information on how challenges are scheduled, read the <a href="https://cert-manager.readthedocs.io/en/latest/reference/challenges.html#challenge-scheduling" target="_blank" rel="noopener noreffer">challenge scheduling</a> section.</p>
<p>Once a challenge has been scheduled, it will first be &lsquo;synced&rsquo; with the ACME server in order to determine its current state. If the challenge is already valid, its &lsquo;state&rsquo; will be updated to &lsquo;valid&rsquo;, and also set <code>status.processing = false</code> to &lsquo;unschedule&rsquo; itself.</p>
<p>If the challenge is still &lsquo;pending&rsquo;, the challenge controller will &lsquo;present&rsquo; the challenge using the configured solver, one of HTTP01 or DNS01. Once the challenge has been &lsquo;presented&rsquo;, it will set <code>status.presented=true</code>.</p>
<p>Once &lsquo;presented&rsquo;, the challenge controller will perform a &lsquo;self check&rsquo; to ensure that the challenge has &lsquo;propagated&rsquo; (i.e. the authoritve DNS servers have been updated to respond correctly, or the changes to the ingress resources have been observed and in-use by the ingress controller).</p>
<p>If the self check fails, cert-manager will retry the self check with a fixed 10 second retry interval. Challenges that do not ever complete the self check will continue retrying until the user intervenes.</p>
<p>Once the self check is passing, the ACME &lsquo;authorization&rsquo; associated with this challenge will be &lsquo;accepted&rsquo; (TODO: add link to accepting challenges section of ACME spec).</p>
<p>The final state of the authorization after accepting it will be copied across to the Challenge&rsquo;s <code>status.state</code> field, as well as the &lsquo;error reason&rsquo; if an error occurred whilst the ACME server attempted to validate the challenge.</p>
<p>Once a Challenge has entered the <code>valid</code>, <code>invalid</code>, <code>expired</code> or <code>revoked</code> state, it will set <code>status.processing=false</code> to prevent any further processing of the ACME challenge, and to allow another challenge to be scheduled if there is a backlog of challenges to complete.</p>
<h4 id="challenge-scheduling">Challenge scheduling</h4>
<p>Instead of attempting to process all challenges at once, challenges are &lsquo;scheduled&rsquo; by cert-manager.</p>
<p>This scheduler applies a cap on the maximum number of simultaneous challenges as well as disallows two challenges for the same DNS name and solver type (http-01 or dns-01) to be completed at once.</p>
<p>The maximum number of challenges that can be processed at a time is 60 as of <a href="https://github.com/jetstack/cert-manager/blob/ddff78f011558e64186d61f7c693edced1496afa/pkg/controller/acmechallenges/scheduler/scheduler.go#L31-L33" target="_blank" rel="noopener noreffer">ddff78</a>.</p>
<h4 id="debugging-challenge-resources">Debugging Challenge resources</h4>
<p>In order to determine why an ACME Certificate is not being issued, we can debug using the &lsquo;Challenge&rsquo; resources that cert-manager has created.</p>
<p>In order to determine which Challenge is failing, you can run <code>kubectl get challenges</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get challenges

NAME                      STATE     DOMAIN            REASON                                     AGE
example-com-1217431265-0  pending   example.com       Waiting <span class="k">for</span> dns-01 challenge propagation   22s
</code></pre></td></tr></table>
</div>
</div><p>This shows that the challenge has been presented using the DNS01 solver successfully and now cert-manager is waiting for the &lsquo;self check&rsquo; to pass.</p>
<p>You can get more information about the challenge by using <code>kubectl describe</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl describe challenge example-com-1217431265-0

...
Status:
    Presented:   <span class="nb">true</span>
    Processing:  <span class="nb">true</span>
    Reason:      Waiting <span class="k">for</span> dns-01 challenge propagation
    State:       pending
Events:
    Type    Reason     Age   From          Message
    ----    ------     ----  ----          -------
    Normal  Started    19s   cert-manager  Challenge scheduled <span class="k">for</span> processing
    Normal  Presented  16s   cert-manager  Presented challenge using dns-01 challenge mechanism
</code></pre></td></tr></table>
</div>
</div><p>Progress about the state of each challenge will be recorded either as Events
or on the Challenge&rsquo;s <code>status</code> block (as shown above).</p>
<h3 id="issuers">Issuers</h3>
<p>Issuers (and <a href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html" target="_blank" rel="noopener noreffer">ClusterIssuers</a>) represent a certificate authority from which signed x509 certificates can be obtained, such as <a href="https://letsencrypt.org/" target="_blank" rel="noopener noreffer">Let&rsquo;s Encrypt</a>. You will need at least one Issuer or ClusterIssuer in order to begin issuing certificates within your cluster.</p>
<p>An example of an Issuer type is ACME. A simple ACME issuer could be defined as:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">edge-services</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># The ACME server URL</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-v02.api.letsencrypt.org/directory</span><span class="w">
</span><span class="w">    </span><span class="c"># Email address used for ACME registration</span><span class="w">
</span><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">user@example.com</span><span class="w">
</span><span class="w">    </span><span class="c"># Name of a secret used to store the ACME account private key</span><span class="w">
</span><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># An empty &#39;selector&#39; means that this solver matches all domains</span><span class="w">
</span><span class="w">    </span>- <span class="nt">selector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">        </span><span class="nt">http01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>This is the simplest of ACME issuers - it specifies no DNS-01 challenge providers. HTTP-01 validation can be performed through using Ingress resources by enabling the HTTP-01 challenge mechanism (with the <code>http01: {}</code> field).</p>
<p>More information on configuring ACME Issuers can be found <a href="https://cert-manager.readthedocs.io/en/latest/tasks/issuers/setup-acme/index.html" target="_blank" rel="noopener noreffer">here</a>.</p>
<h4 id="namespacing">Namespacing</h4>
<p>An Issuer is a namespaced resource, and it is not possible to issue certificates from an Issuer in a different namespace. This means you will need to create an Issuer in each namespace you wish to obtain Certificates in.</p>
<p>If you want to create a single issuer than can be consumed in multiple namespaces, you should consider creating a <code>ClusterIssuer</code> resource. This is almost identical to the Issuer resource, however is non-namespaced and so it can be used to issue Certificates across all namespaces.</p>
<h4 id="ambient-credentials">Ambient Credentials</h4>
<p>Some API clients are able to infer credentials to use from the environment they run within. Notably, this includes cloud instance-metadata stores and environment variables.</p>
<p>In cert-manager, the term &lsquo;ambient credentials&rsquo; refers to such credentials. They are always drawn from the environment of the &lsquo;cert-manager-controller&rsquo; deployment.</p>
<h5 id="example-usage-2">Example Usage</h5>
<p>If cert-manager is deployed in an environment with ambient AWS credentials, such as with a kube2iam_ role, the following ClusterIssuer would make use of those credentials to perform the ACME DNS01 challenge with route53.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-v02.api.letsencrypt.org/directory</span><span class="w">
</span><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">user@example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># An empty &#39;selector&#39; means that this solver matches all domains</span><span class="w">
</span><span class="w">    </span>- <span class="nt">selector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">        </span><span class="nt">dns01</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">providers</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">route53</span><span class="w">
</span><span class="w">            </span><span class="nt">route53</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">us-east-1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>It is important to note that the <code>route53</code> section does not specify any <code>accessKeyID</code> or <code>secretAccessKeySecretRef</code>. If either of these are specified, ambient credentials will not be used.</p>
<h5 id="when-are-ambient-credentials-used">When are Ambient Credentials used</h5>
<p>Ambient credentials are supported for the &lsquo;route53&rsquo; ACME DNS01 challenge provider.</p>
<p>They will only be used if no credentials are supplied, even if the supplied credentials are invalid.</p>
<p>By default, ambient credentials may be used by ClusterIssuers, but not regular issuers. The <code>--issuer-ambient-credentials</code> and <code>--cluster-issuer-ambient-credentials=false</code> flags on cert-manager may be used to override this behavior.</p>
<p>Note that ambient credentials are disabled for regular Issuers by default to ensure unprivileged users who may create issuers cannot issue certificates using any credentials cert-manager incidentally has access to.</p>
<h4 id="supported-issuer-types-1">Supported Issuer types</h4>
<p>cert-manager has been designed to support pluggable Issuer backends. The currently supported Issuer types are:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ACME</td>
<td>Supports obtaining certificates from an ACME server, validating with HTTP01 or DNS01</td>
</tr>
<tr>
<td>CA</td>
<td>Supports issuing certificates using a simple signing keypair, stored in a Secret in the Kubernetes API server</td>
</tr>
<tr>
<td>Vault</td>
<td>Supports issuing certificates using HashiCorp Vault.</td>
</tr>
<tr>
<td>Self signed</td>
<td>Supports issuing self signed certificates</td>
</tr>
<tr>
<td>Venafi</td>
<td>Supports issuing certificates from Venafi Cloud &amp; TPP</td>
</tr>
</tbody>
</table>
<p>Each Issuer resource is of one, and only one type. The type of an Issuer is inferred by which field it specifies in its spec, such as <code>spec.acme</code> for the ACME issuer, or <code>spec.ca</code> for the CA based issuer.</p>
<h3 id="clusterissuers">ClusterIssuers</h3>
<p>ClusterIssuers are a resource type similar to <a href="https://cert-manager.readthedocs.io/en/latest/reference/issuers.html" target="_blank" rel="noopener noreffer">Issuers</a>. They are specified in exactly the same way, but they do not belong to a single namespace and can be referenced by Certificate resources from multiple different namespaces.</p>
<p>They are particularly useful when you want to provide the ability to obtain certificates from a central authority (e.g. Letsencrypt, or your internal CA) and you run single-tenant clusters.</p>
<p>The docs for Issuer resources apply equally to ClusterIssuers.</p>
<p>You can specify a ClusterIssuer resource by changing the <code>kind</code> attribute of an Issuer to <code>ClusterIssuer</code>, and removing the <code>metadata.namespace</code> attribute:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nn">...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>We can then reference a ClusterIssuer from a Certificate resource by setting the <code>spec.issuerRef.kind</code> field to ClusterIssuer:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1alpha2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-certificate</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">my-namespace</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">my-certificate-secret</span><span class="w">
</span><span class="w">    </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span><span class="w">    </span><span class="l">...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>When referencing a <code>Secret</code> resource in <code>ClusterIssuer</code> resources (eg <code>apiKeySecretRef</code>) the <code>Secret</code> needs to be in the same namespace as the <code>cert-manager</code> controller pod. You can optionally override this by using the <code>--cluster-resource-namespace</code> argument to the controller.</p>
<h3 id="cainjector-controller">cainjector controller</h3>
<p>The cainjector controller injects a Certificate into the caBundle field of ValidatingWebhookConfiguration, MutatingWebhookConfiguration or APIService resources annotated with:</p>
<ul>
<li><code>cert-manager.io/inject-apiserver-ca</code>: &ldquo;true&rdquo; Injects the cluster CA.</li>
<li><code>cert-manager.io/inject-ca-from</code>: <code>&lt;NAMESPACE&gt;/&lt;CERTIFICATE&gt;</code> Injects the CA from the specified certificate.</li>
</ul>
<h3 id="api-documentation">API documentation</h3>
<p><a href="https://cert-manager.readthedocs.io/en/latest/reference/api-docs/index.html">https://cert-manager.readthedocs.io/en/latest/reference/api-docs/index.html</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2019-10-18</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/k8s/cert-manager-v0.11-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://msdemt.github.io/posts/k8s/cert-manager-v0.11-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" data-title="Cert Manager v0.11 官方文档阅读笔记"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://msdemt.github.io/posts/k8s/cert-manager-v0.11-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://msdemt.github.io/posts/k8s/cert-manager-v0.11-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" data-title="Cert Manager v0.11 官方文档阅读笔记"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://msdemt.github.io/posts/k8s/cert-manager-v0.11-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" data-title="Cert Manager v0.11 官方文档阅读笔记"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://msdemt.github.io/posts/k8s/cert-manager-v0.11-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" data-title="Cert Manager v0.11 官方文档阅读笔记" data-ralateuid="xxxx"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/k8s/metallb-v0.8.1-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" class="prev" rel="prev" title="MetalLB-v0.8.1-官方文档阅读笔记"><i class="fas fa-angle-left fa-fw"></i>MetalLB-v0.8.1-官方文档阅读笔记</a>
            <a href="/posts/k8s/nfs-storageclsss-20191019-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" class="next" rel="next" title="Nfs-Storageclsss-20191019-官方文档阅读笔记">Nfs-Storageclsss-20191019-官方文档阅读笔记<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.80.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">hekai</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.zh-cn","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
