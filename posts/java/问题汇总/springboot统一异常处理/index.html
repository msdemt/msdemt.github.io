<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Springboot统一异常处理 - MyBlog</title><meta name="Description" content="我的博客"><meta property="og:title" content="Springboot统一异常处理" />
<meta property="og:description" content="参考： https://www.jianshu.com/p/3f3d9e8d1efa https://www.jianshu.com/p/179daa24ef52 https://www.cnblogs.com/wang-yaz/p/13225830.html https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-error-handling 本文使用的 spring boot 版本为 2.4.2 使用 ExceptionHandler 注解处理 Controller 异常 Spring 3.0 版本新增了 @ExceptionHandler 注解，它的作用是：若在某个 Controller 类中定义一个异常处理方法，并在该异常处理" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://msdemt.github.io/posts/java/%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/springboot%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" />
<meta property="og:image" content="https://msdemt.github.io/logo.png"/>
<meta property="article:published_time" content="2021-02-01T15:48:46+08:00" />
<meta property="article:modified_time" content="2021-02-01T15:48:46+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://msdemt.github.io/logo.png"/>

<meta name="twitter:title" content="Springboot统一异常处理"/>
<meta name="twitter:description" content="参考： https://www.jianshu.com/p/3f3d9e8d1efa https://www.jianshu.com/p/179daa24ef52 https://www.cnblogs.com/wang-yaz/p/13225830.html https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-error-handling 本文使用的 spring boot 版本为 2.4.2 使用 ExceptionHandler 注解处理 Controller 异常 Spring 3.0 版本新增了 @ExceptionHandler 注解，它的作用是：若在某个 Controller 类中定义一个异常处理方法，并在该异常处理"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://msdemt.github.io/posts/java/%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/springboot%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" /><link rel="prev" href="https://msdemt.github.io/posts/java/%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/edge%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84jsonview%E6%8F%92%E4%BB%B6%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BAjson/" /><link rel="next" href="https://msdemt.github.io/posts/idea/idea%E9%85%8D%E7%BD%AE%E5%AD%97%E7%AC%A6%E9%9B%86%E7%BC%96%E7%A0%81/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Springboot统一异常处理",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/msdemt.github.io\/posts\/java\/%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB\/springboot%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86\/"
        },"image": ["https:\/\/msdemt.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","wordcount":  10956 ,
        "url": "https:\/\/msdemt.github.io\/posts\/java\/%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB\/springboot%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86\/","datePublished": "2021-02-01T15:48:46+08:00","dateModified": "2021-02-01T15:48:46+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/msdemt.github.io\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "xxxx"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="MyBlog"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>MyBlog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/categories/documentation/"> 文档 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/dillonzq/LoveIt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="MyBlog"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>MyBlog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/categories/documentation/" title="">文档</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/dillonzq/LoveIt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Springboot统一异常处理</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>xxxx</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-02-01">2021-02-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 10956 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 22 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#使用-exceptionhandler-注解处理-controller-异常">使用 ExceptionHandler 注解处理 Controller 异常</a></li>
    <li><a href="#controlleradvice-和-exceptionhandler-注解组合处理异常">ControllerAdvice 和 ExceptionHandler 注解组合处理异常</a>
      <ul>
        <li><a href="#异常的优雅判断">异常的优雅判断</a></li>
        <li><a href="#自定义-assert">自定义 Assert</a></li>
        <li><a href="#善解人意的-enum">善解人意的 Enum</a></li>
        <li><a href="#统一异常处理类">统一异常处理类</a>
          <ul>
            <li><a href="#异常处理器说明">异常处理器说明</a>
              <ul>
                <li><a href="#servlet-容器产生的异常">servlet 容器产生的异常</a></li>
                <li><a href="#业务异常">业务异常</a></li>
              </ul>
            </li>
            <li><a href="#异于常人的404">异于常人的404</a></li>
            <li><a href="#404的复现">404的复现</a></li>
            <li><a href="#404页面返回自定义格式的json">404页面返回自定义格式的json</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><blockquote>
<p>参考：<br>
<a href="https://www.jianshu.com/p/3f3d9e8d1efa">https://www.jianshu.com/p/3f3d9e8d1efa</a><br>
<a href="https://www.jianshu.com/p/179daa24ef52">https://www.jianshu.com/p/179daa24ef52</a><br>
<a href="https://www.cnblogs.com/wang-yaz/p/13225830.html">https://www.cnblogs.com/wang-yaz/p/13225830.html</a><br>
<a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-error-handling">https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-error-handling</a></p>
</blockquote>
<p>本文使用的 <code>spring boot</code> 版本为 <code>2.4.2</code></p>
<h2 id="使用-exceptionhandler-注解处理-controller-异常">使用 ExceptionHandler 注解处理 Controller 异常</h2>
<p>Spring 3.0 版本新增了 <code>@ExceptionHandler</code> 注解，它的作用是：若在某个 Controller 类中定义一个异常处理方法，并在该异常处理方法上添加 <code>@ExceptionHandler</code> 注解（注解中指定需要处理的异常），那么当该 Controller 类中出现指定的异常时，会执行该异常处理方法。该异常处理方法可以使用 spring mvc 提供的数据绑定，比如注入 HttpServletRequest 等，还可以接受一个当前抛出的 Throwable 对象。</p>
<p>示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.msdemt.simple.exception_handler.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="nd">@Slf4j</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;test&#34;</span><span class="o">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span><span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;run&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">RuntimeExceptionTest</span><span class="o">(){</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;runtime exception&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;null&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">NullPointerExceptionTest</span><span class="o">(){</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;null pointer exception&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@ExceptionHandler</span><span class="o">({</span><span class="n">NullPointerException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">RuntimeException</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleException</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>但是，这样一来，就必须在每个 Controller 类都定义一套这样的异常处理方法，就会造成冗余代码，而且若需要新增一种异常的处理逻辑，就必须修改所有的 Controller 类，很不优雅。</p>
<p>为了解决冗余代码，可以将所有的 Controller 继承一个 BaseController 基类，在 BaseController 统一处理异常。但是这样的代码由侵入性和耦合性，而且由于 Java 是单继承的，如此 Controller 就无法继承其他类了。</p>
<p>示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.msdemt.simple.exception_handler.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BaseController</span> <span class="o">{</span>
    <span class="nd">@ExceptionHandler</span><span class="o">({</span><span class="n">NullPointerException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">RuntimeException</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleException</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.msdemt.simple.exception_handler.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="nd">@Slf4j</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;test&#34;</span><span class="o">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="kd">extends</span> <span class="n">BaseController</span><span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;run&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">RuntimeExceptionTest</span><span class="o">(){</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;runtime exception&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;null&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">NullPointerExceptionTest</span><span class="o">(){</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;null pointer exception&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>java 8 版本开始支持接口中定义静态方法或默认方法，将 BaseController 定义为接口，这样 Controller 就可以继承其他类了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.msdemt.simple.exception_handler.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BaseController</span> <span class="o">{</span>
    <span class="nd">@ExceptionHandler</span><span class="o">({</span><span class="n">NullPointerException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">RuntimeException</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
    <span class="kd">static</span> <span class="n">String</span> <span class="nf">handleException</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>或</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.msdemt.simple.exception_handler.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BaseController</span> <span class="o">{</span>
    <span class="nd">@ExceptionHandler</span><span class="o">({</span><span class="n">NullPointerException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">RuntimeException</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
    <span class="k">default</span> <span class="n">String</span> <span class="nf">handleException</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.msdemt.simple.exception_handler.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="nd">@Slf4j</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;test&#34;</span><span class="o">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="kd">implements</span> <span class="n">BaseController</span><span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;run&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">RuntimeExceptionTest</span><span class="o">(){</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;runtime exception&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;null&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">NullPointerExceptionTest</span><span class="o">(){</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;null pointer exception&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上述的各种方式，Controller 和 异常处理器（<code>@ExceptionHandler</code> 注解的方法）耦合在一起的。</p>
<p>Spring 3.2 版本新增了 <code>@ControllerAdvice</code> 注解，可以与 <code>@ExceptionHandler</code> 注解配套使用，实现 Controller 和 异常处理器 的解耦：在单独的一个类中，使用 <code>@ControllerAdvice</code> 注解该类，并且在该类中添加使用 <code>@ExceptionHandler</code> 注解的各种异常的处理方法，实现统一处理所有 Controller 中出现的异常。</p>
<p>Spring 4.3 版本增加了一个注解 <code>@RestControllerAdvice</code>，该注解结合了 <code>@ControllerAdvice</code> 和 <code>@ResponseBody</code> 。</p>
<h2 id="controlleradvice-和-exceptionhandler-注解组合处理异常">ControllerAdvice 和 ExceptionHandler 注解组合处理异常</h2>
<h3 id="异常的优雅判断">异常的优雅判断</h3>
<p>一般，我们使用 <code>if {...}</code> 等判断语句对异常进行判断，如果需要判断的地方很多，则 if 判断语句特别多，很不优雅。Spring 提供的 <code>org.springframework.util.Assert</code> ，能够让我们优雅地判断并抛出异常。示例如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Integer</span> <span class="n">i</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;参数 i 不能为 null&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Integer</span> <span class="n">i</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="s">&#34;参数 i 不能为 null&#34;</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>Assert.notNull()</code> 是怎么实现的呢？如下是 <code>Assert.notNull()</code> 的源码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * Assert that an object is not null.
</span><span class="cm"> * Assert.notNull(clazz, &#34;The class must not be null&#34;);
</span><span class="cm"> * Params:
</span><span class="cm"> *     object – the object to check
</span><span class="cm"> *     message – the exception message to use if the assertion fails
</span><span class="cm"> * Throws:
</span><span class="cm"> *     IllegalArgumentException – if the object is null
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">notNull</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">Object</span> <span class="n">object</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到， Assert 其实就是帮助我们把 <code>if {...}</code> 封装了下，从而使代码更加优雅。</p>
<p>那么我们能不能模仿 <code>org.springframework.util.Assert</code> ，也写一个断言类，不过断言失败后抛出的异常不是 <code>IllegalArgumentException</code> 这些内置异常，而是我们自定义的异常？</p>
<h3 id="自定义-assert">自定义 Assert</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Assert</span> <span class="o">{</span>
    <span class="cm">/**
</span><span class="cm">     * 新建异常
</span><span class="cm">     * @param args
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="n">BaseException</span> <span class="nf">newException</span><span class="o">(</span><span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 新建异常
</span><span class="cm">     * @param t
</span><span class="cm">     * @param args
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="n">BaseException</span> <span class="nf">newException</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 若判断 obj 对象为空，则新建自定义异常并抛出
</span><span class="cm">     *
</span><span class="cm">     * @param obj 待判断对象
</span><span class="cm">     */</span>
    <span class="k">default</span> <span class="kt">void</span> <span class="nf">assertNotNull</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">newException</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>其中，<code>BaseException</code> 是所有自定义异常的基类。</p>
<p>上面的 <code>Assert</code> 断言方法是使用接口的默认方法（jdk8新特性），当断言失败后，抛出的异常不是具体的某个异常，而是由 <code>newException</code> 接口方法提供。因为业务逻辑中出现的异常基本都是对应特定的场景，比如根据用户 id 获取用户信息，查询结果为 null ，此时抛出的异常可能为 <code>UserNotFoundException</code> ，并且有特定的异常代码（比如 7001）和异常描述（比如“用户不存在”），所以，具体抛出什么异常，由 <code>Assert</code> 的实现类决定。</p>
<p>按照上面的说法，岂不是有多少异常，就得定义多少的断言类和异常类？</p>
<h3 id="善解人意的-enum">善解人意的 Enum</h3>
<p>自定义异常 <code>BaseException</code> 有 2 个属性，即 code 、 mess ，可以和枚举 enum 结合</p>
<p>异常枚举接口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * 返回枚举接口
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IResponseEnum</span> <span class="o">{</span>
    <span class="cm">/**
</span><span class="cm">     * 获取返回代码
</span><span class="cm">     * @return 返回代码
</span><span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">getCode</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * 获取返回描述
</span><span class="cm">     * @return 返回描述
</span><span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">getMessage</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>基础异常类（包含异常枚举接口）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Getter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BaseException</span> <span class="kd">extends</span> <span class="n">RuntimeException</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 异常信息枚举
</span><span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">IResponseEnum</span> <span class="n">responseEnum</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * 异常消息参数
</span><span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">BaseException</span><span class="o">(</span><span class="n">IResponseEnum</span> <span class="n">responseEnum</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">responseEnum</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">responseEnum</span> <span class="o">=</span> <span class="n">responseEnum</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">BaseException</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">responseEnum</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IResponseEnum</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCode</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">code</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">message</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">BaseException</span><span class="o">(</span><span class="n">IResponseEnum</span> <span class="n">responseEnum</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">responseEnum</span> <span class="o">=</span> <span class="n">responseEnum</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">BaseException</span><span class="o">(</span><span class="n">IResponseEnum</span> <span class="n">responseEnum</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">responseEnum</span> <span class="o">=</span> <span class="n">responseEnum</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>业务异常类（继承基础异常类，也包含了异常枚举接口）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BusinessException</span> <span class="kd">extends</span> <span class="n">BaseException</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="n">IResponseEnum</span> <span class="n">responseEnum</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">responseEnum</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="n">IResponseEnum</span> <span class="n">responseEnum</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">responseEnum</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">message</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>业务异常断言接口（接口可以多继承，该接口继承了异常枚举接口和自定义断言接口，使用默认方法覆盖了自定义断言接口的新建异常方法）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BusinessExceptionAssert</span> <span class="kd">extends</span> <span class="n">IResponseEnum</span><span class="o">,</span> <span class="n">Assert</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="k">default</span> <span class="n">BaseException</span> <span class="nf">newException</span><span class="o">(</span><span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">MessageFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">args</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="k">default</span> <span class="n">BaseException</span> <span class="nf">newException</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">MessageFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">args</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">msg</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>业务异常枚举类，该类实现了业务异常断言接口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Getter</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="n">ResponseEnum</span> <span class="kd">implements</span> <span class="n">BusinessExceptionAssert</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * 请求实体为空
</span><span class="cm">     */</span>
    <span class="n">REQUEST_IS_NULL</span><span class="o">(</span><span class="s">&#34;1001&#34;</span><span class="o">,</span> <span class="s">&#34;Request is null.&#34;</span><span class="o">),</span>
    <span class="cm">/**
</span><span class="cm">     * 用户不存在
</span><span class="cm">     */</span>
    <span class="n">USER_NOT_EXIST</span><span class="o">(</span><span class="s">&#34;1002&#34;</span><span class="o">,</span> <span class="s">&#34;User not exist.&#34;</span><span class="o">)</span>

    <span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 返回码
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * 返回消息
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>使用示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/user&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">IUserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nf">UserController</span><span class="o">(</span><span class="n">IUserService</span> <span class="n">userService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userService</span> <span class="o">=</span> <span class="n">userService</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">R</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUserById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">){</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">ResponseEnum</span><span class="o">.</span><span class="na">USER_NOT_EXIST</span><span class="o">.</span><span class="na">assertNotNull</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">R</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上文使用 <code>assertNotNull()</code> 判断 <code>user</code> 是否为空，</p>
<p>若不使用断言，代码可能如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="s">&#34;1002&#34;</span><span class="o">,</span> <span class="s">&#34;User not exist.&#34;</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>断言 <code>assertNotNull()</code> 方法实现如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * 若判断 obj 对象为空，则新建自定义异常并抛出
</span><span class="cm"> *
</span><span class="cm"> * @param obj 待判断对象
</span><span class="cm"> */</span>
<span class="k">default</span> <span class="kt">void</span> <span class="nf">assertNotNull</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">newException</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>下面来分析下代码 <code>ResponseEnum.USER_NOT_EXIST.assertNotNull(user);</code> ，来看是如何实现的</p>
<p>因为枚举类 <code>ResponseEnum</code> 实现了接口 <code>BusinessExceptionAssert</code>，且接口 <code>BusinessExceptionAssert</code> 实现了自定义的 <code>Assert</code> 接口，所以枚举类 <code>ResponseEnum</code> 中的枚举实例可以调用接口 <code>Assert</code> 中的方法（此处为 <code>assertNotNull()</code>），方法内判断对象 user 为 null ，调用 <code>newException()</code> 方法新建异常，并将异常抛出。</p>
<p>此时 <code>newException()</code> 方法由接口 <code>BusinessExceptionAssert</code> 的默认方法实现，方法内容如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="k">default</span> <span class="n">BaseException</span> <span class="nf">newException</span><span class="o">(</span><span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">args</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">MessageFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>此时， this 是 <code>ResponseEnum.USER_NOT_EXIST</code> ，获取枚举实例 <code>ResponseEnum.USER_NOT_EXIST</code> 中的 message ，并将参数配置到 message 的占位符中（如果有参数的话），然后新建一个业务异常。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BusinessException</span> <span class="kd">extends</span> <span class="n">BaseException</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="n">IResponseEnum</span> <span class="n">responseEnum</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">responseEnum</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="n">IResponseEnum</span> <span class="n">responseEnum</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">responseEnum</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">message</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，业务类异常（BusinessException）是通过构造方法新建时调用父类（<code>BaseException</code>）的构造方法创建的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Getter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BaseException</span> <span class="kd">extends</span> <span class="n">RuntimeException</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 异常信息枚举
</span><span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">IResponseEnum</span> <span class="n">responseEnum</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * 异常消息参数
</span><span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">BaseException</span><span class="o">(</span><span class="n">IResponseEnum</span> <span class="n">responseEnum</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">responseEnum</span> <span class="o">=</span> <span class="n">responseEnum</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>业务类异常（BusinessException）创建成功后，通过 <code>throw</code> 抛出该异常。</p>
<p>这样，就实现了使用枚举类汇总异常实例，然后通过自定义的断言类判断并抛出该异常。</p>
<p>以后每增加一种异常，只需增加一个枚举实例即可。</p>
<p>使用枚举类结合（继承）<code>Assert</code>，只需根据特定的异常情况定义不同的枚举实例，就能够针对不同情况抛出特定的异常（这里指特定异常代码和异常消息的异常），这样既不用定义大量的异常类，同时也具备了断言的良好可读性。</p>
<h3 id="统一异常处理类">统一异常处理类</h3>
<p>上文使用枚举类结合（继承）<code>Assert</code>实现了判断并抛出异常，下面来介绍异常的统一处理。</p>
<p>使用 <code>@ControllerAdvice</code> 结合 <code>@ExceptionHandler</code> 实现异常的统一处理。</p>
<p>统一异常处理器代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.msdemt.simple.unified_exception_handler_demo.exception.handler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.msdemt.simple.unified_exception_handler_demo.constant.enums.ArgumentResponseEnum</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.msdemt.simple.unified_exception_handler_demo.constant.enums.CommonResponseEnum</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.msdemt.simple.unified_exception_handler_demo.constant.enums.ServletResponseEnum</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.msdemt.simple.unified_exception_handler_demo.exception.BaseException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.msdemt.simple.unified_exception_handler_demo.exception.BusinessException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.msdemt.simple.unified_exception_handler_demo.i18n.UnifiedMessageSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.msdemt.simple.unified_exception_handler_demo.pojo.response.ErrorResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.ConversionNotSupportedException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.TypeMismatchException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.converter.HttpMessageNotReadableException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.converter.HttpMessageNotWritableException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.FieldError</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.ObjectError</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.HttpMediaTypeNotAcceptableException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.HttpMediaTypeNotSupportedException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.HttpRequestMethodNotSupportedException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.MethodArgumentNotValidException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.MissingPathVariableException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.MissingServletRequestParameterException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.ServletRequestBindingException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestControllerAdvice</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.async.AsyncRequestTimeoutException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.multipart.support.MissingServletRequestPartException</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 全局异常处理器
</span><span class="cm"> */</span>
<span class="nd">@Slf4j</span>
<span class="nd">@RestControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnifiedExceptionHandler</span> <span class="o">{</span>
    <span class="cm">/**
</span><span class="cm">     * 生产环境
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">ENV_PROD</span> <span class="o">=</span> <span class="s">&#34;prod&#34;</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">UnifiedMessageSource</span> <span class="n">unifiedMessageSource</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nf">UnifiedExceptionHandler</span><span class="o">(</span><span class="n">UnifiedMessageSource</span> <span class="n">unifiedMessageSource</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">unifiedMessageSource</span> <span class="o">=</span> <span class="n">unifiedMessageSource</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 当前环境，默认dev环境
</span><span class="cm">     */</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${spring.profiles.active:dev}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">profile</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 获取国际化消息
</span><span class="cm">     *
</span><span class="cm">     * @param e 异常
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="o">(</span><span class="n">BaseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="s">&#34;response.&#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getResponseEnum</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">unifiedMessageSource</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getArgs</span><span class="o">());</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">message</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">message</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 业务异常处理器
</span><span class="cm">     *
</span><span class="cm">     * @param e 异常
</span><span class="cm">     * @return 异常结果
</span><span class="cm">     */</span>
    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">BusinessException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ErrorResponse</span> <span class="nf">handleBusinessException</span><span class="o">(</span><span class="n">BaseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="n">ErrorResponse</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getResponseEnum</span><span class="o">().</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">getMessage</span><span class="o">(</span><span class="n">e</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 自定义异常处理器
</span><span class="cm">     *
</span><span class="cm">     * @param e 异常
</span><span class="cm">     * @return 异常结果
</span><span class="cm">     */</span>
    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">BaseException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ErrorResponse</span> <span class="nf">handleBaseException</span><span class="o">(</span><span class="n">BaseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="n">ErrorResponse</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getResponseEnum</span><span class="o">().</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">getMessage</span><span class="o">(</span><span class="n">e</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * servlet容器异常处理
</span><span class="cm">     *
</span><span class="cm">     * @param e 异常
</span><span class="cm">     * @return 异常结果
</span><span class="cm">     */</span>
    <span class="nd">@ExceptionHandler</span><span class="o">({</span>
            <span class="c1">//NoHandlerFoundException.class, //该异常由自定义控制器捕获处理
</span><span class="c1"></span>            <span class="n">HttpRequestMethodNotSupportedException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">HttpMediaTypeNotSupportedException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">HttpMediaTypeNotAcceptableException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">MissingPathVariableException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">MissingServletRequestParameterException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">TypeMismatchException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">HttpMessageNotReadableException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">HttpMessageNotWritableException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">HttpMediaTypeNotAcceptableException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="c1">// BindException.class,
</span><span class="c1"></span>            <span class="c1">// MethodArgumentNotValidException.class
</span><span class="c1"></span>            <span class="n">ServletRequestBindingException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">ConversionNotSupportedException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">MissingServletRequestPartException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">AsyncRequestTimeoutException</span><span class="o">.</span><span class="na">class</span>
    <span class="o">})</span>
    <span class="kd">public</span> <span class="n">ErrorResponse</span> <span class="nf">handleServletException</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="n">CommonResponseEnum</span><span class="o">.</span><span class="na">SERVER_ERROR</span><span class="o">.</span><span class="na">getCode</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ServletResponseEnum</span> <span class="n">servletExceptionEnum</span> <span class="o">=</span> <span class="n">ServletResponseEnum</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">());</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">servletExceptionEnum</span><span class="o">.</span><span class="na">getCode</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalArgumentException</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;class [{}] not defined in enum {}&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">ServletResponseEnum</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">ENV_PROD</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">profile</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 当为生产环境, 不适合把具体的异常信息展示给用户, 比如404.
</span><span class="c1"></span>            <span class="n">code</span> <span class="o">=</span> <span class="n">CommonResponseEnum</span><span class="o">.</span><span class="na">SERVER_ERROR</span><span class="o">.</span><span class="na">getCode</span><span class="o">();</span>
            <span class="n">BaseException</span> <span class="n">baseException</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BaseException</span><span class="o">(</span><span class="n">CommonResponseEnum</span><span class="o">.</span><span class="na">SERVER_ERROR</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">getMessage</span><span class="o">(</span><span class="n">baseException</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">ErrorResponse</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="k">new</span> <span class="n">ErrorResponse</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>


    <span class="cm">/**
</span><span class="cm">     * 参数绑定异常处理器
</span><span class="cm">     *
</span><span class="cm">     * @param e 异常
</span><span class="cm">     * @return 异常结果
</span><span class="cm">     */</span>
    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">BindException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ErrorResponse</span> <span class="nf">handleBindException</span><span class="o">(</span><span class="n">BindException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;参数绑定校验异常&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">wrapperBindingResult</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getBindingResult</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 参数校验(Valid)异常处理器
</span><span class="cm">     * 将校验失败的所有异常组合成一条错误信息
</span><span class="cm">     *
</span><span class="cm">     * @param e 异常
</span><span class="cm">     * @return 异常结果
</span><span class="cm">     */</span>
    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">MethodArgumentNotValidException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ErrorResponse</span> <span class="nf">handleValidException</span><span class="o">(</span><span class="n">MethodArgumentNotValidException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;参数绑定校验异常&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">wrapperBindingResult</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getBindingResult</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 包装绑定异常结果
</span><span class="cm">     *
</span><span class="cm">     * @param bindingResult 绑定结果
</span><span class="cm">     * @return 异常结果
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">ErrorResponse</span> <span class="nf">wrapperBindingResult</span><span class="o">(</span><span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">StringBuilder</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">ObjectError</span> <span class="n">error</span> <span class="o">:</span> <span class="n">bindingResult</span><span class="o">.</span><span class="na">getAllErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;, &#34;</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">error</span> <span class="k">instanceof</span> <span class="n">FieldError</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">msg</span><span class="o">.</span><span class="na">append</span><span class="o">(((</span><span class="n">FieldError</span><span class="o">)</span> <span class="n">error</span><span class="o">).</span><span class="na">getField</span><span class="o">()).</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;: &#34;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="na">getDefaultMessage</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&#34;&#34;</span> <span class="o">:</span> <span class="n">error</span><span class="o">.</span><span class="na">getDefaultMessage</span><span class="o">());</span>

        <span class="o">}</span>

        <span class="k">return</span> <span class="k">new</span> <span class="n">ErrorResponse</span><span class="o">(</span><span class="n">ArgumentResponseEnum</span><span class="o">.</span><span class="na">PARAMETER_VERIFICATION_FAILED</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">msg</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">2</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 空指针异常单独处理
</span><span class="cm">     * 若在Exception中处理，则返回的 e.getMessage() 为 null，不太友好
</span><span class="cm">     * @param nullPointerException 空指针异常
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">NullPointerException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ErrorResponse</span> <span class="nf">handleNullPointerException</span><span class="o">(</span><span class="n">NullPointerException</span> <span class="n">nullPointerException</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">nullPointerException</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">nullPointerException</span><span class="o">);</span>

        <span class="n">ErrorResponse</span> <span class="n">errorResponse</span> <span class="o">=</span>  <span class="k">new</span> <span class="n">ErrorResponse</span><span class="o">(</span><span class="n">CommonResponseEnum</span><span class="o">.</span><span class="na">Null_POINTER_EXCEPTION</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span>
                <span class="n">CommonResponseEnum</span><span class="o">.</span><span class="na">Null_POINTER_EXCEPTION</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">errorResponse</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 未定义异常处理器
</span><span class="cm">     *
</span><span class="cm">     * @param e 异常
</span><span class="cm">     * @return 异常结果
</span><span class="cm">     */</span>
    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ErrorResponse</span> <span class="nf">handleException</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">ENV_PROD</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">profile</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 当为生产环境, 不适合把具体的异常信息展示给用户, 比如数据库异常信息.
</span><span class="c1"></span>            <span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="n">CommonResponseEnum</span><span class="o">.</span><span class="na">SERVER_ERROR</span><span class="o">.</span><span class="na">getCode</span><span class="o">();</span>
            <span class="n">BaseException</span> <span class="n">baseException</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BaseException</span><span class="o">(</span><span class="n">CommonResponseEnum</span><span class="o">.</span><span class="na">SERVER_ERROR</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">getMessage</span><span class="o">(</span><span class="n">baseException</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">ErrorResponse</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">ErrorResponse</span> <span class="n">errorResponse</span> <span class="o">=</span>  <span class="k">new</span> <span class="n">ErrorResponse</span><span class="o">(</span><span class="n">CommonResponseEnum</span><span class="o">.</span><span class="na">SERVER_ERROR</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">errorResponse</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>信息国际化处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.msdemt.simple.unified_exception_handler_demo.i18n</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.MessageSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.i18n.LocaleContextHolder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Locale</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnifiedMessageSource</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nf">UnifiedMessageSource</span><span class="o">(</span><span class="n">MessageSource</span> <span class="n">messageSource</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">messageSource</span> <span class="o">=</span> <span class="n">messageSource</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 获取国际化消息
</span><span class="cm">     *
</span><span class="cm">     * @param code 消息code
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">return</span> <span class="n">getMessage</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 获取国际化消息
</span><span class="cm">     *
</span><span class="cm">     * @param code 消息code
</span><span class="cm">     * @param args 参数
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">return</span> <span class="n">getMessage</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 获取国际化消息
</span><span class="cm">     *
</span><span class="cm">     * @param code           消息code
</span><span class="cm">     * @param args           参数
</span><span class="cm">     * @param defaultMessage 默认消息
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">String</span> <span class="n">defaultMessage</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Locale</span> <span class="n">locale</span> <span class="o">=</span> <span class="n">LocaleContextHolder</span><span class="o">.</span><span class="na">getLocale</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">messageSource</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">defaultMessage</span><span class="o">,</span> <span class="n">locale</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>查看异常处理器代码可以看到，代码中将异常分成了几类，实际上只有两大类，一类是 ServletException （在servlet容器中发生的异常），一类是 ServiceException （在业务代码中发生的异常）。</p>
<p>ServletException</p>
<ul>
<li>由 handleServletException 方法处理
<ul>
<li>HttpRequestMethodNotSupportedException</li>
<li>HttpMediaTypeNotSupportedException</li>
<li>HttpMediaTypeNotAcceptableException</li>
<li>MissingPathVariableException</li>
<li>MissingServletRequestParameterException</li>
<li>TypeMismatchException</li>
<li>HttpMessageNotReadableException</li>
<li>HttpMessageNotWritableException</li>
<li>ServletRequestBindingException</li>
<li>ConversionNotSupportedException</li>
<li>MissingServletRequestPartException</li>
<li>AsyncRequestTimeoutException</li>
</ul>
</li>
<li>由 handleBindException 方法处理
<ul>
<li>handleBindException</li>
</ul>
</li>
<li>由 handleValidException 方法处理
<ul>
<li>MethodArgumentNotValidException</li>
</ul>
</li>
<li>由自定义控制器捕获处理
<ul>
<li>NoHandlerFoundException</li>
</ul>
</li>
</ul>
<p>ServiceException</p>
<ul>
<li>由 handleBusinessException 方法处理
<ul>
<li>BusinessException</li>
</ul>
</li>
<li>由 handleBaseException 方法处理
<ul>
<li>BaseException</li>
</ul>
</li>
<li>由 handleNullPointerException 方法处理
<ul>
<li>NullPointerException</li>
</ul>
</li>
<li>由 handleException 方法处理
<ul>
<li>Exception</li>
</ul>
</li>
</ul>
<h4 id="异常处理器说明">异常处理器说明</h4>
<h5 id="servlet-容器产生的异常">servlet 容器产生的异常</h5>
<p>一个 <code>http</code> 请求，在到达 <code>Controller</code> <code>前，Servlet</code> 容器会对该请求的请求信息和目标控制器信息做一系列校验。</p>
<ul>
<li><code>NoHandlerFoundException</code>: 首先根据请求 <code>url</code> 查找有没有对应的控制器，若没有则会抛出该异常，即 404 异常；在 springboot 中，该异常不会直接抛出，而是由 <code>org.springframework.boot.autoconfigure.web.servlet.error.BasicErrorController</code> 进行处理。</li>
<li><code>HttpRequestMethodNotSupportedException</code>: 若请求 <code>url</code> 匹配到了，获得了对应的匹配结果（匹配结果是一个列表，该 <code>url</code> 支持的不同 http 方法，如：Get、Post等），则尝试将请求的 <code>http</code> 方法与列表的控制器做匹配，若没有对应 <code>http</code> 方法的控制器，则抛出该异常。</li>
<li><code>HttpMediaTypeNotSupportedException</code>： 然后再对请求头与控制器支持的请求头做比较，比如 <code>content-type</code> 请求头，若控制器的参数签名包含注解 <code>@RequestBody</code>，但 http 请求的请求头中 <code>content-type</code> 的值不包含 <code>application/json</code>，那么会抛出该异常。</li>
<li><code>MissingPathVariableException</code>: 未检测到路径参数，比如控制器的 <code>url</code> 为 <code>/user/{id}</code>，参数签名包含 <code>@PathVariable(id)</code> ，当请求的 <code>url</code> 为 <code>/user</code> ，没有控制器的 <code>url</code> 为 <code>/user</code> 的情况下，该请求会被判定为缺少路径参数，从而会抛出 <code>MissingPathVariableException</code></li>
<li><code>MissingServletRequestParameterException</code>: 缺少请求参数，比如控制器定义了参数 <code>@RequestParam(&quot;id) String id</code> ，但 http 请求中，未携带该 <code>id</code> 参数，则会抛出该异常。</li>
<li><code>TypeMismatchException</code>: 参数类型匹配失败，比如控制器的接收参数为 <code>Long</code> 类型，但 http 请求中传入的值的类型是字符串，那么将会出现类型转换失败的错误，从而抛出该异常。</li>
<li><code>HttpMessageNotReadableException</code>: http 请求数据反序列化异常，比如控制器接收到 http 请求，请求值是 json 格式，当 spring boot 使用 <code>jackson</code> 对该 json 进行反序列化为控制器定义的对象参数时，若反序列化失败，则会抛出该异常。</li>
<li><code>HttpMessageNotWritableException</code>: spring boot 使用 <code>jackson</code> 对控制器返回的数据进行序列化为 <code>json</code> 时，发生序列化失败时抛出该异常。比如，控制器对应的方法的返回值是 <code>User</code> ，且该控制器含有前面 <code>@ResponseBody</code>，则控制器方法返回 <code>return user;</code>时，spring boot 会使用 <code>jackson</code> 将 <code>user</code> 对象序列化为 <code>json</code> ，返回给调用方，当对象序列化为 <code>json</code> 失败时，抛出该异常。</li>
<li><code>HttpMediaTypeNotAcceptableException</code>: 控制器返回的报头（<code>Response Headers</code>）中的 <code>content-type</code> 与 http 请求报头（<code>Request Headers</code>）不匹配，会抛出该异常。</li>
<li><code>BindException</code>: 参数绑定异常，<code>org.springframework.validation.BindException</code>，控制器对接受参数根据注解进行规则校验时，若校验失败，则抛出异常。</li>
<li><code>MethodArgumentNotValidException</code>: 参数校验异常，控制器对接受参数进行校验，校验失败抛出该异常。</li>
<li><code>ServletRequestBindingException</code>: 参数绑定异常</li>
<li><code>ConversionNotSupportedException</code>: 类型转换异常</li>
<li><code>MissingServletRequestPartException</code>: 缺少请求参数异常，如当某个参数配置为 <code>@RequestParam(required=true)</code> 时，请求中没有该参数时会抛出异常，注意，当请求参数位于 <code>controller</code> 的 <code>url</code> 路径中时，默认 <code>required = true</code></li>
<li><code>AsyncRequestTimeoutException</code>: 异步请求超时异常</li>
</ul>
<h5 id="业务异常">业务异常</h5>
<ul>
<li><code>BaseException</code>: 自定义异常基类</li>
<li><code>BusinessException</code>: 业务异常</li>
<li><code>NullPointerException</code>: 业务中产生的空指针异常（若不配置该异常捕获，则由 <code>Exception</code> 异常处理器捕获，此时 <code>e.getMessage()</code> 为 null，前端处理时可能出现 null 空指针，未避免这种情况，对 <code>NullPointerException</code> 单独进行处理）</li>
<li><code>Exception</code>: 其他异常，若数据库连接失败等异常</li>
</ul>
<h4 id="异于常人的404">异于常人的404</h4>
<p>上文提到，当请求没有匹配到控制器时，会抛出 <code>NoHandlerFoundException</code> 异常，但实际上默认情况不是这样，默认情况下</p>
<p>如果请求类型为 <code>text/html</code>，则 spring boot 匹配不到对应的请求路径，会返回类似如下页面</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/20210202-whitelabel%20error%20page.png"
        data-srcset="/images/20210202-whitelabel%20error%20page.png, /images/20210202-whitelabel%20error%20page.png 1.5x, /images/20210202-whitelabel%20error%20page.png 2x"
        data-sizes="auto"
        alt="/images/20210202-whitelabel%20error%20page.png"
        title="图 1" /></p>
<p>如果是其他请求类型（如<code>application/json</code>），则返回json数据，类似如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2021-02-02T03:09:54.098+00:00&#34;</span><span class="p">,</span>
  <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="mi">404</span><span class="p">,</span>
  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Not Found&#34;</span><span class="p">,</span>
  <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
  <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/user&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>为什么会这样呢？</p>
<p>因为 <code>spring boot</code> 启动后，会自动加载 <code>/META-INF/spring.factories</code> 中配置的类，其中就有 <code>org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration</code> 和 <code>org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration</code></p>
<p><code>WebMvcAutoConfiguration</code> 部分代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@ConditionalOnWebApplication</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="n">Type</span><span class="o">.</span><span class="na">SERVLET</span><span class="o">)</span>
<span class="nd">@ConditionalOnClass</span><span class="o">({</span> <span class="n">Servlet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">DispatcherServlet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">WebMvcConfigurer</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="n">WebMvcConfigurationSupport</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@AutoConfigureOrder</span><span class="o">(</span><span class="n">Ordered</span><span class="o">.</span><span class="na">HIGHEST_PRECEDENCE</span> <span class="o">+</span> <span class="n">10</span><span class="o">)</span>
<span class="nd">@AutoConfigureAfter</span><span class="o">({</span> <span class="n">DispatcherServletAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">TaskExecutionAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
		<span class="n">ValidationAutoConfiguration</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebMvcAutoConfiguration</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>@ConditionalOnClass({ Servlet.class, DispatcherServlet.class, WebMvcConfigurer.class })</code> 表示当类路径下存在 <code>Servlet.class</code> <code>DispatcherServlet.class</code> <code>WebMvcConfigurer.class</code> 时，自动加载 <code>WebMvcAutoConfiguration</code> 类</p>
<p><code>@ConditionalOnMissingBean(WebMvcConfigurationSupport.class)</code> 表示当类路径下不存在 <code>WebMvcConfigurationSupport.class</code> 时，自动加载 <code>WebMvcAutoConfiguration</code> 类</p>
<p>加载 <code>WebMvcConfigurationSupport.class</code> 类时，该类中使用 <code>@Bean</code> 定义的方法都会生成对应的对象并存放在 <code>spring</code> 容器中。</p>
<p>重点看下 <code>EnableWebMvcConfiguration</code> 类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="n">WebProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EnableWebMvcConfiguration</span> <span class="kd">extends</span> <span class="n">DelegatingWebMvcConfiguration</span> <span class="kd">implements</span> <span class="n">ResourceLoaderAware</span> <span class="o">{</span>
	<span class="nd">@Bean</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">RequestMappingHandlerAdapter</span> <span class="nf">requestMappingHandlerAdapter</span><span class="o">(</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcContentNegotiationManager&#34;</span><span class="o">)</span> <span class="n">ContentNegotiationManager</span> <span class="n">contentNegotiationManager</span><span class="o">,</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcConversionService&#34;</span><span class="o">)</span> <span class="n">FormattingConversionService</span> <span class="n">conversionService</span><span class="o">,</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcValidator&#34;</span><span class="o">)</span> <span class="n">Validator</span> <span class="n">validator</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">RequestMappingHandlerAdapter</span> <span class="n">adapter</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">requestMappingHandlerAdapter</span><span class="o">(</span><span class="n">contentNegotiationManager</span><span class="o">,</span>
				<span class="n">conversionService</span><span class="o">,</span> <span class="n">validator</span><span class="o">);</span>
		<span class="n">adapter</span><span class="o">.</span><span class="na">setIgnoreDefaultModelOnRedirect</span><span class="o">(</span>
				<span class="k">this</span><span class="o">.</span><span class="na">mvcProperties</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">this</span><span class="o">.</span><span class="na">mvcProperties</span><span class="o">.</span><span class="na">isIgnoreDefaultModelOnRedirect</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">adapter</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="nd">@Bean</span>
	<span class="nd">@Primary</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">RequestMappingHandlerMapping</span> <span class="nf">requestMappingHandlerMapping</span><span class="o">(</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcContentNegotiationManager&#34;</span><span class="o">)</span> <span class="n">ContentNegotiationManager</span> <span class="n">contentNegotiationManager</span><span class="o">,</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcConversionService&#34;</span><span class="o">)</span> <span class="n">FormattingConversionService</span> <span class="n">conversionService</span><span class="o">,</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcResourceUrlProvider&#34;</span><span class="o">)</span> <span class="n">ResourceUrlProvider</span> <span class="n">resourceUrlProvider</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Must be @Primary for MvcUriComponentsBuilder to work
</span><span class="c1"></span>		<span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">requestMappingHandlerMapping</span><span class="o">(</span><span class="n">contentNegotiationManager</span><span class="o">,</span> <span class="n">conversionService</span><span class="o">,</span>
				<span class="n">resourceUrlProvider</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="n">WelcomePageHandlerMapping</span> <span class="nf">welcomePageHandlerMapping</span><span class="o">(</span><span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">,</span>
			<span class="n">FormattingConversionService</span> <span class="n">mvcConversionService</span><span class="o">,</span> <span class="n">ResourceUrlProvider</span> <span class="n">mvcResourceUrlProvider</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">WelcomePageHandlerMapping</span> <span class="n">welcomePageHandlerMapping</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WelcomePageHandlerMapping</span><span class="o">(</span>
				<span class="k">new</span> <span class="n">TemplateAvailabilityProviders</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">),</span> <span class="n">applicationContext</span><span class="o">,</span> <span class="n">getWelcomePage</span><span class="o">(),</span>
				<span class="k">this</span><span class="o">.</span><span class="na">mvcProperties</span><span class="o">.</span><span class="na">getStaticPathPattern</span><span class="o">());</span>
		<span class="n">welcomePageHandlerMapping</span><span class="o">.</span><span class="na">setInterceptors</span><span class="o">(</span><span class="n">getInterceptors</span><span class="o">(</span><span class="n">mvcConversionService</span><span class="o">,</span> <span class="n">mvcResourceUrlProvider</span><span class="o">));</span>
		<span class="n">welcomePageHandlerMapping</span><span class="o">.</span><span class="na">setCorsConfigurations</span><span class="o">(</span><span class="n">getCorsConfigurations</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">welcomePageHandlerMapping</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DelegatingWebMvcConfiguration</span> <span class="kd">extends</span> <span class="n">WebMvcConfigurationSupport</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebMvcConfigurationSupport</span> <span class="kd">implements</span> <span class="n">ApplicationContextAware</span><span class="o">,</span> <span class="n">ServletContextAware</span> <span class="o">{</span>
	<span class="cm">/**
</span><span class="cm">	 * Return a {@link RequestMappingHandlerMapping} ordered at 0 for mapping
</span><span class="cm">	 * requests to annotated controllers.
</span><span class="cm">	 */</span>
	<span class="nd">@Bean</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;deprecation&#34;</span><span class="o">)</span>
	<span class="kd">public</span> <span class="n">RequestMappingHandlerMapping</span> <span class="nf">requestMappingHandlerMapping</span><span class="o">(</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcContentNegotiationManager&#34;</span><span class="o">)</span> <span class="n">ContentNegotiationManager</span> <span class="n">contentNegotiationManager</span><span class="o">,</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcConversionService&#34;</span><span class="o">)</span> <span class="n">FormattingConversionService</span> <span class="n">conversionService</span><span class="o">,</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcResourceUrlProvider&#34;</span><span class="o">)</span> <span class="n">ResourceUrlProvider</span> <span class="n">resourceUrlProvider</span><span class="o">)</span> <span class="o">{</span>

		<span class="n">RequestMappingHandlerMapping</span> <span class="n">mapping</span> <span class="o">=</span> <span class="n">createRequestMappingHandlerMapping</span><span class="o">();</span>
		<span class="n">mapping</span><span class="o">.</span><span class="na">setOrder</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
        <span class="o">...</span> <span class="o">...</span>
    <span class="o">}</span>

	<span class="cm">/**
</span><span class="cm">	 * Return a handler mapping ordered at 1 to map URL paths directly to
</span><span class="cm">	 * view names. To configure view controllers, override
</span><span class="cm">	 * {@link #addViewControllers}.
</span><span class="cm">	 */</span>
	<span class="nd">@Bean</span>
	<span class="nd">@Nullable</span>
	<span class="kd">public</span> <span class="n">HandlerMapping</span> <span class="nf">viewControllerHandlerMapping</span><span class="o">(</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcConversionService&#34;</span><span class="o">)</span> <span class="n">FormattingConversionService</span> <span class="n">conversionService</span><span class="o">,</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcResourceUrlProvider&#34;</span><span class="o">)</span> <span class="n">ResourceUrlProvider</span> <span class="n">resourceUrlProvider</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>

	<span class="cm">/**
</span><span class="cm">	 * Return a {@link BeanNameUrlHandlerMapping} ordered at 2 to map URL
</span><span class="cm">	 * paths to controller bean names.
</span><span class="cm">	 */</span>
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="n">BeanNameUrlHandlerMapping</span> <span class="nf">beanNameHandlerMapping</span><span class="o">(</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcConversionService&#34;</span><span class="o">)</span> <span class="n">FormattingConversionService</span> <span class="n">conversionService</span><span class="o">,</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcResourceUrlProvider&#34;</span><span class="o">)</span> <span class="n">ResourceUrlProvider</span> <span class="n">resourceUrlProvider</span><span class="o">)</span> <span class="o">{</span>

		<span class="n">BeanNameUrlHandlerMapping</span> <span class="n">mapping</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanNameUrlHandlerMapping</span><span class="o">();</span>
		<span class="n">mapping</span><span class="o">.</span><span class="na">setOrder</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
        <span class="o">...</span> <span class="o">...</span>
    <span class="o">}</span>

	<span class="cm">/**
</span><span class="cm">	 * Return a {@link RouterFunctionMapping} ordered at 3 to map
</span><span class="cm">	 * {@linkplain org.springframework.web.servlet.function.RouterFunction router functions}.
</span><span class="cm">	 * Consider overriding one of these other more fine-grained methods:
</span><span class="cm">	 * &lt;ul&gt;
</span><span class="cm">	 * &lt;li&gt;{@link #addInterceptors} for adding handler interceptors.
</span><span class="cm">	 * &lt;li&gt;{@link #addCorsMappings} to configure cross origin requests processing.
</span><span class="cm">	 * &lt;li&gt;{@link #configureMessageConverters} for adding custom message converters.
</span><span class="cm">	 * &lt;li&gt;{@link #configurePathMatch(PathMatchConfigurer)} for customizing the {@link PathPatternParser}.
</span><span class="cm">	 * &lt;/ul&gt;
</span><span class="cm">	 * @since 5.2
</span><span class="cm">	 */</span>
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="n">RouterFunctionMapping</span> <span class="nf">routerFunctionMapping</span><span class="o">(</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcConversionService&#34;</span><span class="o">)</span> <span class="n">FormattingConversionService</span> <span class="n">conversionService</span><span class="o">,</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcResourceUrlProvider&#34;</span><span class="o">)</span> <span class="n">ResourceUrlProvider</span> <span class="n">resourceUrlProvider</span><span class="o">)</span> <span class="o">{</span>

		<span class="n">RouterFunctionMapping</span> <span class="n">mapping</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RouterFunctionMapping</span><span class="o">();</span>
		<span class="n">mapping</span><span class="o">.</span><span class="na">setOrder</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
        <span class="o">...</span> <span class="o">...</span>
    <span class="o">}</span>

    
	<span class="cm">/**
</span><span class="cm">	 * Return a handler mapping ordered at Integer.MAX_VALUE-1 with mapped
</span><span class="cm">	 * resource handlers. To configure resource handling, override
</span><span class="cm">	 * {@link #addResourceHandlers}.
</span><span class="cm">	 */</span>
	<span class="nd">@Bean</span>
	<span class="nd">@Nullable</span>
	<span class="kd">public</span> <span class="n">HandlerMapping</span> <span class="nf">resourceHandlerMapping</span><span class="o">(</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcContentNegotiationManager&#34;</span><span class="o">)</span> <span class="n">ContentNegotiationManager</span> <span class="n">contentNegotiationManager</span><span class="o">,</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcConversionService&#34;</span><span class="o">)</span> <span class="n">FormattingConversionService</span> <span class="n">conversionService</span><span class="o">,</span>
			<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;mvcResourceUrlProvider&#34;</span><span class="o">)</span> <span class="n">ResourceUrlProvider</span> <span class="n">resourceUrlProvider</span><span class="o">)</span> <span class="o">{</span>

        <span class="o">...</span> <span class="o">...</span>
        <span class="n">addResourceHandlers</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>  <span class="c1">//该方法会被子类覆盖
</span><span class="c1"></span>        <span class="o">...</span> <span class="o">...</span>
        <span class="k">return</span> <span class="n">simpleUrlHandlerMapping</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>执行到上文的 addResourceHandlers(registry)，该方法会被子类，即 <code>EnableWebMvcConfiguration</code> 中的 <code>addResourceHandlers</code> 方法覆盖</p>
<p><code>org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration.EnableWebMvcConfiguration#addResourceHandlers</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">addResourceHandlers</span><span class="o">(</span><span class="n">ResourceHandlerRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">super</span><span class="o">.</span><span class="na">addResourceHandlers</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">resourceProperties</span><span class="o">.</span><span class="na">isAddMappings</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Default resource handling disabled&#34;</span><span class="o">);</span>
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="n">ServletContext</span> <span class="n">servletContext</span> <span class="o">=</span> <span class="n">getServletContext</span><span class="o">();</span>
	<span class="n">addResourceHandler</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="s">&#34;/webjars/**&#34;</span><span class="o">,</span> <span class="s">&#34;classpath:/META-INF/resources/webjars/&#34;</span><span class="o">);</span>
	<span class="n">addResourceHandler</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">mvcProperties</span><span class="o">.</span><span class="na">getStaticPathPattern</span><span class="o">(),</span> <span class="o">(</span><span class="n">registration</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
		<span class="n">registration</span><span class="o">.</span><span class="na">addResourceLocations</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resourceProperties</span><span class="o">.</span><span class="na">getStaticLocations</span><span class="o">());</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">servletContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">registration</span><span class="o">.</span><span class="na">addResourceLocations</span><span class="o">(</span><span class="k">new</span> <span class="n">ServletContextResource</span><span class="o">(</span><span class="n">servletContext</span><span class="o">,</span> <span class="n">SERVLET_LOCATION</span><span class="o">));</span>
		<span class="o">}</span>
	<span class="o">});</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>该方法，添加了 <code>/webjars/**</code> <code>/**</code> 的路径匹配。</p>
<p>所以请求 <code>http://localhost:8080/user</code> 地址，即使我们没有配置 <code>/user</code> 对应的 <code>Controller</code> ，最终也会被 <code>SimpleUrlHandlerMapping</code> 处理。</p>
<p>比如当我们请求 <code>http://localhost:8080/user</code>，并且 Controller 没有匹配 <code>/user</code> 的控制器（注意：若有匹配 <code>/user/hello</code> 的控制器，但是没有匹配 <code>/user</code> 的控制器，也不会匹配到<code>http://localhost:8080/user</code>）时，springboot 也会匹配到处理器。</p>
<h4 id="404的复现">404的复现</h4>
<p>当请求不存在的url路径时，会出现 <code>NoHandlerFoundException</code> 异常</p>
<p>发送请求，当前项目没有符合 <code>/user</code> 的 <code>Controller</code>，所以请求该地址时会出现 <code>NoHandlerFoundException</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-http" data-lang="http"><span class="err">GET http://localhost:8080/user
</span><span class="err">Accept: application/json
</span></code></pre></td></tr></table>
</div>
</div><p><code>spring mvc</code> 中，所有的请求由 <code>org.springframework.web.servlet.DispatcherServlet</code> 分发</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * Process the actual dispatching to the handler.
</span><span class="cm"> * &lt;p&gt;The handler will be obtained by applying the servlet&#39;s HandlerMappings in order.
</span><span class="cm"> * The HandlerAdapter will be obtained by querying the servlet&#39;s installed HandlerAdapters
</span><span class="cm"> * to find the first that supports the handler class.
</span><span class="cm"> * &lt;p&gt;All HTTP methods are handled by this method. It&#39;s up to HandlerAdapters or handlers
</span><span class="cm"> * themselves to decide which methods are acceptable.
</span><span class="cm"> * @param request current HTTP request
</span><span class="cm"> * @param response current HTTP response
</span><span class="cm"> * @throws Exception in case of any kind of processing failure
</span><span class="cm"> */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doDispatch</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
	<span class="n">HttpServletRequest</span> <span class="n">processedRequest</span> <span class="o">=</span> <span class="n">request</span><span class="o">;</span>
	<span class="n">HandlerExecutionChain</span> <span class="n">mappedHandler</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="kt">boolean</span> <span class="n">multipartRequestParsed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

	<span class="n">WebAsyncManager</span> <span class="n">asyncManager</span> <span class="o">=</span> <span class="n">WebAsyncUtils</span><span class="o">.</span><span class="na">getAsyncManager</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

	<span class="k">try</span> <span class="o">{</span>
		<span class="n">ModelAndView</span> <span class="n">mv</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">Exception</span> <span class="n">dispatchException</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="n">processedRequest</span> <span class="o">=</span> <span class="n">checkMultipart</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
			<span class="n">multipartRequestParsed</span> <span class="o">=</span> <span class="o">(</span><span class="n">processedRequest</span> <span class="o">!=</span> <span class="n">request</span><span class="o">);</span>

			<span class="c1">// Determine handler for the current request.
</span><span class="c1"></span>			<span class="n">mappedHandler</span> <span class="o">=</span> <span class="n">getHandler</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">mappedHandler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">noHandlerFound</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
				<span class="k">return</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="c1">// Determine handler adapter for the current request.
</span><span class="c1"></span>			<span class="n">HandlerAdapter</span> <span class="n">ha</span> <span class="o">=</span> <span class="n">getHandlerAdapter</span><span class="o">(</span><span class="n">mappedHandler</span><span class="o">.</span><span class="na">getHandler</span><span class="o">());</span>

			<span class="c1">// Process last-modified header, if supported by the handler.
</span><span class="c1"></span>			<span class="n">String</span> <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">();</span>
			<span class="kt">boolean</span> <span class="n">isGet</span> <span class="o">=</span> <span class="s">&#34;GET&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">isGet</span> <span class="o">||</span> <span class="s">&#34;HEAD&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
				<span class="kt">long</span> <span class="n">lastModified</span> <span class="o">=</span> <span class="n">ha</span><span class="o">.</span><span class="na">getLastModified</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">mappedHandler</span><span class="o">.</span><span class="na">getHandler</span><span class="o">());</span>
				<span class="k">if</span> <span class="o">(</span><span class="k">new</span> <span class="n">ServletWebRequest</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">).</span><span class="na">checkNotModified</span><span class="o">(</span><span class="n">lastModified</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">isGet</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">return</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span>

			<span class="k">if</span> <span class="o">(!</span><span class="n">mappedHandler</span><span class="o">.</span><span class="na">applyPreHandle</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">,</span> <span class="n">response</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">return</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="c1">// Actually invoke the handler.
</span><span class="c1"></span>			<span class="n">mv</span> <span class="o">=</span> <span class="n">ha</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">mappedHandler</span><span class="o">.</span><span class="na">getHandler</span><span class="o">());</span>

			<span class="k">if</span> <span class="o">(</span><span class="n">asyncManager</span><span class="o">.</span><span class="na">isConcurrentHandlingStarted</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">return</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="n">applyDefaultViewName</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">,</span> <span class="n">mv</span><span class="o">);</span>
			<span class="n">mappedHandler</span><span class="o">.</span><span class="na">applyPostHandle</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">mv</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">dispatchException</span> <span class="o">=</span> <span class="n">ex</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">err</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// As of 4.3, we&#39;re processing Errors thrown from handler methods as well,
</span><span class="c1"></span>			<span class="c1">// making them available for @ExceptionHandler methods and other scenarios.
</span><span class="c1"></span>			<span class="n">dispatchException</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NestedServletException</span><span class="o">(</span><span class="s">&#34;Handler dispatch failed&#34;</span><span class="o">,</span> <span class="n">err</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="n">processDispatchResult</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">mappedHandler</span><span class="o">,</span> <span class="n">mv</span><span class="o">,</span> <span class="n">dispatchException</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">triggerAfterCompletion</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">mappedHandler</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">err</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">triggerAfterCompletion</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">mappedHandler</span><span class="o">,</span>
				<span class="k">new</span> <span class="n">NestedServletException</span><span class="o">(</span><span class="s">&#34;Handler processing failed&#34;</span><span class="o">,</span> <span class="n">err</span><span class="o">));</span>
	<span class="o">}</span>
	<span class="k">finally</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">asyncManager</span><span class="o">.</span><span class="na">isConcurrentHandlingStarted</span><span class="o">())</span> <span class="o">{</span>
			<span class="c1">// Instead of postHandle and afterCompletion
</span><span class="c1"></span>			<span class="k">if</span> <span class="o">(</span><span class="n">mappedHandler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">mappedHandler</span><span class="o">.</span><span class="na">applyAfterConcurrentHandlingStarted</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">// Clean up any resources used by a multipart request.
</span><span class="c1"></span>			<span class="k">if</span> <span class="o">(</span><span class="n">multipartRequestParsed</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">cleanupMultipart</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>重点看如下代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Determine handler for the current request.
</span><span class="c1"></span><span class="n">mappedHandler</span> <span class="o">=</span> <span class="n">getHandler</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">mappedHandler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">noHandlerFound</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
	<span class="k">return</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>它的作用是使用 <code>getHandler()</code> 方法获取 <code>request</code> 的处理器（<code>handler</code>），如果没有这个 <code>request</code> 对应的处理器，则执行 <code>noHandlerFound()</code> 方法</p>
<p>接着看下 <code>getHandler()</code> 方法里做了什么</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * Return the HandlerExecutionChain for this request.
</span><span class="cm"> * &lt;p&gt;Tries all handler mappings in order.
</span><span class="cm"> * @param request current HTTP request
</span><span class="cm"> * @return the HandlerExecutionChain, or {@code null} if no handler could be found
</span><span class="cm"> */</span>
<span class="nd">@Nullable</span>
<span class="kd">protected</span> <span class="n">HandlerExecutionChain</span> <span class="nf">getHandler</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">handlerMappings</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">HandlerMapping</span> <span class="n">mapping</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">handlerMappings</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">HandlerExecutionChain</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="na">getHandler</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">handler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">handler</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>处理器映射器共 5 个，如下图</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/20210202-%e5%a4%84%e7%90%86%e5%99%a8%e6%98%a0%e5%b0%84%e5%99%a8.png"
        data-srcset="/images/20210202-%e5%a4%84%e7%90%86%e5%99%a8%e6%98%a0%e5%b0%84%e5%99%a8.png, /images/20210202-%e5%a4%84%e7%90%86%e5%99%a8%e6%98%a0%e5%b0%84%e5%99%a8.png 1.5x, /images/20210202-%e5%a4%84%e7%90%86%e5%99%a8%e6%98%a0%e5%b0%84%e5%99%a8.png 2x"
        data-sizes="auto"
        alt="/images/20210202-处理器映射器.png"
        title="图 2" /></p>
<p>对这 5 个处理器映射器遍历，分别执行 <code>getHandler()</code> 方法，看看是否有符合该 <code>request</code> 的处理器执行链（<code>HandlerExecutionChain</code>）</p>
<p>遍历的第一个处理器映射器是 <code>RequestsMappingHandlerMapping</code> 对应的类是 <code>org.springframework.web.servlet.mvc.method.RequestMappingInfoHandlerMapping</code>。</p>
<p>执行<code>getHandler()</code> 方法时执行的是 <code>org.springframework.web.servlet.handler.AbstractHandlerMapping</code> 的 getHandler() 方法，因为 RequestMappingInfoHandlerMapping 类没有实现 getHandler() 方法，但是它的父类 AbstractHandlerMethodMapping 实现了 getHandler() 方法，所以它继承下来了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">RequestMappingInfoHandlerMapping</span> <span class="kd">extends</span> <span class="n">AbstractHandlerMethodMapping</span><span class="o">&lt;</span><span class="n">RequestMappingInfo</span><span class="o">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/20210202-getHandler-1.png"
        data-srcset="/images/20210202-getHandler-1.png, /images/20210202-getHandler-1.png 1.5x, /images/20210202-getHandler-1.png 2x"
        data-sizes="auto"
        alt="/images/20210202-getHandler-1.png"
        title="图 4" /></p>
<p>再执行 <code>getHandlerInternal()</code> 方法，该方法在 <code>RequestMappingInfoHandlerMapping</code> 类中有定义，所以会执行该类中定义的 <code>getHandlerInternal()</code> 方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="n">HandlerMethod</span> <span class="nf">getHandlerInternal</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
	<span class="n">request</span><span class="o">.</span><span class="na">removeAttribute</span><span class="o">(</span><span class="n">PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE</span><span class="o">);</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">getHandlerInternal</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">finally</span> <span class="o">{</span>
		<span class="n">ProducesRequestCondition</span><span class="o">.</span><span class="na">clearMediaTypesAttribute</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>该方法移除了 <code>request</code> 中的一个 <code>attribute</code> ，然后调用了父类 <code>AbstractHandlerMethodMapping</code> 的 <code>getHandlerInternal()</code> 方法，如下图</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/20210202-getHandlerInternal-1.png"
        data-srcset="/images/20210202-getHandlerInternal-1.png, /images/20210202-getHandlerInternal-1.png 1.5x, /images/20210202-getHandlerInternal-1.png 2x"
        data-sizes="auto"
        alt="/images/20210202-getHandlerInternal-1.png"
        title="图 5" /></p>
<p>该方法中，获取了请求的地址，此处为 <code>/user</code>，然后查找是否有处理该地址的处理器方法（<code>HandlerMethod</code>）</p>
<p>此时没有找到处理 <code>/user</code> 地址的处理器方法，返回 null</p>
<p>然后进行下一个处理器映射器的遍历，当遍历到 <code>SimpleUrlHandlerMapping</code> 时，会发现竟然找到处理 <code>/user</code> 的处理器了，明明我们没有定义 <code>/user</code> 的 <code>Controller</code>，怎么还找到对应处理器了呢？</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/20210202-simpleUrlHandlerMapping.png"
        data-srcset="/images/20210202-simpleUrlHandlerMapping.png, /images/20210202-simpleUrlHandlerMapping.png 1.5x, /images/20210202-simpleUrlHandlerMapping.png 2x"
        data-sizes="auto"
        alt="/images/20210202-simpleUrlHandlerMapping.png"
        title="图 6" /></p>
<p>如上图，在 <code>SimpleUrlHandlerMapping</code> 中的 <code>ResourceHttpRequestHandler</code> 会使用 <code>/webjars/**</code> 和 <code>/**</code> 作为 pattern 对 url 路径进行匹配，此处 <code>/user</code> 是肯定可以被 <code>/**</code> 匹配到的，所以 <code>/user</code> 可以查询到 <code>HandlerExecutionChain</code>。</p>
<p><code>handlerMappings</code> 是一个 <code>ArrayList</code> ，遍历时是有序的，所以会按照 <code>RequestMappingHandlerMapping</code> -&gt; <code>BeanNameUrlHandlerMapping</code> -&gt; <code>RouterFunctionMapping</code> -&gt; <code>SimpleUrlHandlerMapping</code> -&gt; <code>WelcomePageHandlerMapping</code> 的顺序进行遍历，不用担心 <code>SimpleUrlHandlerMapping</code> 中的 <code>/**</code> <code>pattern</code> 会影响其他的 <code>Controller</code></p>
<p>找到 /user 对应的处理器了，再次回到如下代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Determine handler for the current request.
</span><span class="c1"></span><span class="n">mappedHandler</span> <span class="o">=</span> <span class="n">getHandler</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">mappedHandler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">noHandlerFound</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
	<span class="k">return</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * No handler found -&gt; set appropriate HTTP response status.
</span><span class="cm"> * @param request current HTTP request
</span><span class="cm"> * @param response current HTTP response
</span><span class="cm"> * @throws Exception if preparing the response failed
</span><span class="cm"> */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">noHandlerFound</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">pageNotFoundLogger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">pageNotFoundLogger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;No mapping for &#34;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; &#34;</span> <span class="o">+</span> <span class="n">getRequestUri</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">throwExceptionIfNoHandlerFound</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">NoHandlerFoundException</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(),</span> <span class="n">getRequestUri</span><span class="o">(</span><span class="n">request</span><span class="o">),</span>
				<span class="k">new</span> <span class="n">ServletServerHttpRequest</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">getHeaders</span><span class="o">());</span>
	<span class="o">}</span>
	<span class="k">else</span> <span class="o">{</span>
		<span class="n">response</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_NOT_FOUND</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>所以，即使我们没有定义 <code>/user</code> 对应的 <code>Controller</code> ，也不会抛出 <code>NoHandlerFoundException</code> 异常</p>
<p>然后执行到如下代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Determine handler adapter for the current request.
</span><span class="c1"></span><span class="n">HandlerAdapter</span> <span class="n">ha</span> <span class="o">=</span> <span class="n">getHandlerAdapter</span><span class="o">(</span><span class="n">mappedHandler</span><span class="o">.</span><span class="na">getHandler</span><span class="o">());</span>
</code></pre></td></tr></table>
</div>
</div><p>根据上面查到的 <code>Handler</code> （<code>ResourceHttpRequestHandler</code>） 查找对应的 <code>Adapter</code> （<code>ha</code> 为 <code>HttpRequestHandlerAdapter</code>）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Actually invoke the handler.
</span><span class="c1"></span><span class="n">mv</span> <span class="o">=</span> <span class="n">ha</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">mappedHandler</span><span class="o">.</span><span class="na">getHandler</span><span class="o">());</span>
</code></pre></td></tr></table>
</div>
</div><p>调用 <code>HttpRequestHandlerAdapter</code> 的 <code>handle()</code> 方法，其中传入的 <code>handler</code> 参数是 <code>ResourceHttpRequestHandler</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpRequestHandlerAdapter</span> <span class="kd">implements</span> <span class="n">HandlerAdapter</span> <span class="o">{</span>

	<span class="nd">@Override</span>
	<span class="nd">@Nullable</span>
	<span class="kd">public</span> <span class="n">ModelAndView</span> <span class="nf">handle</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Object</span> <span class="n">handler</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

		<span class="o">((</span><span class="n">HttpRequestHandler</span><span class="o">)</span> <span class="n">handler</span><span class="o">).</span><span class="na">handleRequest</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>执行 <code>ResourceHttpRequestHandler</code> 的 <code>handleRequest()</code> 方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleRequest</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span>
		<span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>

	<span class="c1">// For very general mappings (e.g. &#34;/&#34;) we need to check 404 first
</span><span class="c1"></span>	<span class="n">Resource</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">getResource</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">resource</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Resource not found&#34;</span><span class="o">);</span>
		<span class="n">response</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_NOT_FOUND</span><span class="o">);</span>
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>SimpleUrlHandlerMapping</code> 中的 <code>/**</code> 被匹配到后，spring 依次去 <code>classpath:/META-INF/resources/</code>、 <code>classpath:/resources/</code>、 <code>classpath:/static/</code>、 <code>classpath:/public/</code> 查找该资源</p>
<p>根据请求 <code>url</code> 中的路径 <code>user</code> 在 资源目录中 找不到资源，返回的 <code>resource</code> 为 <code>null</code> ，执行 <code>response.sendError(404)</code> ，并返回</p>
<p>而 <code>response.sendError(404)</code>，会重新请求 <code>/error</code> 地址，不信可以测试下</p>
<p>测试代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Slf4j</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/user&#34;</span><span class="o">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/hello&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">hello</span><span class="o">(</span><span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">response</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">404</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&#34;123&#34;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>spring boot</code> 还有一个 <code>mvc</code> 相关的自动配置类，即 <code>org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration</code></p>
<p>该类主要内容如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@ConditionalOnWebApplication</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="n">Type</span><span class="o">.</span><span class="na">SERVLET</span><span class="o">)</span>
<span class="nd">@ConditionalOnClass</span><span class="o">({</span> <span class="n">Servlet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">DispatcherServlet</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="c1">// Load before the main WebMvcAutoConfiguration so that the error View is available
</span><span class="c1"></span><span class="nd">@AutoConfigureBefore</span><span class="o">(</span><span class="n">WebMvcAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@EnableConfigurationProperties</span><span class="o">({</span> <span class="n">ServerProperties</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">WebMvcProperties</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ErrorMvcAutoConfiguration</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ServerProperties</span> <span class="n">serverProperties</span><span class="o">;</span>

	<span class="nd">@Bean</span>
	<span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">ErrorController</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">search</span> <span class="o">=</span> <span class="n">SearchStrategy</span><span class="o">.</span><span class="na">CURRENT</span><span class="o">)</span>
	<span class="kd">public</span> <span class="n">BasicErrorController</span> <span class="nf">basicErrorController</span><span class="o">(</span><span class="n">ErrorAttributes</span> <span class="n">errorAttributes</span><span class="o">,</span>
			<span class="n">ObjectProvider</span><span class="o">&lt;</span><span class="n">ErrorViewResolver</span><span class="o">&gt;</span> <span class="n">errorViewResolvers</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="n">BasicErrorController</span><span class="o">(</span><span class="n">errorAttributes</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">serverProperties</span><span class="o">.</span><span class="na">getError</span><span class="o">(),</span>
				<span class="n">errorViewResolvers</span><span class="o">.</span><span class="na">orderedStream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>ServerProperties 类是参数配置类，可以配置 <code>server.error</code> 相关参数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&#34;server&#34;</span><span class="o">,</span> <span class="n">ignoreUnknownFields</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServerProperties</span>
</code></pre></td></tr></table>
</div>
</div><p>重点是</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Load before the main WebMvcAutoConfiguration so that the error View is available
</span><span class="c1"></span><span class="nd">@AutoConfigureBefore</span><span class="o">(</span><span class="n">WebMvcAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该类 <code>ErrorMvcAutoConfiguration</code> 需要在 <code>WebMvcAutoConfiguration</code> 自动配置类之前进行配置</p>
<p>同时，配置该类（<code>ErrorMvcAutoConfiguration</code> ）时，会新建 控制器 <code>BasicErrorController</code> ，该控制器主要内容如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;${server.error.path:${error.path:/error}}&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BasicErrorController</span> <span class="kd">extends</span> <span class="n">AbstractErrorController</span> <span class="o">{</span>
	<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">produces</span> <span class="o">=</span> <span class="n">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML_VALUE</span><span class="o">)</span>
	<span class="kd">public</span> <span class="n">ModelAndView</span> <span class="nf">errorHtml</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">HttpStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">getStatus</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">model</span> <span class="o">=</span> <span class="n">Collections</span>
				<span class="o">.</span><span class="na">unmodifiableMap</span><span class="o">(</span><span class="n">getErrorAttributes</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">getErrorAttributeOptions</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)));</span>
		<span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">status</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
		<span class="n">ModelAndView</span> <span class="n">modelAndView</span> <span class="o">=</span> <span class="n">resolveErrorView</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">status</span><span class="o">,</span> <span class="n">model</span><span class="o">);</span>
		<span class="k">return</span> <span class="o">(</span><span class="n">modelAndView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">modelAndView</span> <span class="o">:</span> <span class="k">new</span> <span class="n">ModelAndView</span><span class="o">(</span><span class="s">&#34;error&#34;</span><span class="o">,</span> <span class="n">model</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@RequestMapping</span>
	<span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;&gt;</span> <span class="nf">error</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">HttpStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">getStatus</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">HttpStatus</span><span class="o">.</span><span class="na">NO_CONTENT</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&lt;&gt;(</span><span class="n">status</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">getErrorAttributes</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">getErrorAttributeOptions</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">MediaType</span><span class="o">.</span><span class="na">ALL</span><span class="o">));</span>
		<span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&lt;&gt;(</span><span class="n">body</span><span class="o">,</span> <span class="n">status</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>该 <code>Controller</code> 匹配的 <code>url</code> 默认为 <code>/error</code> ，这样，当 <code>response.sendError(404)</code>，会重新请求 <code>/error</code> 地址时，就会请求到该 <code>Controller</code> 中。</p>
<p>如果请求头中的 <code>content-type</code> 是 <code>text/html</code> ，则会对应到 <code>errorHtml()</code> 方法，返回  <code>Whitelabel Error Page</code> 页面；<code>content-type</code> 是其他类型，调用 <code>error()</code> 方法，返回 json 数据。</p>
<p>至此，404 页面整个流程就走通了。</p>
<h4 id="404页面返回自定义格式的json">404页面返回自定义格式的json</h4>
<p>首先，需要让请求路径不存在的地址，找不到对应的处理器</p>
<p>网上搜索到了两种方式</p>
<p>第一种方式是配置 <code>spring.web.resources.add-mappings=false</code>，关闭静态资源映射。这种方式的缺点是项目配置了该参数后，本项目或依赖本项目的其他项目就不能使用静态资源映射了，示例：如果类路径下 <code>/resources</code> 目录存在  <code>resources.html</code>，无法访问该 html 了，并且访问 <code>http://localhost:8080/error</code> ，也会出现 404页面。</p>
<p>第二种方式是配置 <code>spring.mvc.static-path-pattern=/statics/**</code>，即使用 <code>/statics/**</code> 替换 默认的静态资源地址 <code>/**</code>，示例：如果类路径下 <code>/resources</code> 目录存在  <code>resources.html</code>，可以通过 <code>http://localhost:8080/static/resources.html</code>
访问。但是，访问 <code>http://localhost:8080/static/test.html</code> 还是会出现404页面的（静态资源目录里没有 <code>test.html</code> 文件），并且访问 <code>http://localhost:8080/error</code> ，也会出现 404页面。</p>
<p><code>org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration.EnableWebMvcConfiguration#addResourceHandlers</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">addResourceHandlers</span><span class="o">(</span><span class="n">ResourceHandlerRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">super</span><span class="o">.</span><span class="na">addResourceHandlers</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">resourceProperties</span><span class="o">.</span><span class="na">isAddMappings</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Default resource handling disabled&#34;</span><span class="o">);</span>
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="n">ServletContext</span> <span class="n">servletContext</span> <span class="o">=</span> <span class="n">getServletContext</span><span class="o">();</span>
	<span class="n">addResourceHandler</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="s">&#34;/webjars/**&#34;</span><span class="o">,</span> <span class="s">&#34;classpath:/META-INF/resources/webjars/&#34;</span><span class="o">);</span>
	<span class="n">addResourceHandler</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">mvcProperties</span><span class="o">.</span><span class="na">getStaticPathPattern</span><span class="o">(),</span> <span class="o">(</span><span class="n">registration</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
		<span class="n">registration</span><span class="o">.</span><span class="na">addResourceLocations</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resourceProperties</span><span class="o">.</span><span class="na">getStaticLocations</span><span class="o">());</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">servletContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">registration</span><span class="o">.</span><span class="na">addResourceLocations</span><span class="o">(</span><span class="k">new</span> <span class="n">ServletContextResource</span><span class="o">(</span><span class="n">servletContext</span><span class="o">,</span> <span class="n">SERVLET_LOCATION</span><span class="o">));</span>
		<span class="o">}</span>
	<span class="o">});</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="s">&#34;spring.web&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebProperties</span> <span class="o">{</span>
	
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Resources</span> <span class="o">{</span>

		<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">CLASSPATH_RESOURCE_LOCATIONS</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&#34;classpath:/META-INF/resources/&#34;</span><span class="o">,</span>
				<span class="s">&#34;classpath:/resources/&#34;</span><span class="o">,</span> <span class="s">&#34;classpath:/static/&#34;</span><span class="o">,</span> <span class="s">&#34;classpath:/public/&#34;</span> <span class="o">};</span>

		<span class="cm">/**
</span><span class="cm">		 * Whether to enable default resource handling.
</span><span class="cm">		 */</span>
		<span class="kd">private</span> <span class="kt">boolean</span> <span class="n">addMappings</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&#34;spring.mvc&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebMvcProperties</span> <span class="o">{</span>

	<span class="cm">/**
</span><span class="cm">	 * Path pattern used for static resources.
</span><span class="cm">	 */</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">staticPathPattern</span> <span class="o">=</span> <span class="s">&#34;/**&#34;</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上述两种方式的原因可以看以上代码</p>
<p>上面两种方式或多或少都有些缺点，比如第一个配置了之后就不能访问静态资源了，第二个配置了之后静态资源请求url会改变，并且不能彻底避免404的问题</p>
<p>下面介绍第三种方式，主要思路是通过子类的方式，覆盖重写404页面的逻辑，改成符合自己要求的输出</p>
<p>首先，自定义一个模仿 <code>org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration</code> 自定义一个配置类 <code>CustomErrorMvcConfig</code> ，覆盖 <code>BasicErrorController</code> 实例的生成方法，生成我们自定义的默认地址为 <code>/error</code> 的控制器。</p>
<p>注意，该配置类需要在 <code>ErrorMvcAutoConfiguration</code> 之前进行加载，同时将 <code>basicErrorController</code> 方法上的 <code>search</code> 属性改为 <code>search = SearchStrategy.ALL</code> ，才能在本项目作为其他项目的依赖导入后，其他项目也能生效（当然，本项目<code>/META-INF/spring.factories</code> 里需要添加自动配置类）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.msdemt.simple.unified_exception_handler_demo.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.ObjectProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.AutoConfigureBefore</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.condition.ConditionalOnClass</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.condition.SearchStrategy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.web.ServerProperties</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.web.servlet.WebMvcProperties</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.web.servlet.error.BasicErrorController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.web.servlet.error.ErrorViewResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.context.properties.EnableConfigurationProperties</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.web.servlet.error.ErrorAttributes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.web.servlet.error.ErrorController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.DispatcherServlet</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.Servlet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Collectors</span><span class="o">;</span>

<span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@ConditionalOnWebApplication</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="n">ConditionalOnWebApplication</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">SERVLET</span><span class="o">)</span>
<span class="nd">@ConditionalOnClass</span><span class="o">({</span><span class="n">Servlet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">DispatcherServlet</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="c1">// Load before the main WebMvcAutoConfiguration so that the error View is available
</span><span class="c1"></span><span class="nd">@AutoConfigureBefore</span><span class="o">({</span><span class="n">WebMvcAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">ErrorMvcAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="nd">@EnableConfigurationProperties</span><span class="o">({</span><span class="n">ServerProperties</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">WebMvcProperties</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomErrorMvcConfig</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ServerProperties</span> <span class="n">serverProperties</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">CustomErrorAttributes</span> <span class="n">customErrorAttributes</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nf">CustomErrorMvcConfig</span><span class="o">(</span><span class="n">ServerProperties</span> <span class="n">serverProperties</span><span class="o">,</span> <span class="n">CustomErrorAttributes</span> <span class="n">customErrorAttributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">serverProperties</span> <span class="o">=</span> <span class="n">serverProperties</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">customErrorAttributes</span> <span class="o">=</span> <span class="n">customErrorAttributes</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">ErrorController</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">search</span> <span class="o">=</span> <span class="n">SearchStrategy</span><span class="o">.</span><span class="na">ALL</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">BasicErrorController</span> <span class="nf">basicErrorController</span><span class="o">(</span><span class="n">ErrorAttributes</span> <span class="n">errorAttributes</span><span class="o">,</span>
                                                     <span class="n">ObjectProvider</span><span class="o">&lt;</span><span class="n">ErrorViewResolver</span><span class="o">&gt;</span> <span class="n">errorViewResolvers</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">CustomErrorController</span><span class="o">(</span><span class="n">customErrorAttributes</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">serverProperties</span><span class="o">.</span><span class="na">getError</span><span class="o">(),</span>
                <span class="n">errorViewResolvers</span><span class="o">.</span><span class="na">orderedStream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>自定义的错误控制器 <code>CustomErrorController</code> ，需要继承 <code>org.springframework.boot.autoconfigure.web.servlet.error.BasicErrorController</code>，并且覆盖 <code>errorHtml()</code>方法，这样如果使用 <code>text/html</code> 请求一个404页面，也会显示我们期望的 json</p>
<p><code>BasicErrorController</code> 类中的 <code>error()</code> 方法不能直接覆盖，因为它的父类 <code>org.springframework.boot.autoconfigure.web.servlet.error.AbstractErrorController</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractErrorController</span> <span class="kd">implements</span> <span class="n">ErrorController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ErrorAttributes</span> <span class="n">errorAttributes</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">AbstractErrorController</span><span class="o">(</span><span class="n">ErrorAttributes</span> <span class="n">errorAttributes</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ErrorViewResolver</span><span class="o">&gt;</span> <span class="n">errorViewResolvers</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">errorAttributes</span><span class="o">,</span> <span class="s">&#34;ErrorAttributes must not be null&#34;</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">errorAttributes</span> <span class="o">=</span> <span class="n">errorAttributes</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">errorViewResolvers</span> <span class="o">=</span> <span class="n">sortErrorViewResolvers</span><span class="o">(</span><span class="n">errorViewResolvers</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ErrorAttributes</code> 不能为空</p>
<p><code>BasicErrorController</code> 没有空参的构造方法，如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;${server.error.path:${error.path:/error}}&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BasicErrorController</span> <span class="kd">extends</span> <span class="n">AbstractErrorController</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="n">ErrorProperties</span> <span class="n">errorProperties</span><span class="o">;</span>

	<span class="cm">/**
</span><span class="cm">	 * Create a new {@link BasicErrorController} instance.
</span><span class="cm">	 * @param errorAttributes the error attributes
</span><span class="cm">	 * @param errorProperties configuration properties
</span><span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">BasicErrorController</span><span class="o">(</span><span class="n">ErrorAttributes</span> <span class="n">errorAttributes</span><span class="o">,</span> <span class="n">ErrorProperties</span> <span class="n">errorProperties</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">(</span><span class="n">errorAttributes</span><span class="o">,</span> <span class="n">errorProperties</span><span class="o">,</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="cm">/**
</span><span class="cm">	 * Create a new {@link BasicErrorController} instance.
</span><span class="cm">	 * @param errorAttributes the error attributes
</span><span class="cm">	 * @param errorProperties configuration properties
</span><span class="cm">	 * @param errorViewResolvers error view resolvers
</span><span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">BasicErrorController</span><span class="o">(</span><span class="n">ErrorAttributes</span> <span class="n">errorAttributes</span><span class="o">,</span> <span class="n">ErrorProperties</span> <span class="n">errorProperties</span><span class="o">,</span>
			<span class="n">List</span><span class="o">&lt;</span><span class="n">ErrorViewResolver</span><span class="o">&gt;</span> <span class="n">errorViewResolvers</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">errorAttributes</span><span class="o">,</span> <span class="n">errorViewResolvers</span><span class="o">);</span>
		<span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">errorProperties</span><span class="o">,</span> <span class="s">&#34;ErrorProperties must not be null&#34;</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">errorProperties</span> <span class="o">=</span> <span class="n">errorProperties</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>它的子类 <code>CustomErrorController</code> 必须显式调用父类构造方法，且 <code>errorAttributes</code> 不能为 <code>null</code> ，所以 CustomErrorMvcConfig 中新建 <code>CustomErrorController</code> 实例 时必须传入 <code>customErrorAttributes</code></p>
<p><code>CustomErrorAttributes</code> 类的内容如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.msdemt.simple.unified_exception_handler_demo.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.msdemt.simple.unified_exception_handler_demo.constant.enums.CommonResponseEnum</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.web.error.ErrorAttributeOptions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.web.servlet.error.DefaultErrorAttributes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.WebRequest</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomErrorAttributes</span> <span class="kd">extends</span> <span class="n">DefaultErrorAttributes</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">CustomErrorAttributes</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">getErrorAttributes</span><span class="o">(</span><span class="n">WebRequest</span> <span class="n">webRequest</span><span class="o">,</span> <span class="n">ErrorAttributeOptions</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">errorAttributes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>

        <span class="c1">//404错误 统一返回如下信息
</span><span class="c1"></span>        <span class="n">errorAttributes</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">,</span> <span class="n">CommonResponseEnum</span><span class="o">.</span><span class="na">NO_MATCHIING_BUSINESS_FOUND</span><span class="o">.</span><span class="na">getCode</span><span class="o">());</span>
        <span class="n">errorAttributes</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;mess&#34;</span><span class="o">,</span> <span class="n">CommonResponseEnum</span><span class="o">.</span><span class="na">NO_MATCHIING_BUSINESS_FOUND</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

        <span class="k">return</span> <span class="n">errorAttributes</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>配置 spring 当找不到请求路径的处理器时，将异常（<code>NoHandlerFoundException</code>）抛出</p>
<p><code>org.springframework.web.servlet.DispatcherServlet</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doDispatch</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

                <span class="o">...</span> <span class="o">...</span>

				<span class="c1">// Determine handler for the current request.
</span><span class="c1"></span>				<span class="n">mappedHandler</span> <span class="o">=</span> <span class="n">getHandler</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">mappedHandler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">noHandlerFound</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
					<span class="k">return</span><span class="o">;</span>
				<span class="o">}</span>

                <span class="o">...</span> <span class="o">...</span>
<span class="o">}</span>

<span class="cm">/**
</span><span class="cm"> * No handler found -&gt; set appropriate HTTP response status.
</span><span class="cm"> * @param request current HTTP request
</span><span class="cm"> * @param response current HTTP response
</span><span class="cm"> * @throws Exception if preparing the response failed
</span><span class="cm"> */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">noHandlerFound</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">pageNotFoundLogger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">pageNotFoundLogger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;No mapping for &#34;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; &#34;</span> <span class="o">+</span> <span class="n">getRequestUri</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">throwExceptionIfNoHandlerFound</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">NoHandlerFoundException</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(),</span> <span class="n">getRequestUri</span><span class="o">(</span><span class="n">request</span><span class="o">),</span>
				<span class="k">new</span> <span class="n">ServletServerHttpRequest</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">getHeaders</span><span class="o">());</span>
	<span class="o">}</span>
	<span class="k">else</span> <span class="o">{</span>
		<span class="n">response</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_NOT_FOUND</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>通过上面的配置，我们实现了若请求一个未定义的地址，找不到该地址对应的handler，能够进入 <code>mappedHandler == null</code> 的判断，但是此时还无法抛出 NoHandlerFoundException 异常。</p>
<p><code>org.springframework.boot.autoconfigure.web.servlet.WebMvcProperties#throwExceptionIfNoHandlerFound</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&#34;spring.mvc&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebMvcProperties</span> <span class="o">{</span>
	<span class="cm">/**
</span><span class="cm">	 * Whether a &#34;NoHandlerFoundException&#34; should be thrown if no Handler was found to
</span><span class="cm">	 * process a request.
</span><span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kt">boolean</span> <span class="n">throwExceptionIfNoHandlerFound</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>org.springframework.web.servlet.DispatcherServlet#noHandlerFound</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">noHandlerFound</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">pageNotFoundLogger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">pageNotFoundLogger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;No mapping for &#34;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; &#34;</span> <span class="o">+</span> <span class="n">getRequestUri</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">throwExceptionIfNoHandlerFound</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">NoHandlerFoundException</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(),</span> <span class="n">getRequestUri</span><span class="o">(</span><span class="n">request</span><span class="o">),</span>
				<span class="k">new</span> <span class="n">ServletServerHttpRequest</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">getHeaders</span><span class="o">());</span>
	<span class="o">}</span>
	<span class="k">else</span> <span class="o">{</span>
		<span class="n">response</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_NOT_FOUND</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如上，<code>throwExceptionIfNoHandlerFound</code> 的值默认时 <code>false</code> ，此时不会新建并抛出 <code>NoHandlerFoundException</code> 异常，需要将该值置为 <code>true</code> ，所以需要修改本项目的 <code>application.properties</code> ， 添加配置 <code>spring.mvc.throw-exception-if-no-handler-found=true</code></p>
<p>最后，为了上文定义的配置类，能够在本项目作为依赖时引入其他项目后生效，即自动加载放入spring容器中，需要在 /META-INF/spring.factories 文件中添加类引用。</p>
<p>如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  org.msdemt.simple.unified_exception_handler_demo.i18n.UnifiedMessageSource,\
  org.msdemt.simple.unified_exception_handler_demo.exception.handler.UnifiedExceptionHandler,\
  org.msdemt.simple.unified_exception_handler_demo.config.CustomErrorAttributes,\
  org.msdemt.simple.unified_exception_handler_demo.config.CustomErrorMvcConfig
</code></pre></td></tr></table>
</div>
</div><p>至此，springboot 统一异常处理就完成了。</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-02-01</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/java/%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/springboot%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://msdemt.github.io/posts/java/%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/springboot%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" data-title="Springboot统一异常处理"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://msdemt.github.io/posts/java/%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/springboot%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://msdemt.github.io/posts/java/%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/springboot%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" data-title="Springboot统一异常处理"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://msdemt.github.io/posts/java/%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/springboot%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" data-title="Springboot统一异常处理"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://msdemt.github.io/posts/java/%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/springboot%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" data-title="Springboot统一异常处理" data-ralateuid="xxxx"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/java/%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/edge%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84jsonview%E6%8F%92%E4%BB%B6%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BAjson/" class="prev" rel="prev" title="Edge浏览器的JSONView插件无法显示json"><i class="fas fa-angle-left fa-fw"></i>Edge浏览器的JSONView插件无法显示json</a>
            <a href="/posts/idea/idea%E9%85%8D%E7%BD%AE%E5%AD%97%E7%AC%A6%E9%9B%86%E7%BC%96%E7%A0%81/" class="next" rel="next" title="Idea配置字符集编码">Idea配置字符集编码<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.80.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">xxxx</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.zh-cn","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
